{% extends "base.html" %}

{% block title %}{% bilingual "Realtime Monitor" "实时监控台" %}{% endblock %}

{% block content %}
<div class="realtime-monitor-page">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
            <p class="text-uppercase text-muted small fw-semibold mb-1">{% bilingual "Realtime Engine" "实时引擎" %}</p>
            <h1 class="h3 mb-2">{% bilingual "Engine Monitor" "引擎监控" %}</h1>
            <p class="text-muted mb-0">{% bilingual "Snapshot of the latest universe, focus list, and bars." "查看最新 Universe、Focus 与分钟 K 线快照。" %}</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:realtime_settings' %}">{% bilingual "Settings" "配置档案" %}</a>
            <a class="btn btn-primary btn-sm" href="{% url 'trading:realtime_monitor' %}">{% bilingual "Refresh" "刷新" %}</a>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h5 mb-3">{% bilingual "Engine status" "引擎状态" %}</h2>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "State" "状态" %}</span>
                            {% if engine_online %}
                                <span class="badge bg-success-subtle text-success-emphasis">{% bilingual "Online" "在线" %}</span>
                            {% else %}
                                <span class="badge bg-danger-subtle text-danger-emphasis">{% bilingual "Offline" "离线" %}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Stream" "流连接" %}</span>
                            <span>{% if stream_status %}{{ stream_status }}{% else %}—{% endif %}</span>
                        </div>
                        {% if stream_detail %}
                            <div class="text-muted small">{{ stream_detail }}</div>
                        {% endif %}
                        {% if stream_updated %}
                            <div class="d-flex justify-content-between">
                                <span>{% bilingual "Stream update" "流更新时间" %}</span>
                                <span>{{ stream_updated|date:"Y-m-d H:i:s" }}</span>
                            </div>
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Active profile" "激活档案" %}</span>
                            <span>{{ active_profile.name|default:"—" }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Universe update" "Universe 更新时间" %}</span>
                            <span>{% if universe_updated %}{{ universe_updated|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Focus update" "Focus 更新时间" %}</span>
                            <span>{% if focus_updated %}{{ focus_updated|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Bars update" "Bars 更新时间" %}</span>
                            <span>{% if bars_updated %}{{ bars_updated|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Last tick" "最新 Tick" %}</span>
                            <span>{% if last_tick %}{{ last_tick|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>{% bilingual "Stale after" "超时阈值" %}</span>
                            <span>{{ stale_after }}s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">{% bilingual "Focus list" "Focus 列表" %}</h2>
                            <p class="text-muted small mb-0">{% bilingual "Symbols currently subscribed for realtime updates." "当前订阅的实时行情标的。" %}</p>
                        </div>
                        <span class="badge bg-light text-dark">{% bilingual "Total" "数量" %}: {{ focus_count }}</span>
                    </div>
                    {% if focus_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">{% bilingual "Symbol" "标的" %}</th>
                                        <th scope="col">{% bilingual "Since" "进入时间" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in focus_entries|slice:":40" %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td><code>{{ entry.symbol }}</code></td>
                                            <td>{% if entry.since %}{{ entry.since|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if focus_entries|length > 40 %}
                            <p class="text-muted small mb-0 mt-2">{% bilingual "Showing first 40 symbols." "仅显示前 40 个标的。" %}</p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">{% bilingual "No focus symbols found yet." "暂无 Focus 标的。" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">{% bilingual "Universe snapshot" "Universe 快照" %}</h2>
                            <p class="text-muted small mb-0">{% bilingual "Top ranked symbols by the universe scorer." "Universe 排名靠前的标的。" %}</p>
                        </div>
                        <span class="badge bg-light text-dark">{% bilingual "Count" "数量" %}: {{ universe_count }}</span>
                    </div>
                    {% if ranked_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">{% bilingual "Symbol" "标的" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Score" "评分" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Price" "价格" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in ranked_entries %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td><code>{{ entry.symbol }}</code></td>
                                            <td class="text-end">{{ entry.score|default_if_none:"—" }}</td>
                                            <td class="text-end">{{ entry.price|default_if_none:"—" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">{% bilingual "Universe ranking file not ready yet." "Universe 排名尚未生成。" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">{% bilingual "Latest bars" "最新 Bar" %}</h2>
                            <p class="text-muted small mb-0">{% bilingual "Most recent bar snapshot recorded by the engine." "引擎写入的最新 Bar 快照。" %}</p>
                        </div>
                    </div>
                    {% if bars_rows %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">{% bilingual "Symbol" "标的" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Open" "开盘" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "High" "最高" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Low" "最低" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Close" "收盘" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Volume" "成交量" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in bars_rows %}
                                        <tr>
                                            <td><code>{{ row.symbol|default:"—" }}</code></td>
                                            <td class="text-end">{{ row.open|default:"—" }}</td>
                                            <td class="text-end">{{ row.high|default:"—" }}</td>
                                            <td class="text-end">{{ row.low|default:"—" }}</td>
                                            <td class="text-end">{{ row.close|default:"—" }}</td>
                                            <td class="text-end">{{ row.volume|default:"—" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">{% bilingual "Bars file not ready yet." "Bars 文件尚未生成。" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">{% bilingual "Latest signals" "最新信号" %}</h2>
                            <p class="text-muted small mb-0">{% bilingual "Recent signal evaluations from the realtime engine." "实时引擎最近的信号评估。" %}</p>
                        </div>
                    </div>
                    {% if signals_rows %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">{% bilingual "Time" "时间" %}</th>
                                        <th scope="col">{% bilingual "Symbol" "标的" %}</th>
                                        <th scope="col">{% bilingual "Signal" "信号" %}</th>
                                        <th scope="col" class="text-end">{% bilingual "Score" "评分" %}</th>
                                        <th scope="col">{% bilingual "Reason" "备注" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in signals_rows|slice:":15" %}
                                        <tr>
                                            <td class="text-nowrap">{{ row.timestamp|default:"—" }}</td>
                                            <td><code>{{ row.symbol|default:"—" }}</code></td>
                                            <td>{{ row.signal|default:"—" }}</td>
                                            <td class="text-end">{{ row.score|floatformat:4 }}</td>
                                            <td>{{ row.skip_reason|default:"—" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">{% bilingual "No signals available yet." "暂无信号记录。" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
