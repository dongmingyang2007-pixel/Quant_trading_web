{% extends "base.html" %}
{% load django_bootstrap5 humanize i18n static html_filters %}

{% block title %}{% trans "Flagship Strategy Backtest" %}{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'trading/css/backtest_market_shell.css' %}?v={{ STATIC_VERSION|default:'20260209-market-shell-v1' }}">
<link rel="stylesheet" href="{% static 'trading/css/backtest_components.css' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v4' }}">
<link rel="stylesheet" href="{% static 'trading/css/backtest_unified.css' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v4' }}">
<link rel="stylesheet" href="{% static 'trading/css/backtest_terminal.css' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v4' }}">
<link rel="stylesheet" href="{% static 'trading/css/backtest_refine_clean.css' %}?v={{ STATIC_VERSION|default:'20260212-backtest-refine-v1' }}">
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="{% static 'trading/js/vendor/lightweight-charts.standalone.production.js' %}"></script>
<script src="{% static 'trading/js/history_delete.js' %}"></script>
<script src="{% static 'trading/js/history_meta.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="{% static 'trading/js/backtest_submit.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="{% static 'trading/js/backtest_overview_charts.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="{% static 'trading/js/robustness_lab.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="{% static 'trading/js/strategy_presets.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" defer></script>
<script src="{% static 'trading/js/portfolio_builder.js' %}?v={{ STATIC_VERSION|default:'1' }}" defer></script>
<script src="{% static 'trading/js/ui_toast.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/ui_error_boundary.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_state.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_api.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/workspace_trade.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/workspace_backtest.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/workspace_review.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_app.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_news_ribbon.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_interactive_chart.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
<script src="{% static 'trading/js/backtest_ai_suite.js' %}?v={{ STATIC_VERSION|default:'20260210-terminal-v6' }}" defer></script>
{% endblock %}

{% block content %}

<div class="backtest-page backtest-shell-frame">
    <header class="backtest-hero">
        <span class="backtest-kicker">Flagship Quant</span>
        <h1 class="backtest-title">{% bilingual "Flagship Strategy Backtest Hub" "旗舰策略回测中心" %}</h1>
        <p class="backtest-subtitle">
            {% bilingual "Select the ticker and time horizon, then launch the flagship ML + risk stack to receive a deep-dive report plus execution guidance." "输入标的与时间区间，即可一键调用机器学习 + 风控组合的旗舰流程，生成深度报告与执行建议。" %}
        </p>
        {% if result and result.metrics %}
            <ul class="hero-bullets hero-bullets--metrics">
                {% for metric in result.metrics|slice:":3" %}
                    <li><strong>{{ metric.label }}：</strong>{{ metric.value }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <ul class="hero-bullets">
                <li>{% bilingual "Automatically searches the optimal ML configuration and calibrates thresholds/probabilities." "自动搜索最佳机器学习参数并完成阈值优化与概率校准。" %}</li>
                <li>{% bilingual "Loads risk controls and multi-dimensional risk metrics by default." "默认加载风控参数与多维度风险指标。" %}</li>
                <li>{% bilingual "Download or revisit every report later in the account center." "回测完成后可在账户中心查看或导出报告。" %}</li>
            </ul>
        {% endif %}
    </header>
</div>

<section class="backtest-news-top backtest-shell-frame">
    {% include "trading/includes/backtest_news_ribbon.html" %}
</section>

<div class="workbench-switch backtest-shell-frame" data-workbench-role="workspace-switch">
    <button type="button" class="workbench-switch-btn is-active" data-workbench-role="workspace-btn" data-workspace="trade">
        {% bilingual "Short-term Realtime Trading" "短线实时交易" %}
    </button>
    <button type="button" class="workbench-switch-btn" data-workbench-role="workspace-btn" data-workspace="backtest">
        {% bilingual "Classic Backtest" "经典回测" %}
    </button>
    <button type="button" class="workbench-switch-btn" data-workbench-role="workspace-btn" data-workspace="review">
        {% bilingual "Execution Review" "执行复盘" %}
    </button>
</div>

<section class="shortterm-workbench workbench-panel backtest-shell-frame" data-workbench-role="trade-panel" hidden>
    {% include "trading/includes/backtest_workspace_trade.html" %}
</section>

<section class="workbench-panel backtest-shell-frame" data-workbench-role="backtest-panel" hidden>
{% include "trading/includes/backtest_workspace_backtest.html" %}
{% if result and result.stats %}
<div class="backtest-shell mb-4">
    <div class="quick-glance">
        <div class="quick-card">
            <div class="quick-card-title">{% bilingual "Execution & Label Assumptions" "执行与标签口径" %}</div>
            <ul class="quick-card-list">
                <li>{% bilingual "Return path" "执行口径" %}：{{ result.stats.return_path|default:"N/A" }}</li>
                <li>{% bilingual "Label path" "标签口径" %}：{{ result.stats.label_return_path|default:"N/A" }}</li>
                {% if result.stats.execution_assumptions.description %}
                <li>{{ result.stats.execution_assumptions.description }}</li>
                {% endif %}
            </ul>
        </div>
        <div class="quick-card">
            <div class="quick-card-title">PFWS / OOS</div>
            <ul class="quick-card-list">
                <li>{% bilingual "PFWS policy" "PFWS 策略" %}：{{ result.stats.pfws_policy.status|default:"unknown" }}</li>
                <li>{% bilingual "Train / Test" "训练 / 测试窗口" %}：{{ result.stats.pfws_train_window|default:"-" }} / {{ result.stats.pfws_test_window|default:"-" }}</li>
                <li>{% bilingual "Embargo" "隔离期" %}：{{ result.stats.pfws_embargo|default:"-" }}</li>
                <li class="text-muted small">{{ result.stats.pfws_policy.note|default:"" }}</li>
            </ul>
        </div>
        <div class="quick-card">
            <div class="quick-card-title">{% bilingual "OOS Stability" "样本外稳定性" %}</div>
            <ul class="quick-card-list">
                <li>Penalized Sharpe：{{ result.stats.validation_penalized_sharpe|default:"N/A" }}</li>
                <li>{% bilingual "Sharpe mean ± std" "Sharpe 均值 ± 标准差" %}：{{ result.stats.validation_sharpe_mean|default:"-" }} ± {{ result.stats.validation_sharpe_std|default:"-" }}</li>
                <li>{% bilingual "OOS folds" "样本外折数" %}：{{ result.stats.validation_oos_folds|default:"-" }}</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

<div class="backtest-shell">
    <div id="backtest-loading-panel" class="backtest-loading-panel" aria-hidden="true" hidden>
        <div class="quick-glance quick-glance--loading">
            {% for _ in "123"|make_list %}
            <div class="quick-card quick-card--skeleton">
                <div class="skeleton-line skeleton-line--title"></div>
                <ul class="quick-card-list">
                    <li><span class="skeleton-line skeleton-line--text"></span></li>
                    <li><span class="skeleton-line skeleton-line--text"></span></li>
                    <li><span class="skeleton-line skeleton-line--text"></span></li>
                </ul>
            </div>
            {% endfor %}
        </div>
        <div class="backtest-skeleton-stack">
            <span class="skeleton-line skeleton-line--title"></span>
            <span class="skeleton-line skeleton-line--text"></span>
            <div class="skeleton-block skeleton-block--card"></div>
            <div class="skeleton-block skeleton-block--card"></div>
        </div>
    </div>
    <div class="backtest-workspace">


        <div class="backtest-main">
            <div class="backtest-hero-wrapper">
                <section class="backtest-card backtest-intro-card">
                    <div class="hero-text">
                        <span class="hero-eyebrow">Quant Studio</span>
                        <h1 class="hero-title">{% bilingual "Quantitative Strategy Backtest" "量化投资回测" %}</h1>
                        <p class="hero-subtitle">{% bilingual "A single canvas for data, models, and risk controls—delivering an execution-ready playbook." "汇聚数据、模型与风控，生成可立即执行的投资线路图。" %}</p>
                        <div class="hero-chips">
                            <span class="hero-chip">
                                {% bilingual "Primary ticker:" "主要标的：" %}
                                {% if result.ticker %}
                                    {{ result.ticker }}
                                {% else %}
                                    {% bilingual "Pending" "等待输入" %}
                                {% endif %}
                            </span>
                            <span class="hero-chip">
                                {% bilingual "Risk profile:" "风险偏好：" %}
                                {% if result.risk_profile %}
                                    {{ result.risk_profile }}
                                {% else %}
                                    {% bilingual "Not set" "未指定" %}
                                {% endif %}
                            </span>
                            <span class="hero-chip">
                                {% bilingual "Engine:" "策略引擎：" %}
                                {% if result.engine_label %}
                                    {{ result.engine_label }}
                                {% else %}
                                    {% bilingual "Select a strategy" "选择策略" %}
                                {% endif %}
                            </span>
                            {% if result and result.capital %}
                                <span class="hero-chip">{% bilingual "Capital base:" "资金规模：" %} {{ result.capital|floatformat:0|intcomma }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="hero-actions-wrapper">
                        <p class="hero-update">
                            {% if result.quick_summary.0 %}
                                {{ result.quick_summary.0 }}
                            {% else %}
                                {% bilingual "Complete the form to generate a bespoke backtest with risk-return guidance and pacing cues." "填写参数后即可生成带有风险-收益指引与节奏建议的专属回测。" %}
                            {% endif %}
                        </p>
                        <div class="hero-actions">
                            <a class="hero-button solid" href="#analysis-form" data-panel-target="config">{% bilingual "Configure Strategy" "开始配置" %}</a>
                        </div>
                    </div>
                </section>
            </div>

{% if not result %}
            <section class="backtest-card backtest-form-card">
                {% include "trading/includes/analysis_form.html" %}
            </section>
{% endif %}

{% if result %}
            <div class="quick-glance" id="quick-glance">
                <div class="quick-card">
                    <div class="quick-card-title">{% bilingual "Core Metrics" "核心指标" %}</div>
                    <ul class="quick-card-list">
                        {% for metric in result.metrics|slice:":3" %}
                            <li><strong>{{ metric.label }}：</strong>{{ metric.value }}</li>
                        {% empty %}
                            <li class="text-muted">{% bilingual "Metrics will populate once the run completes." "等待生成核心指标。" %}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% with summary_card=result.executive_briefing|first %}
                    {% if summary_card %}
                        <div class="quick-card">
                            <div class="quick-card-title">{{ summary_card.title }}</div>
                            <p class="text-muted mb-2">{{ summary_card.body }}</p>
                            {% if summary_card.status %}<p class="mb-0"><strong>{% bilingual "Consensus:" "共识：" %}</strong>{{ summary_card.status }}</p>{% endif %}
                        </div>
                    {% endif %}
                {% endwith %}
                {% if result.scenario_simulation and result.scenario_simulation.available %}
                    <div class="quick-card">
                        <div class="quick-card-title">{% bilingual "Scenario Glimpse" "情景速览" %}</div>
                        <ul class="quick-card-list">
                            {% for item in result.scenario_simulation.scenarios|slice:":2" %}
                                <li>{{ item.label }}：{{ item.return }}</li>
                            {% endfor %}
                        </ul>
                        {% if result.scenario_simulation.expected_return %}
                            <p class="text-muted mb-0">{% bilingual "Avg" "均值" %} {{ result.scenario_simulation.expected_return }} · {% bilingual "Vol" "波动" %} {{ result.scenario_simulation.volatility }}</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
{% else %}
            <div class="quick-glance quick-glance--loading" aria-hidden="true">
                {% for _ in "123"|make_list %}
                <div class="quick-card quick-card--skeleton">
                    <div class="skeleton-line skeleton-line--title"></div>
                    <ul class="quick-card-list">
                        <li><span class="skeleton-line skeleton-line--text"></span></li>
                        <li><span class="skeleton-line skeleton-line--text"></span></li>
                        <li><span class="skeleton-line skeleton-line--text"></span></li>
                    </ul>
                </div>
                {% endfor %}
            </div>
{% endif %}
{% if result %}
            <section class="backtest-card backtest-report">
                <aside class="backtest-report-nav" aria-label="{% trans 'Analysis navigation' %}">
                    <button type="button" class="backtest-tab active" data-panel="overview">{% bilingual "Executive Overview" "核心概览" %}</button>
                    <button type="button" class="backtest-tab" data-panel="config">{% bilingual "Input Settings" "配置参数" %}</button>
                    <button type="button" class="backtest-tab" data-panel="advisor">{% bilingual "Advisor Plan" "金融顾问方案" %}</button>
                    <button type="button" class="backtest-tab" data-panel="charts">{% bilingual "Charts" "图表分析" %}</button>
                    <button type="button" class="backtest-tab" data-panel="signals">{% bilingual "Signal History" "历史分析" %}</button>
                    <button type="button" class="backtest-tab" data-panel="history">{% bilingual "Backtest Records" "历史回测" %}</button>
                    <button type="button" class="backtest-tab" data-panel="expert">{% bilingual "Professional Data" "专业数据" %}</button>
                    <button type="button" class="backtest-tab" data-panel="ai">{% bilingual "AI Insights" "AI 研判" %}</button>
                </aside>

                <div class="backtest-panels">
                    <div class="backtest-panel active" data-panel="overview" id="overview-pane">
                <div class="summary-header">
                    <div>
                        <h2 class="summary-title">{% blocktrans with ticker=result.ticker %}Performance Overview · {{ ticker }}{% endblocktrans %}</h2>
                        <div class="summary-tags">
                            {% if result.risk_profile %}
                                <span class="hero-chip">{% trans "Risk profile:" %} {{ result.risk_profile }}</span>
                            {% endif %}
                            {% if result.capital %}
                                <span class="hero-chip">{% trans "Capital:" %} {{ result.capital|floatformat:0|intcomma }}</span>
                            {% endif %}
                            {% if result.engine_label %}
                                <span class="hero-chip">{% trans "Engine:" %} {{ result.engine_label }}</span>
                            {% endif %}
                            {% if result.confidence_label or result.confidence_score %}
                                <span class="hero-chip">
                                    {% bilingual "Confidence" "置信度" %}：
                                    {% if result.confidence_label %}{{ result.confidence_label }}{% endif %}
                                    {% if result.confidence_score %} ({{ result.confidence_score|floatformat:2 }}){% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <span class="summary-period">{% blocktrans with start=result.start_date end=result.end_date %}Window: {{ start }} → {{ end }}{% endblocktrans %}</span>
                </div>

                {% if result_warnings %}
                    <div class="alert alert-warning">
                        {% for warn in result_warnings %}<div>{{ warn }}</div>{% endfor %}
                    </div>
                {% endif %}

                {% if result.metrics %}
                    <div class="core-metric-grid">
                        {% for metric in result.metrics|slice:":3" %}
                            <article class="core-metric-card">
                                <div class="core-metric-name">{{ metric.label }}</div>
                                <p class="core-metric-value">{{ metric.value }}</p>
                                {% if metric.explain %}<div class="core-metric-footnote">{{ metric.explain }}</div>{% endif %}
                            </article>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if result.executive_briefing %}
                    <section class="briefing-deck">
                        <div class="briefing-grid">
                            {% for card in result.executive_briefing %}
                                <article class="briefing-card">
                                    <div class="briefing-head">
                                        <h3 class="briefing-title">{{ card.title }}</h3>
                                        {% if card.status %}<span class="briefing-status">{{ card.status }}</span>{% endif %}
                                    </div>
                                    <p class="briefing-body">{{ card.body }}</p>
                                    {% if card.cta_href %}
                                        <a class="briefing-link" href="{{ card.cta_href }}" rel="noopener">{{ card.cta_label|default:"查看详情" }}</a>
                                    {% endif %}
                                </article>
                            {% endfor %}
                        </div>
                    </section>
                {% endif %}

                {% if result.user_questions %}
                    <div class="report-card">
                        <h3 class="panel-title">关键问题解答</h3>
                        <ul class="panel-list">
                            {% for qa in result.user_questions %}
                                <li><strong>{{ qa.question }} </strong>{{ qa.answer }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.advisor_playbook and result.advisor_playbook.available %}
                    <div class="report-card playbook-summary">
                        <h3 class="panel-title">AI 投顾摘要</h3>
                        <div class="playbook-grid compact">
                            {% for section in result.advisor_playbook.sections %}
                                <div class="playbook-section">
                                    <div class="playbook-head">
                                        <span class="playbook-title">{{ section.title }}</span>
                                        {% if section.tag %}<span class="playbook-tag">{{ section.tag }}</span>{% endif %}
                                    </div>
                                    <ul class="playbook-points">
                                        {% for point in section.points|slice:":3" %}
                                            <li>{{ point }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {% if result.quick_summary %}
                    <div class="report-card accent">
                        <h3 class="panel-title">一眼看懂 · 核心亮点</h3>
                        <ul class="panel-list">
                            {% for item in result.quick_summary|slice:":4" %}<li>{{ item }}</li>{% endfor %}
                        </ul>
                    </div>
                {% endif %}
                {% if result.stats %}
                    <div class="report-card reliability-card" id="reliability-card">
                        <div class="reliability-head">
                            <div>
                                <h3 class="panel-title">{% bilingual "Reliability Cockpit" "可信度驾驶舱" %}</h3>
                                <p class="text-muted small mb-0">{% bilingual "Score derived from data, model, and execution diagnostics." "基于数据、模型与执行诊断的综合评分。" %}</p>
                            </div>
                            <div class="reliability-score-box">
                                <div class="reliability-score">{{ result.stats.reliability.score|default:"-" }}</div>
                                {% if result.stats.reliability.label %}
                                    {% if result.stats.reliability.label == "Excellent" %}
                                        <span class="status-badge good">Excellent</span>
                                    {% elif result.stats.reliability.label == "Good" %}
                                        <span class="status-badge neutral">Good</span>
                                    {% elif result.stats.reliability.label == "Caution" %}
                                        <span class="status-badge weak">Caution</span>
                                    {% else %}
                                        <span class="status-badge weak">High risk</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge neutral">{% bilingual "Pending" "待评估" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="reliability-subgrid">
                            <div class="reliability-subscore">
                                <span>{% bilingual "Data score" "数据评分" %}</span>
                                <strong>{{ result.stats.reliability.subscores.data|default:"-" }}</strong>
                            </div>
                            <div class="reliability-subscore">
                                <span>{% bilingual "Model score" "模型评分" %}</span>
                                <strong>{{ result.stats.reliability.subscores.model|default:"-" }}</strong>
                            </div>
                            <div class="reliability-subscore">
                                <span>{% bilingual "Execution score" "执行评分" %}</span>
                                <strong>{{ result.stats.reliability.subscores.execution|default:"-" }}</strong>
                            </div>
                        </div>
                        <div class="reliability-metric-grid">
                            <div class="reliability-metric" title="{% bilingual 'AUC measures directional prediction accuracy.' 'AUC 衡量方向预测准确度。' %}">
                                <span>AUC</span>
                                <strong>{{ result.stats.auc|floatformat:3|default:"-" }}</strong>
                            </div>
                            <div class="reliability-metric" title="{% bilingual 'Brier score reflects probability calibration (lower is better).' 'Brier 反映概率校准（越低越好）。' %}">
                                <span>Brier</span>
                                <strong>{{ result.stats.calibration.brier|floatformat:4|default:"-" }}</strong>
                            </div>
                            <div class="reliability-metric" title="{% bilingual 'PSI flags distribution drift between periods.' 'PSI 衡量分布漂移。' %}">
                                <span>PSI</span>
                                <strong>
                                    {% if result.stats.drift %}
                                        {{ result.stats.drift.psi_returns|floatformat:2|default:"-" }} /
                                        {{ result.stats.drift.psi_probabilities|floatformat:2|default:"-" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="reliability-metric" title="{% bilingual 'CPCV p10/worst Sharpe across folds.' 'CPCV 10% 分位 / 最差 Sharpe。' %}">
                                <span>CPCV p10/worst</span>
                                <strong>
                                    {{ result.stats.cpcv.p10_sharpe|floatformat:2|default:"-" }} /
                                    {{ result.stats.cpcv.worst_sharpe|floatformat:2|default:"-" }}
                                </strong>
                            </div>
                            <div class="reliability-metric" title="{% bilingual 'Sharpe confidence interval from bootstrap.' 'Sharpe 置信区间（bootstrap）。' %}">
                                <span>Sharpe CI</span>
                                <strong>
                                    {% if result.stats.sharpe_ci_lower or result.stats.sharpe_ci_upper %}
                                        {{ result.stats.sharpe_ci_lower|floatformat:2|default:"-" }} ~ {{ result.stats.sharpe_ci_upper|floatformat:2|default:"-" }}
                                    {% elif result.stats.sharpe_ci %}
                                        {{ result.stats.sharpe_ci }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="reliability-metric" title="{% bilingual 'White reality check p-value (lower suggests overfitting risk).' 'White 现实检验 p 值（偏低提示过拟合风险）。' %}">
                                <span>p-value</span>
                                <strong>
                                    {% if result.stats.sharpe_pvalue_adjusted %}
                                        {{ result.stats.sharpe_pvalue_adjusted|floatformat:3 }}
                                    {% elif result.stats.sharpe_pvalue %}
                                        {{ result.stats.sharpe_pvalue|floatformat:3 }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                        {% if result.stats.reliability.reasons %}
                            <p class="text-muted small mb-1">{% bilingual "Key risks" "关键风险" %}</p>
                            <ul class="panel-list">
                                {% for reason in result.stats.reliability.reasons %}
                                    <li>{{ reason }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        {% if result.stats.reliability.actions %}
                            <div class="reliability-actions">
                                {% for action in result.stats.reliability.actions %}
                                    <a class="hero-button ghost xsmall" href="{{ action.href }}">{{ action.label }}</a>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if not result.stats.reliability %}
                            <p class="text-muted small mb-0">{% bilingual "Historical run missing reliability data." "历史记录尚无可信度评分。" %}</p>
                        {% endif %}
                    </div>

                    <div class="report-card" id="overview-signal-card">
                        <h3 class="panel-title">{% bilingual "Signal Timeline" "信号时间线" %}</h3>
                        <p class="text-muted small mb-2">{% bilingual "Probability, thresholds, and position with key execution events." "展示概率、阈值与仓位，并标注关键执行事件。" %}</p>
                        {% with overview_series=result.overview_series return_series=result.return_series %}
                        {% if overview_series and overview_series.series or return_series %}
                            <div id="overview-signal-chart" class="overview-signal-chart"></div>
                            {% if overview_series %}
                                <div class="overview-legend">
                                    <span class="legend-item"><span class="legend-dot" style="background:#2563eb;"></span>{% bilingual "Probability" "概率" %}</span>
                                    <span class="legend-item"><span class="legend-dot" style="background:#0f766e;"></span>{% bilingual "Position" "仓位" %}</span>
                                    <span class="legend-item"><span class="legend-dot" style="background:#f59e0b;"></span>{% bilingual "Execution events" "执行事件" %}</span>
                                </div>
                            {% else %}
                                <p class="text-muted small mb-0">{% bilingual "Fallback to equity curve (no signal series)." "暂无信号序列，显示净值曲线。" %}</p>
                            {% endif %}
                            {% if overview_series %}
                                {{ overview_series|json_script:"overview-series-data" }}
                            {% endif %}
                            {% if return_series %}
                                {{ return_series|json_script:"overview-return-series-data" }}
                            {% endif %}
                        {% else %}
                            <p class="text-muted mb-0">{% bilingual "No signal series available yet." "暂无可用信号序列。" %}</p>
                        {% endif %}
                        {% endwith %}
                    </div>
                    <div class="report-card" id="robustness-lab">
                        <div class="robustness-toolbar">
                            <div>
                                <h3 class="panel-title">{% bilingual "Robustness Lab" "稳健性实验室" %}</h3>
                                <p class="text-muted small mb-0">{% bilingual "Run a compact grid to compare cost, liquidity, and thresholds." "对成本、流动性与阈值做小网格测试，评估稳健区间。" %}</p>
                            </div>
                            <button type="button" class="hero-button solid small" id="robustness-run">
                                {% bilingual "Run robustness" "运行稳健性测试" %}
                            </button>
                        </div>
                        <div class="robustness-metric-toggle mt-3" id="robustness-metric-toggle">
                            <button type="button" data-metric="sharpe" class="active">Sharpe</button>
                            <button type="button" data-metric="max_drawdown">{% bilingual "Max DD" "最大回撤" %}</button>
                            <button type="button" data-metric="avg_coverage">{% bilingual "Coverage" "成交覆盖" %}</button>
                        </div>
                        <p class="text-muted small mt-2 mb-2" id="robustness-status">
                            {% bilingual "Ready to evaluate robustness." "准备就绪，可进行稳健性评估。" %}
                        </p>
                        <div id="robustness-heatmaps"></div>
                        <div class="robustness-recommend" id="robustness-recommend" hidden></div>
                    </div>
                    <div class="report-card">
                        <h3 class="panel-title">{% bilingual "Execution & Costs" "成交与成本诊断" %}</h3>
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <p class="text-muted small mb-2">{% bilingual "Fill coverage" "成交覆盖" %}</p>
                                <ul class="panel-list muted">
                                    <li class="meta-row">
                                        <span>{% bilingual "Avg coverage" "平均覆盖率" %}：</span>
                                        <span>{{ result.stats.execution_stats.avg_coverage|percent:1|default:"-" }}</span>
                                        {% with coverage=result.stats.execution_stats.avg_coverage %}
                                            {% if coverage %}
                                                {% if coverage >= 0.9 %}
                                                    <span class="status-badge good">{% bilingual "Strong" "良好" %}</span>
                                                {% elif coverage >= 0.75 %}
                                                    <span class="status-badge neutral">{% bilingual "Fair" "一般" %}</span>
                                                {% else %}
                                                    <span class="status-badge weak">{% bilingual "Weak" "偏弱" %}</span>
                                                {% endif %}
                                            {% endif %}
                                        {% endwith %}
                                    </li>
                                    <li>{% bilingual "Unfilled ratio" "未成交比例" %}：{{ result.stats.execution_stats.unfilled_ratio|percent:1|default:"-" }}</li>
                                    <li>{% bilingual "Avg spread (bps)" "平均点差 (bps)" %}：{{ result.stats.execution_stats.avg_spread_bps|floatformat:2|default:"-" }}</li>
                                    <li>{% bilingual "Halt days" "停牌天数" %}：{{ result.stats.execution_stats.halt_days|default:"0" }}</li>
                                    <li>{% bilingual "Limit days" "涨跌停天数" %}：{{ result.stats.execution_stats.limit_days|default:"0" }}</li>
                                    <li>{% bilingual "ADV cap hits" "ADV 上限触发次数" %}：{{ result.stats.execution_stats.adv_hard_cap_hits|default:"0" }}</li>
                                </ul>
                                <div class="mt-3">
                                    <p class="text-muted small mb-2">{% bilingual "Execution assumptions" "执行假设" %}</p>
                                    <ul class="panel-list muted small">
                                        <li title="return_path / label_return_path">
                                            {% bilingual "Path" "口径" %}：{{ result.stats.execution_assumptions.return_path|default:"-" }} / {{ result.stats.execution_assumptions.label_return_path|default:"-" }}
                                        </li>
                                        <li title="adv_participation / effective_participation">
                                            {% bilingual "Participation" "参与率" %}：
                                            {{ result.stats.execution_stats.effective_participation|percent:1|default:"-" }}
                                        </li>
                                        <li title="cost_rate / borrow_bps / execution_mode">
                                            {% bilingual "Cost settings" "成本假设" %}：
                                            {{ result.stats.cost_assumptions.cost_rate|percent:2|default:"-" }} ·
                                            {{ result.stats.cost_assumptions.long_borrow_bps|default:"-" }}/{{ result.stats.cost_assumptions.short_borrow_bps|default:"-" }} bps ·
                                            {{ result.stats.cost_assumptions.execution_mode|default:"-" }}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <p class="text-muted small mb-2">{% bilingual "Cost breakdown" "成本拆解" %}</p>
                                <ul class="panel-list muted">
                                    <li>{% bilingual "Transaction cost" "交易成本" %}：{{ result.stats.transaction_cost_total|floatformat:4|default:"0" }}</li>
                                    <li>{% bilingual "Execution cost" "执行成本" %}：{{ result.stats.execution_cost_total|floatformat:4|default:"0" }}</li>
                                    <li>{% bilingual "Borrow cost" "借券成本" %}：{{ result.stats.borrow_cost_total|floatformat:4|default:"0" }}</li>
                                    <li>{% bilingual "Total cost" "总成本" %}：{{ result.stats.total_cost|floatformat:4|default:"0" }}</li>
                                    <li>{% bilingual "Cost ratio" "成本占比" %}：{{ result.stats.cost_ratio|floatformat:2|default:"-" }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="report-card" id="data-quality-card">
                        <h3 class="panel-title">{% bilingual "Data Quality & Bias" "数据质量与偏差" %}</h3>
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <p class="text-muted small mb-2">{% bilingual "Data signature" "数据签名" %}</p>
                                <ul class="panel-list muted">
                                    <li>{% bilingual "Source" "来源" %}：{{ result.metadata.data_signature.source|default:"-" }}</li>
                                    <li>{% bilingual "Rows" "行数" %}：{{ result.metadata.data_signature.rows|default:"0" }}</li>
                                    <li>{% bilingual "Data range" "数据区间" %}：{{ result.metadata.data_signature.start|default:"-" }} → {{ result.metadata.data_signature.end|default:"-" }}</li>
                                    <li class="meta-row">
                                        <span>{% bilingual "Hash" "哈希" %}：</span>
                                        <span class="meta-value" title="{{ result.metadata.data_signature.hash|default:"-" }}">{{ result.metadata.data_signature.hash|default:"-" }}</span>
                                        {% if result.metadata.data_signature.hash %}
                                            <button type="button" class="meta-copy" data-copy-value="{{ result.metadata.data_signature.hash }}" aria-label="{% bilingual "Copy hash" "复制哈希" %}">{% bilingual "Copy" "复制" %}</button>
                                        {% endif %}
                                    </li>
                                    <li class="meta-row">
                                        <span>{% bilingual "Cache path" "缓存路径" %}：</span>
                                        <span class="meta-value" title="{{ result.metadata.data_signature.cache_path|default:"-" }}">{{ result.metadata.data_signature.cache_path|default:"-" }}</span>
                                        {% if result.metadata.data_signature.cache_path %}
                                            <button type="button" class="meta-copy" data-copy-value="{{ result.metadata.data_signature.cache_path }}" aria-label="{% bilingual "Copy path" "复制路径" %}">{% bilingual "Copy" "复制" %}</button>
                                        {% endif %}
                                    </li>
                                    <li>{% bilingual "Requested window" "请求区间" %}：{{ result.metadata.requested_start|default:"-" }} → {{ result.metadata.requested_end|default:"-" }}</li>
                                    <li>{% bilingual "Effective window" "实际区间" %}：{{ result.metadata.effective_start|default:"-" }} → {{ result.metadata.effective_end|default:"-" }}</li>
                                </ul>
                                {% if result.metadata.data_signature.source == "csv_cache" %}
                                    <div class="alert alert-warning small mb-0">
                                        {% bilingual "Using local CSV cache because online data was unavailable." "当前使用本地 CSV 缓存，线上行情暂不可用。" %}
                                        {% if result.metadata.data_fetch_note %}
                                            <div class="text-muted small mt-1">{{ result.metadata.data_fetch_note }}</div>
                                        {% endif %}
                                    </div>
                                {% elif not result.metadata.data_signature.source %}
                                    <div class="alert alert-warning small mb-0">
                                        {% bilingual "Online data source not detected. Please verify the data fetch." "未检测到线上数据来源，请检查行情获取是否正常。" %}
                                        {% if result.metadata.data_fetch_note %}
                                            <div class="text-muted small mt-1">{{ result.metadata.data_fetch_note }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-lg-6">
                                <p class="text-muted small mb-2">{% bilingual "Quality checks" "质量检查" %}</p>
                                <ul class="panel-list muted">
                                    <li>{% bilingual "Missing ratio" "缺失比例" %}：{{ result.stats.data_quality.missing_ratio|percent:1|default:"-" }}</li>
                                    <li>{% bilingual "Zero volume days" "零成交量天数" %}：{{ result.stats.data_quality.zero_volume_days|default:"0" }}</li>
                                    <li>{% bilingual "Stale price days" "价格无变动天数" %}：{{ result.stats.data_quality.stale_price_days|default:"0" }}</li>
                                </ul>
                                {% if result.stats.data_risks %}
                                    <p class="text-muted small mb-1">{% bilingual "Bias alerts" "偏差提示" %}</p>
                                    <ul class="panel-list">
                                        {% for risk in result.stats.data_risks %}<li>{{ risk }}</li>{% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if result.scenario_simulation and result.scenario_simulation.available %}
                    <section class="scenario-board" id="scenario-board">
                        <div class="scenario-head">
                            <h3 class="panel-title">未来 {{ result.scenario_simulation.horizon_days }} 日情景模拟</h3>
                            <span class="hero-chip ghost">波动率 {{ result.scenario_simulation.volatility }} · 最大回撤 {{ result.scenario_simulation.max_drawdown }}</span>
                            {% if result.scenario_simulation.expected_return %}
                                <span class="hero-chip ghost">均值 {{ result.scenario_simulation.expected_return }}</span>
                            {% endif %}
                        </div>
                        <div class="scenario-grid">
                            {% for item in result.scenario_simulation.scenarios %}
                                <div class="scenario-card">
                                    <h4>{{ item.label }}</h4>
                                    <p class="scenario-return">{{ item.return }}</p>
                                    <p class="text-muted small mb-2">{{ item.description }}</p>
                                    <p class="text-muted small mb-0">{{ item.allocation_hint }}</p>
                                </div>
                            {% endfor %}
                        </div>
                        {% if result.scenario_simulation.insight %}
                            <p class="text-muted small mb-2">{{ result.scenario_simulation.insight }}</p>
                        {% endif %}
                        <p class="text-muted small mb-0">{{ result.scenario_simulation.notes }}</p>
                    </section>
                {% endif %}

                {% if result.rl_playbook and result.rl_playbook.available %}
                    <section class="rl-playbook" id="rl-playbook">
                        <div class="rl-head">
                            <h3 class="panel-title mb-0">强化学习战术盘</h3>
                            {% if result.rl_playbook.edge %}
                                <span class="hero-chip ghost">代理期望日边际 {{ result.rl_playbook.edge }}</span>
                            {% endif %}
                        </div>
                        <div class="rl-grid">
                            {% for policy in result.rl_playbook.policies %}
                                <article class="rl-card">
                                    <span class="rl-state">{{ policy.state }}</span>
                                    <span class="rl-action">{{ policy.action }}</span>
                                    <p class="text-muted small mb-1">{{ policy.rationale }}</p>
                                    <span class="rl-edge">{{ policy.edge }}</span>
                                </article>
                            {% endfor %}
                        </div>
                        {% if result.rl_playbook.insight %}
                            <p class="text-muted small mb-0 mt-3">{{ result.rl_playbook.insight }}</p>
                        {% endif %}
                    </section>
                {% endif %}

                {% if result.opportunity_radar and result.opportunity_radar.available %}
                    <section class="opportunity-radar" id="opportunity-radar">
                        <div class="opportunity-head">
                            <h3 class="panel-title">机会雷达</h3>
                            <p class="text-muted mb-0">{{ result.opportunity_radar.summary }}</p>
                        </div>
                        <div class="opportunity-grid">
                            <div>
                                <h4>涨幅领先</h4>
                                <ul class="panel-list muted">
                                    {% for row in result.opportunity_radar.leaders %}
                                        <li><strong>{{ row.ticker }}</strong> · {{ row.name }} → {{ row.change_pct|floatformat:2 }}%</li>
                                    {% empty %}
                                        <li class="text-muted">暂无数据</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div>
                                <h4>健康回调</h4>
                                <ul class="panel-list muted">
                                    {% for row in result.opportunity_radar.laggards %}
                                        <li><strong>{{ row.ticker }}</strong> · {{ row.name }} → {{ row.change_pct|floatformat:2 }}%</li>
                                    {% empty %}
                                        <li class="text-muted">暂无数据</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div>
                                <h4>稳健观察</h4>
                                <ul class="panel-list muted">
                                    {% for row in result.opportunity_radar.steady %}
                                        <li><strong>{{ row.ticker }}</strong> · {{ row.name }} → {{ row.change_pct|floatformat:2 }}%</li>
                                    {% empty %}
                                        <li class="text-muted">暂无数据</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% if result.opportunity_radar.insight %}
                            <p class="text-muted small mt-3">{{ result.opportunity_radar.insight }}</p>
                        {% endif %}
                    </section>
                {% endif %}

                {% if result.action_plan %}
                    <div class="report-card">
                        <h3 class="panel-title">执行清单（面向 {{ result.experience_label }}）</h3>
                        <div class="panel-list-group">
                            {% for step in result.action_plan %}
                                <div class="panel-step">
                                    <div class="panel-step-head">
                                        <span class="panel-step-title">{{ step.title }}</span>
                                        <span class="panel-step-tag">{{ step.priority }}优先</span>
                                    </div>
                                    <p class="text-muted mb-0">{{ step.detail }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {% if result.risk_alerts %}
                    <div class="report-card warn">
                        <h3 class="panel-title">风险提醒</h3>
                        <ul class="panel-list">
                            {% for alert in result.risk_alerts %}<li>{{ alert }}</li>{% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.hyperopt_report %}
                    <div class="report-card accent hyperopt-card">
                        <h3 class="panel-title">自动调参结果</h3>
                        <p class="text-muted mb-1">
                            模型：{{ result.hyperopt_report.engine|upper }} · trials {{ result.hyperopt_report.trials_ran }} · score {{ result.hyperopt_report.best_score|floatformat:2 }}
                        </p>
                        <p class="text-muted mb-2">
                            最佳阈值：入场 {{ result.hyperopt_report.entry_threshold|floatformat:2 }} / 出场 {{ result.hyperopt_report.exit_threshold|floatformat:2 }}
                        </p>
                        {% if result.hyperopt_report.ml_params %}
                            <ul class="panel-list">
                                {% for key, value in result.hyperopt_report.ml_params|dictsort:"key"|slice:":4" %}
                                    <li>{{ key }} → {{ value }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        {% if result.hyperopt_report.fold_metrics %}
                            <p class="text-muted small mb-0">验证集表现：Sharpe {{ result.hyperopt_report.fold_metrics.sharpe|floatformat:2 }} · 命中率 {{ result.hyperopt_report.fold_metrics.hit_ratio|floatformat:2 }}</p>
                        {% endif %}
                    </div>
                {% endif %}

                                {% if result.education_tips %}
                    <div class="report-card subtle">
                        <h3 class="panel-title">补充知识</h3>
                        <ul class="panel-list">
                            {% for tip in result.education_tips %}<li>{{ tip }}</li>{% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <div class="report-card subtle notice-pro">
                    <h3 class="panel-title">想看更详细的数据？</h3>
                    <p class="text-muted mb-2">专业投资人可切换到“专业数据”面板，查看完整回测指标、风险报表与模型细节。</p>
                    <button type="button" class="hero-button ghost xsmall js-open-expert">打开专业数据</button>
                </div>
            </div>

            <div class="backtest-panel" data-panel="config" id="config-pane">
                {% include "trading/includes/analysis_form.html" %}
            </div>
            <div class="backtest-panel" data-panel="advisor" id="advisor-pane">
                            <div class="report-card subtle mb-3">
                                <h3 class="panel-title">多模型顾问说明</h3>
                                <p class="text-muted mb-1">
                                    顾问方案结合机器学习主策略、深度信号与因子权重，输出可执行的配置建议。模型权重和风险雷达结果已同步纳入方案。
                                </p>
                                {% if result.model_weights and result.model_weights.available %}
                                    <p class="text-muted mb-0">
                                        当前权重推荐：{% for item in result.model_weights.allocations|slice:":3" %}{{ item.name }} {{ item.weight|floatformat:2 }}{% if not forloop.last %} · {% endif %}{% endfor %}。
                                    </p>
                                {% endif %}
                            </div>
                            {% if result.advisor_playbook and result.advisor_playbook.available %}
                                <section class="advisor-playbook">
                                    <div class="advisor-playbook-head">
                                        <h3 class="panel-title mb-1">一页投资剧本</h3>
                                        <p class="text-muted mb-0">将盈利预期、执行步骤、风险防守与市场机会串联成可执行流程。</p>
                                    </div>
                                    <div class="playbook-grid">
                                        {% for section in result.advisor_playbook.sections %}
                                            <article class="playbook-section">
                                                <div class="playbook-head">
                                                    <span class="playbook-title">{{ section.title }}</span>
                                                    {% if section.tag %}<span class="playbook-tag">{{ section.tag }}</span>{% endif %}
                                                </div>
                                                <ul class="playbook-points">
                                                    {% for point in section.points %}
                                                        <li>{{ point }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </article>
                                        {% endfor %}
                                    </div>
                                </section>
                            {% endif %}
                            {% if result.recommendations %}
                                <div class="advisor-grid">
                                    {% for plan in result.recommendations %}
                                        <div class="advisor-card">
                                            <div class="advisor-head">
                                                <span class="advisor-title">{{ plan.title }}</span>
                                                <span class="advisor-subtitle">{{ plan.subtitle }}</span>
                                            </div>
                                            <ul class="panel-list">
                                                {% for item in plan.allocation %}<li>{{ item }}</li>{% endfor %}
                                            </ul>
                                            {% if plan.projection %}<p class="text-muted small mb-2">{{ plan.projection }}</p>{% endif %}
                                            {% if plan.success_probability %}
                                                <p class="text-muted small mb-2">正收益概率估计：{{ plan.success_probability|floatformat:1 }}%</p>
                                            {% endif %}
                                            <p class="text-muted small mb-3">{{ plan.actions }}</p>
                                            {% if plan.breakdown %}
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-borderless align-middle caption-top mb-3">
                                                        <caption class="small text-muted">资金分配建议</caption>
                                                        <thead class="small text-muted">
                                                            <tr>
                                                                <th scope="col">资产/策略</th>
                                                                <th scope="col" class="text-end">占比</th>
                                                                <th scope="col" class="text-end">金额</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="small">
                                                            {% for row in plan.breakdown %}
                                                                <tr>
                                                                    <td>{{ row.label }}</td>
                                                                    <td class="text-end">{{ row.percent }}</td>
                                                                    <td class="text-end">{{ row.amount }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% endif %}
                                            {% if plan.timeline %}
                                                <div class="timeline-list">
                                                    {% for phase in plan.timeline %}
                                                        <div class="timeline-step">
                                                            <strong>{{ phase.phase }}</strong>
                                                            <p class="mb-1 text-muted">基准情形：{{ phase.base }}</p>
                                                            <p class="mb-1 text-muted">最佳情形：{{ phase.best }}</p>
                                                            <p class="mb-0 text-muted">最差情形：{{ phase.worst }}</p>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted mb-0">尚未生成顾问方案，请先运行回测。</p>
                            {% endif %}
                        </div>

                        <div class="backtest-panel" data-panel="charts" id="charts-pane">
                            <p class="text-muted mb-3">
                                图表依据 PDF 中的多周期统计与情景分析框架绘制，包括累计收益、风险对比及未来情景预测，可与“知识图谱”“宏观脉搏”折叠卡配合查看。
                            </p>
                            {% with has_interactive=result.interactive_chart has_static=result.charts %}
                                {% if has_interactive or has_static %}
                                    {% if has_interactive %}
                                    <section class="interactive-chart-card">
                                        <header class="chart-head">
                                            <div>
                                                <h3>{% bilingual "Interactive price + signals" "交互式价格 / 信号图" %}</h3>
                                                <p class="text-muted mb-0">{% bilingual "Scroll to zoom, drag to pan, click signal markers for trade details." "支持缩放、拖拽，并可点击信号标记查看盈亏明细。" %}</p>
                                            </div>
                                            <div class="chart-legend" id="chart-legend"></div>
                                        </header>
                                        <div id="interactive-chart" class="interactive-chart-canvas"></div>
                                        <footer class="chart-footer">
                                            <div>
                                                <strong>{% bilingual "Signal detail" "信号详情" %}</strong>
                                                <p class="text-muted small mb-1">{% bilingual "Click a Buy (B) / Sell (S) marker to view this trade's P&L." "点击买入 (B) / 卖出 (S) 图标查看该交易盈亏。" %}</p>
                                                <div class="chart-trade-info" id="chart-trade-info"></div>
                                            </div>
                                        </footer>
                                    </section>
                                    {{ result.interactive_chart|json_script:"interactive-chart-data" }}
                                    {% endif %}
                                    {% if has_static %}
                                    <div class="chart-grid">
                                        {% for chart in result.charts %}
                                        <figure class="chart-card">
                                            <img src="data:image/png;base64,{{ chart.img }}" alt="{{ chart.title }}" class="chart-img">
                                            <figcaption class="chart-caption">{{ chart.title }}</figcaption>
                                        </figure>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <p class="text-muted mb-0">图表模块已关闭，可在参数区勾选“生成图表”。</p>
                                {% endif %}
                            {% endwith %}
                        </div>

                        <div class="backtest-panel" data-panel="signals" id="signals-pane">
                            <p class="text-muted mb-3">
                                历史明细表结合了特征信号、概率与持仓变动，可对照“因子有效性”折叠卡验证信号质量。如需快速查看，可使用下方按钮折叠表格。
                            </p>
                            <button class="hero-button ghost small mb-3" id="toggle-signals">隐藏历史明细</button>
                            <div class="table-responsive" id="signals-table">
                                <table class="table table-sm align-middle signals-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">日期</th>
                                            <th scope="col">信号</th>
                                            <th scope="col">持仓</th>
                                            <th scope="col">收盘价</th>
                                            <th scope="col">短均线</th>
                                            <th scope="col">长均线</th>
                                            <th scope="col">RSI</th>
                                            <th scope="col">模型概率</th>
                                            <th scope="col">日收益率</th>
                                            <th scope="col">单日成本</th>
                                            <th scope="col">杠杆</th>
                                            <th scope="col">策略净值</th>
                                            <th scope="col">买入持有净值</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in result.recent_rows %}
                                        <tr data-trade-time="{{ row.date }}">
                                            <td>{{ row.date }}</td>
                                            <td>{{ row.signal }}</td>
                                            <td>{{ row.position }}</td>
                                            <td>{{ row.adj_close }}</td>
                                            <td>{{ row.sma_short }}</td>
                                            <td>{{ row.sma_long }}</td>
                                            <td>{{ row.rsi }}</td>
                                            <td>{% if row.probability is not None %}{{ row.probability|floatformat:3 }}{% else %}—{% endif %}</td>
                                            <td>{{ row.daily_return }}</td>
                                            <td>{% if row.transaction_cost is not None %}{{ row.transaction_cost|floatformat:5 }}{% else %}—{% endif %}</td>
                                            <td>{{ row.leverage }}</td>
                                            <td>{{ row.cum_strategy }}</td>
                                            <td>{{ row.cum_buy_hold }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

            {% with delete_template=history_delete_template|default:'' %}
            {% if not delete_template %}
            {% url 'trading:delete_history' record_id='placeholder' as delete_template %}
            {% endif %}
            {% with load_base=history_load_url|default:request.path %}
                        <div class="backtest-panel" data-panel="history" id="history-pane">
                            {% include "trading/includes/history_panel.html" with history_runs=history_runs history_message=history_message history_error=history_error accordion_id="history-accordion" empty_id="history-empty" delete_url_template=delete_template load_url=load_base compare_url=history_compare_url %}
                        </div>
            {% endwith %}
            {% endwith %}

            {% if history_briefs %}
            <section class="portfolio-builder-card tilt-card" data-portfolio-builder data-endpoint="{% url 'trading:build_portfolio' %}" v-cloak>
                <header class="portfolio-builder-head">
                    <div>
                        <p class="builder-kicker">{% bilingual "Portfolio Builder" "投资组合构建器" %}</p>
                        <h2>{% bilingual "Blend strategies into one view" "前端拼配策略组合" %}</h2>
                        <p class="text-muted mb-0">{% bilingual "Select historical runs, assign weights, and instantly see the combined equity curve plus risk stats."
                            "选择历史策略并设定权重，即时查看组合净值与风险指标。" %}</p>
                    </div>
                    <div class="builder-cash-group">
                        <label class="form-label">{% bilingual "Cash weight (%)" "现金权重（%）" %}</label>
                        <input type="number" class="form-control form-control-sm" min="0" max="100" step="1" v-model.number="cashWeight">
                    </div>
                </header>
                <div class="portfolio-builder-body">
                    <div class="builder-rows">
                        <div class="builder-row" v-for="(row, index) in rows" :key="row.id">
                            <select class="form-select form-select-sm" v-model="row.recordId">
                                <option value="" disabled>[[ selectLabel ]]</option>
                                <option v-for="option in options" :key="option.record_id" :value="option.record_id">
                                    [[ option.label ]]
                                </option>
                            </select>
                            <input type="number" class="form-control form-control-sm" min="0" max="100" step="1" v-model.number="row.weight">
                            <button type="button" @click="removeRow(index)">×</button>
                        </div>
                    </div>
                    <div class="builder-actions">
                        <button type="button" class="hero-button ghost xsmall" @click="addRow">[[ addLabel ]]</button>
                        <button type="button" class="hero-button solid small" :disabled="!canSubmit || loading" @click="submitPortfolio">
                            [[ loading ? loadingLabel : computeLabel ]]
                        </button>
                    </div>
                    <p class="builder-hint" :class="{'text-danger': messageState === 'error'}">
                        [[ message ]]
                    </p>
                </div>
                <div class="portfolio-results" v-if="results">
                    <div class="builder-metrics">
                        <div class="builder-metric" v-for="item in metricRows" :key="item.key">
                            <span>[[ item.label ]]</span>
                            <strong>[[ item.value ]]</strong>
                        </div>
                    </div>
                    <div class="builder-weights" v-if="weightsList.length">
                        <span class="builder-weight-pill" v-for="entry in weightsList" :key="entry.label">
                            [[ entry.label ]]: [[ entry.value ]]%
                        </span>
                    </div>
                    <div class="portfolio-chart" ref="chart" aria-label="{% bilingual 'Portfolio equity chart' '组合净值曲线' %}"></div>
                    <div class="builder-correlation" v-if="correlations.length">
                        <ul>
                            <li v-for="item in correlations" :key="item.label">
                                [[ item.label ]]: [[ item.value ]]%
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
            {{ history_briefs|json_script:"portfolio-history-options" }}
            {% endif %}

            <div class="backtest-panel" data-panel="expert" id="expert-pane">
                {% include "trading/includes/backtest_expert_panel.html" %}
            </div>


                        <div class="backtest-panel" data-panel="ai" id="ai-panel">
                            <div class="ai-suite">
                                <div class="ai-suite-card">
                                    <header class="ai-suite-top">
                                        <div class="ai-suite-title">
                                            <span class="ai-suite-badge">AI 研判</span>
                                            <h3>智能投研中枢</h3>
                                            <p>AI 基于最新回测数据给出要点解读，支持快速追问或输入自定义问题。</p>
                                        </div>
                                    </header>

                                    <section class="ai-chat-surface">
                                        <div id="ai-status" class="ai-status-chip ai-status-info">AI 正在准备分析，请稍候…</div>
                                        <div id="ai-meta" class="ai-meta"></div>
                                        <div id="ai-messages" class="ai-chat-log"></div>
                                        <div id="ai-thinking" class="accordion ai-thinking-panel d-none"></div>
                                    </section>

                                    <section class="ai-actions">
                                        <form id="ai-chat-form" class="ai-action-block ai-form">
                                            <div class="ai-form-toolbar">
                                                <h4 class="ai-form-title">自定义问题</h4>
                                                <div class="ai-toolbar-controls">
                                                    <label for="ai-model-input" class="ai-model-label">模型</label>
                                                    <select id="ai-model-input" class="ai-model-input select">
                                                        <option value="" disabled selected>请选择模型</option>
                                                    </select>
                                                <button type="button" class="hero-button ghost xsmall" id="ai-toggle-web" aria-pressed="false" title="开启/关闭：联网搜索">🌐 联网：关</button>
                                                <button type="button" class="hero-button ghost xsmall" id="ai-clear-history" title="清空本页 AI 对话记录">🗑 清空记录</button>
                                                <button type="button" class="hero-button ghost xsmall" id="ai-abort" title="中断当前生成">⏹ 中断</button>
                                                <button type="button" class="hero-button ghost xsmall" id="ai-continue" title="续写/追加生成">↻ 续写</button>
                                            </div>
                                            <p class="ai-toggle-hint">默认关闭联网，若需要实时资讯可手动开启上方按钮。</p>
                                        </div>
                                        <textarea id="ai-input" class="form-control" rows="3" placeholder="写下你的问题，例如：我现在应当怎么分批建仓？" required></textarea>
                                        <div class="ai-form-actions">
                                                <button type="submit" class="hero-button solid small">发送问题</button>
                                            </div>
                                        </form>
                                    </section>
                                </div>
                            </div>
            </div>

            
        </div>
    </section>
{% endif %}

</section>

<section class="workbench-panel backtest-shell-frame" data-workbench-role="review-panel" hidden>
    {% include "trading/includes/backtest_workspace_review.html" %}
</section>




<script id="backtest-ai-bootstrap" type="application/json">
{
  "report_context_json": "{% if result %}{{ result_json|escapejs }}{% else %}{}{% endif %}",
  "ai_fetch_timeout_ms": {{ ai_fetch_timeout_ms|default:120000 }},
  "task_endpoint": "{% url 'trading:api_v1_backtest_tasks' %}",
  "task_status_template": "{% url 'trading:api_v1_task_status' task_id='TASK_ID_PLACEHOLDER' %}",
  "history_load_base": "{{ history_load_url|default:''|escapejs }}",
  "backtest_path": "{% url 'trading:backtest' %}",
  "ai_endpoint": "{% url 'trading:ai_chat' %}",
  "ai_stream_endpoint": "{% url 'trading:ai_chat_stream' %}"
}
</script>
{% endblock %}
