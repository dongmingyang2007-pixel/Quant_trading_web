{% extends "base.html" %}
{% load static %}

{% block title %}{% bilingual "Account Center" "账户中心" %}{% endblock %}

{% block content %}
<div class="account-page container-xl">
    <header class="account-hero-mobile" style="--account-hero-color: {{ profile.cover_color|default:'#60a5fa' }}">
        <div class="hero-top">
            <div class="hero-avatar">
                {% if profile_media.avatar %}
                    <img src="{{ profile_media.avatar }}" alt="{{ user_info.display_name|default:user_info.username }}" loading="lazy">
                {% else %}
                    <span>{{ user_info.display_name|default:user_info.username|first|upper }}</span>
                {% endif %}
            </div>
            <div class="hero-meta">
                <p class="hero-greeting">{% bilingual "Hello," "欢迎回来，" %}</p>
                <h1 class="hero-name">{{ user_info.display_name|default:user_info.username }}</h1>
                <p class="hero-subtext">
                    {% bilingual "Member since" "加入于" %} {{ user_info.date_joined|date:"Y年n月j日" }}
                </p>
            </div>
            <a class="hero-settings" href="#account-tab-settings" data-tab-link="settings" title="{% bilingual 'Edit profile' '设置形象' %}">⚙️</a>
        </div>
        <div class="hero-stats">
            {% for stat in account_stats %}
                <div class="hero-stat">
                    <div class="hero-stat-value">{{ stat.value }}</div>
                    <div class="hero-stat-label">{{ stat.label }}</div>
                </div>
            {% endfor %}
        </div>
    </header>

    <nav class="account-tab-nav" data-role="account-tab-nav" data-default-tab="overview" role="tablist">
        <button type="button" class="account-tab-btn is-active" id="account-tab-btn-overview" data-tab-target="overview" aria-controls="account-tab-overview" aria-selected="true" role="tab">
            <span class="tab-title">{% bilingual "Overview" "总览" %}</span>
            <span class="tab-desc">{% bilingual "Shortcuts & highlights" "快捷入口与概览" %}</span>
        </button>
        <button type="button" class="account-tab-btn" id="account-tab-btn-activity" data-tab-target="activity" aria-controls="account-tab-activity" aria-selected="false" role="tab">
            <span class="tab-title">{% bilingual "Activity" "动态" %}</span>
            <span class="tab-desc">{% bilingual "Community posts & engagement" "社区互动与动态" %}</span>
        </button>
        <button type="button" class="account-tab-btn" id="account-tab-btn-history" data-tab-target="history" aria-controls="account-tab-history" aria-selected="false" role="tab">
            <span class="tab-title">{% bilingual "History" "历史记录" %}</span>
            <span class="tab-desc">{% bilingual "Backtests & exports" "回测记录与导出" %}</span>
        </button>
        <button type="button" class="account-tab-btn" id="account-tab-btn-settings" data-tab-target="settings" aria-controls="account-tab-settings" aria-selected="false" role="tab">
            <span class="tab-title">{% bilingual "Settings" "设置" %}</span>
            <span class="tab-desc">{% bilingual "Profile & security" "个人资料与安全" %}</span>
        </button>
    </nav>

    <div class="account-tab-panels">
        <section class="account-tab-panel is-active" data-tab-panel="overview" id="account-tab-overview" role="tabpanel" aria-labelledby="account-tab-btn-overview">
            <section class="account-card account-quick-panel">
                <div class="account-card-head compact">
                    <h2>{% bilingual "Shortcuts" "常用功能" %}</h2>
                    <p class="text-muted small mb-0">{% bilingual "Jump into frequently used tools." "快速进入常用功能" %}</p>
                </div>
                <div class="account-quick-grid">
                    {% for action in quick_actions %}
                        <a class="quick-tile {{ action.color }}" href="{{ action.url }}">
                            <span class="quick-icon">{{ action.icon }}</span>
                            <span class="quick-title">{{ action.label }}</span>
                            <span class="quick-desc">{{ action.desc }}</span>
                        </a>
                    {% endfor %}
                </div>
            </section>
            <div class="account-grid account-grid-overview">
                <section class="account-card account-overview account-grid-span-2">
                    <div class="account-card-head">
                        <h2>{% bilingual "Account overview" "账户概览" %}</h2>
                        <span class="badge {% if user_info.email != '未绑定' %}bg-success-subtle text-success-emphasis{% else %}bg-warning-subtle text-warning-emphasis{% endif %}">
                            {% if user_info.email != "未绑定" %}{% bilingual "Email verified" "邮箱已绑定" %}{% else %}{% bilingual "Email pending" "邮箱待绑定" %}{% endif %}
                        </span>
                    </div>
                    <div class="overview-highlights">
                        <div class="overview-chip">
                            <span class="chip-label">{% bilingual "Username" "用户名" %}</span>
                            <span class="chip-value">{{ user_info.username }}</span>
                        </div>
                        <div class="overview-chip">
                            <span class="chip-label">{% bilingual "Display name" "展示昵称" %}</span>
                            <span class="chip-value">{{ user_info.display_name|default:user_info.username }}</span>
                        </div>
                        <div class="overview-chip">
                            <span class="chip-label">{% bilingual "Backtests" "历史回测" %}</span>
                            <span class="chip-value">{{ history_runs|length }}</span>
                        </div>
                    </div>
                    <div class="overview-bio-block">
                        <h3>{% bilingual "Bio" "个人简介" %}</h3>
                        <p>
                            {% if profile.bio %}
                                {{ profile.bio|linebreaksbr }}
                            {% else %}
                                <span class="text-muted">{% bilingual "No bio yet. Update your profile to add one." "暂无简介，欢迎在资料设置中补充。" %}</span>
                            {% endif %}
                        </p>
                    </div>
                </section>

                <section class="account-card account-media">
                    <div class="account-card-head">
                        <h2>{% bilingual "Media library" "媒体库" %}</h2>
                        <p class="text-muted mb-0">{% bilingual "Featured photos appear on your public profile." "展示照片会应用于个人主页，可随时维护。" %}</p>
                    </div>
                    {% if profile_media.feature %}
                    <figure class="account-feature">
                        <img src="{{ profile_media.feature }}" alt="{% bilingual 'Featured photo' '展示照片' %}" loading="lazy">
                        <figcaption class="text-muted small mt-2">{% bilingual "Pinned on profile" "主页置顶展示" %}</figcaption>
                        <form method="post" class="account-media-remove">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="remove-feature">
                            <button type="submit" class="btn btn-outline-danger btn-sm">{% bilingual "Remove featured photo" "移除展示照片" %}</button>
                        </form>
                    </figure>
                    {% endif %}
                    {% if profile_media.gallery %}
                        <div class="account-gallery">
                            {% for image in profile_media.gallery %}
                            <div class="account-gallery-item">
                                <img src="{{ image.url }}" alt="{% bilingual 'Gallery photo' '展示照片' %} {{ forloop.counter }}" loading="lazy">
                                <form method="post" class="account-media-remove">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="remove-gallery">
                                    <input type="hidden" name="image" value="{{ image.path }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">{% bilingual "Delete" "删除" %}</button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small mb-0">{% bilingual "No gallery photos yet. Upload them in profile settings." "暂无额外展示照片，可在资料设置中上传。" %}</p>
                    {% endif %}
                </section>
            </div>
        </section>

        <section class="account-tab-panel" data-tab-panel="activity" id="account-tab-activity" role="tabpanel" aria-labelledby="account-tab-btn-activity">
            <section class="account-card account-timeline">
                <div class="account-card-head">
                    <h2>{% bilingual "Activity" "我的动态" %}</h2>
                    <p class="text-muted mb-0">{% bilingual "Latest posts, comments, and likes at a glance." "最近发布、评论与点赞一览。" %}</p>
                </div>
                <div class="timeline-filters" data-role="timeline-filters" role="tablist">
                    <button type="button" class="timeline-filter-btn is-active" data-timeline-filter="all">
                        {% bilingual "All" "全部" %}
                    </button>
                    <button type="button" class="timeline-filter-btn" data-timeline-filter="post">
                        {% bilingual "Posts" "帖子" %}
                    </button>
                    <button type="button" class="timeline-filter-btn" data-timeline-filter="comment">
                        {% bilingual "Comments" "评论" %}
                    </button>
                    <button type="button" class="timeline-filter-btn" data-timeline-filter="like">
                        {% bilingual "Likes" "点赞" %}
                    </button>
                </div>
                {% if activity_entries %}
                    <ul class="account-timeline-list">
                        {% for entry in activity_entries %}
                        <li class="timeline-item" data-timeline-item="{{ entry.kind }}">
                            <div class="timeline-marker" aria-hidden="true">{{ entry.kind|slice:":1"|upper }}</div>
                            <div class="timeline-content">
                                <div class="timeline-meta">
                                    <span class="timeline-time">{{ entry.display_time }}</span>
                                    {% if entry.topic %}
                                    <span class="timeline-topic">#{{ entry.topic }}</span>
                                    {% endif %}
                                </div>
                                <div class="timeline-title">{{ entry.title }}</div>
                                {% with body=entry.content %}
                                    {% if not body %}
                                        {% with body=entry.excerpt %}
                                            {% if body %}
                                                <p class="timeline-body">{{ body|truncatechars:220|linebreaksbr }}</p>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <p class="timeline-body">{{ body|truncatechars:220|linebreaksbr }}</p>
                                    {% endif %}
                                {% endwith %}
                                {% if entry.image %}
                                    <figure class="timeline-media">
                                        <img src="{{ entry.image }}" alt="{% bilingual 'Timeline media' '动态配图' %}" loading="lazy">
                                    </figure>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="timeline-empty">
                        <p class="mb-1">{% bilingual "No activity yet" "暂无动态" %}</p>
                        <p class="text-muted mb-0">{% bilingual "Share a post or leave a like in the community to get started." "快去社区发布首条帖子或点赞互动，让这里充实起来。" %}</p>
                    </div>
                {% endif %}
            </section>
        </section>

        <section class="account-tab-panel" data-tab-panel="history" id="account-tab-history" role="tabpanel" aria-labelledby="account-tab-btn-history">
            <section class="account-card account-history">
                <div class="account-card-head">
                    <h2>{% bilingual "Backtest history" "历史回测记录" %}</h2>
                    <p class="text-muted mb-0">{% bilingual "Click a record to reload its parameters and outputs." "点击任一回测即可重新加载策略参数与结果。" %}</p>
                </div>
                <div class="account-history-toolbar">
                    <a class="btn btn-primary btn-sm" href="{% url 'trading:backtest' %}">
                        {% bilingual "Start new backtest" "开启新回测" %}
                    </a>
                    {% if history_runs %}
                        <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:export_report' %}">
                            {% bilingual "Export latest" "导出最近" %}
                        </a>
                    {% else %}
                        <span class="btn btn-outline-secondary btn-sm disabled" aria-disabled="true">
                            {% bilingual "Export latest" "导出最近" %}
                        </span>
                    {% endif %}
                </div>
                {% include "trading/includes/history_panel.html" with history_runs=history_runs history_message=None history_error=None prefix="account-history-" accordion_id="account-history-accordion" empty_id="account-history-empty" delete_url_template=history_delete_template load_url=history_load_url %}
            </section>
        </section>

        <section class="account-tab-panel" data-tab-panel="settings" id="account-tab-settings" role="tabpanel" aria-labelledby="account-tab-btn-settings">
            <div class="account-settings-grid">
                <section class="account-card profile-preview-card">
                    <div class="account-card-head">
                        <h2>{% bilingual "Profile preview" "公开形象预览" %}</h2>
                        <span class="badge bg-info-subtle text-info-emphasis">{% bilingual "Public view" "公开视图" %}</span>
                    </div>
                    <div class="profile-preview-body">
                        <div class="profile-preview-avatar">
                            {% if profile_media.avatar %}
                                <img src="{{ profile_media.avatar }}" alt="{{ user_info.display_name|default:user_info.username }}" loading="lazy">
                            {% else %}
                                <span>{{ user_info.display_name|default:user_info.username|first|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="profile-preview-meta">
                            <p class="preview-name">{{ user_info.display_name|default:user_info.username }}</p>
                            <p class="text-muted mb-1">@{{ user_info.username }}</p>
                            <p class="preview-bio">
                                {% if profile.bio %}
                                    {{ profile.bio|truncatechars:120 }}
                                {% else %}
                                    {% bilingual "Add a short bio to build trust with collaborators." "添加简介可提升合作伙伴对你的了解。" %}
                                {% endif %}
                            </p>
                            <ul class="preview-highlights">
                    <li>{% bilingual "Backtests" "回测次数" %}: {{ history_runs|length }}</li>
                    <li>{% bilingual "Joined" "加入时间" %}: {{ user_info.date_joined|date:"Y-m-d" }}</li>
                            </ul>
                        </div>
                    </div>
                    {% if profile_media.feature %}
                        <figure class="profile-preview-image">
                            <img src="{{ profile_media.feature }}" alt="{% bilingual 'Featured banner' '展示横幅' %}" loading="lazy">
                        </figure>
                    {% endif %}
                </section>

                <section class="account-card account-security">
                    <div class="account-card-head">
                        <h2>{% bilingual "Security center" "安全中心" %}</h2>
                    </div>
                    {% if password_success %}
                        <div class="alert alert-success mt-2">{{ password_success }}</div>
                    {% endif %}
                    {% if password_error %}
                        <div class="alert alert-danger mt-2">{{ password_error }}</div>
                    {% endif %}
                    <form method="post" class="account-secure-form" action="{% url 'trading:account' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="password-reset">
                        <button type="submit" class="btn btn-dark w-100">{% bilingual "Send password reset email" "发送重设密码邮件" %}</button>
                    </form>
                    <div class="account-security-hints">
                        <p class="hint-title">{% bilingual "Security tips" "安全建议" %}</p>
                        <ul>
                            <li>{% bilingual "Update passwords regularly and keep MFA enabled." "定期更新密码，并启用邮箱多重验证。" %}</li>
                            <li>{% bilingual "Store exported reports securely to protect strategies." "下载回测报告后，妥善保管敏感策略信息。" %}</li>
                        </ul>
                    </div>
                </section>

                {% if is_superuser %}
                <section class="account-card">
                    <div class="account-card-head">
                        <h2>{% bilingual "Admin tools" "高级工具" %}</h2>
                        <span class="badge bg-warning text-dark">{% bilingual "Superuser only" "仅超级用户" %}</span>
                    </div>
                    <p class="text-muted mb-3">{% bilingual "Access internal observability dashboards for telemetry and diagnostics." "进入内部可观测性面板以查看遥测与诊断信息。" %}</p>
                    <a class="btn btn-outline-dark" href="{% url 'trading:observability' %}">{% bilingual "Open observability" "打开可观测性" %}</a>
                </section>
                {% endif %}
            </div>

            <section class="account-card account-settings" id="settings-pane" data-role="settings-card" data-settings-open="{% if profile_success or profile_error or profile_form.errors %}1{% else %}0{% endif %}">
                <div class="account-card-head">
                    <h2>{% bilingual "Profile settings" "资料设置" %}</h2>
                    <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                data-role="toggle-settings"
                                data-label-open="{% bilingual 'Collapse' '收起' %}"
                                data-label-closed="{% bilingual 'Edit profile' '编辑资料' %}">
                            {% if profile_success or profile_error or profile_form.errors %}{% bilingual "Collapse" "收起" %}{% else %}{% bilingual "Edit profile" "编辑资料" %}{% endif %}
                        </button>
                    </div>
                    {% if profile_success %}
                        <div class="alert alert-success mt-2">{{ profile_success }}</div>
                    {% endif %}
                    {% if profile_error %}
                        <div class="alert alert-danger mt-2">{{ profile_error }}</div>
                    {% endif %}
                    <div class="account-settings-form{% if not profile_success and not profile_error and not profile_form.errors %} d-none{% endif %}" data-role="settings-body">
                        <form method="post" class="account-profile-form" novalidate enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="profile">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label class="form-label" for="{{ profile_form.display_name.id_for_label }}">{% bilingual "Display name" "展示昵称" %}</label>
                                    {{ profile_form.display_name }}
                                    {% if profile_form.display_name.help_text %}
                                        <div class="form-text">{{ profile_form.display_name.help_text }}</div>
                                    {% endif %}
                                    {% if profile_form.display_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in profile_form.display_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" for="{{ profile_form.cover_color.id_for_label }}">{% bilingual "Cover color" "背景主色" %}</label>
                                    {{ profile_form.cover_color }}
                                    <div class="form-text">{% bilingual "Pick a primary accent color for your profile header." "选择一个喜欢的主色作为个人页背景。" %}</div>
                                    {% if profile_form.cover_color.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in profile_form.cover_color.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" for="{{ profile_form.avatar.id_for_label }}">{% bilingual "Upload avatar" "上传头像" %}</label>
                                    {{ profile_form.avatar }}
                                    {% if profile_form.avatar.help_text %}
                                        <div class="form-text">{{ profile_form.avatar.help_text }}</div>
                                    {% endif %}
                                    {% if profile_form.avatar.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in profile_form.avatar.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" for="{{ profile_form.feature_image.id_for_label }}">{% bilingual "Featured photo" "展示照片" %}</label>
                                    <div class="feature-upload" data-role="feature-uploader" data-initial-image="{{ profile_media.feature }}">
                                        {{ profile_form.feature_image }}
                                        {{ profile_form.feature_cropped_data }}
                                        <div class="feature-placeholder" data-role="feature-placeholder">
                                            <p class="text-muted mb-2 small">{% bilingual "Add a hero image to highlight your public profile. The preview area below is only for editing feedback and stays compact." "为个人主页添加展示照片（下方预览仅用于编辑反馈，体积很小）。" %}</p>
                                            <div class="d-flex gap-2 flex-wrap">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-role="feature-pick">{% bilingual "Choose photo" "选择照片" %}</button>
                                                <span class="text-muted small" data-role="feature-status"></span>
                                            </div>
                                        </div>
                                        <div class="feature-preview d-none" data-role="feature-preview">
                                            <figure class="feature-preview-frame">
                                                <img src="" alt="{% bilingual 'Featured photo preview' '展示照片预览' %}" data-role="feature-preview-image">
                                            </figure>
                                            <div class="btn-group btn-group-sm mt-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary" data-role="feature-replace">{% bilingual "Replace" "更换" %}</button>
                                                <button type="button" class="btn btn-outline-danger" data-role="feature-remove">{% bilingual "Remove" "移除" %}</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% if profile_form.feature_image.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in profile_form.feature_image.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="{{ profile_form.bio.id_for_label }}">{% bilingual "Bio" "个人简介" %}</label>
                                    {{ profile_form.bio }}
                                    {% if profile_form.bio.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in profile_form.bio.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary">{% bilingual "Save profile" "保存资料" %}</button>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </section>
    </div>
</div>

<div class="profile-cropper-modal d-none" data-role="feature-cropper" aria-hidden="true">
    <div class="cropper-dialog">
        <div class="cropper-header">
            <h2 class="cropper-title">{% bilingual "Crop featured photo" "裁剪展示照片" %}</h2>
            <button type="button" class="btn-close" data-role="crop-cancel" aria-label="{% bilingual 'Close' '关闭' %}"></button>
        </div>
        <div class="cropper-body">
            <div class="cropper-stage" data-role="crop-stage">
                <img src="" alt="{% bilingual 'Image to crop' '待裁剪图片' %}" data-role="crop-image">
            </div>
            <div class="cropper-controls mt-3">
                <label class="form-label me-2">{% bilingual "Zoom" "缩放" %}</label>
                <input type="range" min="1" max="3" step="0.01" value="1" data-role="crop-zoom">
            </div>
        </div>
        <div class="cropper-footer">
            <button type="button" class="btn btn-outline-secondary" data-role="crop-skip">{% bilingual "Use original" "使用原图" %}</button>
            <button type="button" class="btn btn-primary" data-role="crop-confirm">{% bilingual "Crop & apply" "裁剪并使用" %}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'trading/js/account_tabs.js' %}"></script>
<script src="{% static 'trading/js/history_delete.js' %}"></script>
<script src="{% static 'trading/js/profile_cropper.js' %}"></script>
<script nonce="{{ csp_nonce }}">
(function () {
    const settingsCard = document.querySelector("[data-role='settings-card']");
    if (!settingsCard) {
        return;
    }
    const toggleButton = settingsCard.querySelector("[data-role='toggle-settings']");
    const body = settingsCard.querySelector("[data-role='settings-body']");
    const openClass = "d-none";

    const isInitiallyOpen = settingsCard.dataset.settingsOpen === "1";
    if (isInitiallyOpen && body) {
        body.classList.remove(openClass);
    }

    if (toggleButton && body) {
        const labelOpen = toggleButton.dataset.labelOpen || "Collapse";
        const labelClosed = toggleButton.dataset.labelClosed || "Edit";
        toggleButton.addEventListener("click", () => {
            const willOpen = body.classList.contains(openClass);
            body.classList.toggle(openClass, !willOpen);
            toggleButton.textContent = willOpen ? labelOpen : labelClosed;
        });
    }
})();
</script>
{% endblock %}
