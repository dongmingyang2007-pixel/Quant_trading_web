{% extends "base.html" %}
{% load static %}

{% block title %}{% bilingual "Account Center" "账户中心" %}{% endblock %}

{% block content %}
<div class="account-page container-xl ac-scope" data-active-tab="overview">
    <div class="account-shell">
        <div class="account-main">
            <header class="account-page-header">
                <div class="compact-left">
                <button type="button"
                        class="compact-avatar avatar-modal-trigger"
                        data-bs-toggle="modal"
                        data-bs-target="#avatar-upload-modal"
                        aria-label="{% bilingual 'Update avatar' '更新头像' %}">
                    {% if profile_media.avatar %}
                        <img src="{{ profile_media.avatar }}" alt="{{ user_info.display_name|default:user_info.username }}" loading="lazy">
                    {% else %}
                        <span>{{ user_info.display_name|default:user_info.username|first|upper }}</span>
                    {% endif %}
                </button>
                    <div class="compact-meta">
                        <div class="compact-name">{{ user_info.display_name|default:user_info.username }}</div>
                        <div class="compact-subtext">@{{ user_info.username }} · {% bilingual "Member since" "加入于" %} {{ user_info.date_joined|date:"Y-m-d" }} · ID : {{ user_info.id }}</div>
                    </div>
                </div>
                <div class="compact-actions">
                    <span class="badge {% if user_info.email != '未绑定' %}bg-success-subtle text-success-emphasis{% else %}bg-warning-subtle text-warning-emphasis{% endif %}">
                        {% if user_info.email != "未绑定" %}{% bilingual "Email verified" "邮箱已绑定" %}{% else %}{% bilingual "Email pending" "邮箱待绑定" %}{% endif %}
                    </span>
                    <a class="btn btn-outline-secondary btn-sm" href="#account-tab-settings" data-tab-link="settings">
                        {% bilingual "Settings" "设置" %}
                    </a>
                    <div class="account-header-tools">
                        <details class="account-header-menu">
                            <summary class="btn btn-outline-secondary btn-sm">
                                {% bilingual "Quick access" "快捷入口" %}
                            </summary>
                            <div class="account-header-menu-panel">
                                <div class="account-header-menu-section">
                                    <div class="account-header-menu-title">{% bilingual "Shortcuts" "常用功能" %}</div>
                                    <div class="account-header-menu-list">
                                        {% for action in quick_actions %}
                                            <a class="account-header-menu-item" href="{{ action.url }}">
                                                <span class="menu-icon">{{ action.icon }}</span>
                                                <span class="menu-text">
                                                    <span class="menu-label">{{ action.label }}</span>
                                                    <span class="menu-desc">{{ action.desc }}</span>
                                                </span>
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </header>
            {% if messages %}
                <div class="account-flash mt-3">
                    {% for message in messages %}
                        {% if "error" in message.tags %}
                            <div class="alert alert-danger mb-2">{{ message }}</div>
                        {% elif "success" in message.tags %}
                            <div class="alert alert-success mb-2">{{ message }}</div>
                        {% elif "warning" in message.tags %}
                            <div class="alert alert-warning mb-2">{{ message }}</div>
                        {% else %}
                            <div class="alert alert-info mb-2">{{ message }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
            <nav class="account-tab-nav" data-role="account-tab-nav" data-default-tab="overview" role="tablist">
                <button type="button" class="account-tab-btn is-active" id="account-tab-btn-overview" data-tab-target="overview" aria-controls="account-tab-overview" aria-selected="true" role="tab">
                    <span class="tab-title">{% bilingual "Overview" "总览" %}</span>
                    <span class="tab-desc">{% bilingual "Shortcuts & highlights" "快捷入口与概览" %}</span>
                </button>
                <button type="button" class="account-tab-btn" id="account-tab-btn-activity" data-tab-target="activity" aria-controls="account-tab-activity" aria-selected="false" role="tab">
                    <span class="tab-title">{% bilingual "Activity" "动态" %}</span>
                    <span class="tab-desc">{% bilingual "Community posts & engagement" "社区互动与动态" %}</span>
                </button>
                <button type="button" class="account-tab-btn" id="account-tab-btn-history" data-tab-target="history" aria-controls="account-tab-history" aria-selected="false" role="tab">
                    <span class="tab-title">{% bilingual "History" "历史记录" %}</span>
                    <span class="tab-desc">{% bilingual "Backtests & exports" "回测记录与导出" %}</span>
                </button>
                <button type="button" class="account-tab-btn" id="account-tab-btn-settings" data-tab-target="settings" aria-controls="account-tab-settings" aria-selected="false" role="tab">
                    <span class="tab-title">{% bilingual "Settings" "设置" %}</span>
                    <span class="tab-desc">{% bilingual "Profile & security" "个人资料与安全" %}</span>
                </button>
            </nav>

            <div class="account-tab-panels">
                <section class="account-tab-panel is-active" data-tab-panel="overview" id="account-tab-overview" role="tabpanel" aria-labelledby="account-tab-btn-overview">
                    <section class="account-overview">
                        <div class="overview-hero{% if profile_media.feature %} has-media{% endif %}"{% if profile_media.feature %} style="--overview-hero-image: url('{{ profile_media.feature }}');"{% endif %}>
                            <div class="overview-hero-content">
                                <div class="overview-hero-left">
                                <button type="button"
                                        class="overview-hero-avatar avatar-modal-trigger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#avatar-upload-modal"
                                        aria-label="{% bilingual 'Update avatar' '更新头像' %}">
                                    {% if profile_media.avatar %}
                                        <img src="{{ profile_media.avatar }}" alt="{{ user_info.display_name|default:user_info.username }}" loading="lazy">
                                    {% else %}
                                        <span>{{ user_info.display_name|default:user_info.username|first|upper }}</span>
                                    {% endif %}
                                </button>
                                    <div class="overview-hero-meta">
                                        <div class="overview-hero-kicker">
                                            {% bilingual "Account overview" "账户概览" %}
                                            <span class="kicker-sep">·</span>
                                            <a class="overview-hero-link" href="{% url 'trading:profile_public' profile.slug %}">
                                                {% bilingual "Public profile" "公开主页" %}
                                            </a>
                                        </div>
                                        <div class="overview-hero-title">{{ user_info.display_name|default:user_info.username }}</div>
                                        <div class="overview-hero-subtext">
                                            {% bilingual "Member since" "加入于" %} {{ user_info.date_joined|date:"Y-m-d" }}
                                            · {% bilingual "Recent activity" "近期动态" %} {{ activity_entries|length }} {% bilingual "items" "条" %}
                                            · {% bilingual "Backtests" "回测" %} {{ history_runs|length }} {% bilingual "runs" "次" %}
                                        </div>
                                        <div class="overview-hero-chips">
                                            <div class="overview-hero-chip">
                                                <span class="chip-label">{% bilingual "Username" "用户名" %}</span>
                                                <span class="chip-value">{{ user_info.username }}</span>
                                            </div>
                                            <div class="overview-hero-chip">
                                                <span class="chip-label">{% bilingual "Email status" "邮箱状态" %}</span>
                                                <span class="chip-value">
                                                    {% if user_info.email != "未绑定" %}
                                                        {% bilingual "Verified" "已绑定" %}
                                                    {% else %}
                                                        {% bilingual "Pending" "未绑定" %}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="overview-hero-chip">
                                                <span class="chip-label">{% bilingual "Account level" "账户等级" %}</span>
                                                <span class="chip-value">Lv. {{ level_value }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="overview-hero-actions">
                                    <a class="btn btn-primary btn-sm" href="#account-tab-settings" data-tab-link="settings">
                                        {% bilingual "Manage account" "管理我的账户" %}
                                    </a>
                                    <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:profile_public' profile.slug %}">
                                        {% bilingual "Public view" "公开主页" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="overview-grid">
                            <section class="account-card overview-card">
                                <div class="account-card-head">
                                    <h2>{% bilingual "Profile summary" "基本信息" %}</h2>
                                </div>
                                <div class="overview-highlights">
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Username" "用户名" %}</span>
                                        <span class="chip-value">{{ user_info.username }}</span>
                                    </div>
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Display name" "展示昵称" %}</span>
                                        <span class="chip-value">{{ user_info.display_name|default:user_info.username }}</span>
                                    </div>
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Member since" "加入时间" %}</span>
                                        <span class="chip-value">{{ user_info.date_joined|date:"Y-m-d" }}</span>
                                    </div>
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Backtests" "历史回测" %}</span>
                                        <span class="chip-value">{{ history_runs|length }}</span>
                                    </div>
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Recent activity" "近期动态" %}</span>
                                        <span class="chip-value">{{ activity_entries|length }}</span>
                                    </div>
                                    <div class="overview-chip">
                                        <span class="chip-label">{% bilingual "Account level" "账户等级" %}</span>
                                        <span class="chip-value">Lv. {{ level_value }}</span>
                                    </div>
                                </div>
                                <div class="overview-bio-block">
                                    <h3>{% bilingual "Bio" "个人简介" %}</h3>
                                    <p>
                                        {% if profile.bio %}
                                            {{ profile.bio|linebreaksbr }}
                                        {% else %}
                                            <span class="text-muted">{% bilingual "No bio yet. Update your profile to add one." "暂无简介，欢迎在资料设置中补充。" %}</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="overview-metrics">
                                    {% for stat in account_stats %}
                                        <div class="overview-metric">
                                            <span class="metric-value">{{ stat.value }}</span>
                                            <span class="metric-label">{{ stat.label }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </section>
                            <section class="account-card overview-card overview-gallery">
                                <div class="account-card-head">
                                    <h2>{% bilingual "Gallery" "图集" %}</h2>
                                    <span class="text-muted small">
                                        {% if profile_media.gallery %}
                                            {% bilingual "Total" "共" %} {{ profile_media.gallery|length }} {% bilingual "photos" "张" %}
                                        {% elif profile_media.feature %}
                                            {% bilingual "Featured cover" "展示封面" %}
                                        {% else %}
                                            {% bilingual "No media" "暂无照片" %}
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="overview-gallery-body">
                                    {% if profile_media.gallery %}
                                        <div class="overview-gallery-media">
                                            <img src="{{ profile_media.gallery.0.url }}" alt="{% bilingual 'Gallery preview' '图集预览' %}" loading="lazy">
                                        </div>
                                    {% elif profile_media.feature %}
                                        <div class="overview-gallery-media">
                                            <img src="{{ profile_media.feature }}" alt="{% bilingual 'Featured preview' '展示预览' %}" loading="lazy">
                                        </div>
                                    {% else %}
                                        <div class="overview-gallery-empty">
                                            <p class="mb-1">{% bilingual "No media yet" "暂无展示照片" %}</p>
                                            <p class="text-muted mb-0">{% bilingual "Upload images in profile settings to enrich your profile." "可在资料设置中上传展示照片。" %}</p>
                                        </div>
                                    {% endif %}
                                    <div class="overview-gallery-meta">
                                        {% bilingual "Featured images appear on your public profile." "展示照片会应用于个人主页。" %}
                                    </div>
                                </div>
                            </section>
                        </div>
                    </section>
                </section>

                <section class="account-tab-panel" data-tab-panel="activity" id="account-tab-activity" role="tabpanel" aria-labelledby="account-tab-btn-activity">
                    <section class="account-card account-timeline">
                        <div class="account-card-head activity-head">
                            <div class="activity-toolbar">
                                <h2>{% bilingual "Activity" "我的动态" %}</h2>
                                <div class="timeline-filters" data-role="timeline-filters" role="tablist" aria-label="{% bilingual 'Activity filters' '动态筛选' %}">
                                    <button type="button" class="timeline-filter-btn is-active" data-timeline-filter="all">
                                        {% bilingual "All" "全部" %}
                                    </button>
                                    <button type="button" class="timeline-filter-btn" data-timeline-filter="post">
                                        {% bilingual "Posts" "帖子" %}
                                    </button>
                                    <button type="button" class="timeline-filter-btn" data-timeline-filter="comment">
                                        {% bilingual "Comments" "评论" %}
                                    </button>
                                    <button type="button" class="timeline-filter-btn" data-timeline-filter="like">
                                        {% bilingual "Likes" "点赞" %}
                                    </button>
                                </div>
                            </div>
                            <p class="text-muted mb-0 activity-subtext">{% bilingual "Latest posts, comments, and likes at a glance." "最近发布、评论与点赞一览。" %}</p>
                        </div>
                        {% if activity_entries %}
                            <ul class="account-timeline-list">
                                {% for entry in activity_entries %}
                                <li class="timeline-item" data-timeline-item="{{ entry.kind }}">
                                    <div class="timeline-marker" aria-hidden="true">{{ entry.kind|slice:":1"|upper }}</div>
                                    <div class="timeline-main">
                                        <div class="timeline-action">
                                            <span class="timeline-kind">
                                                {% if entry.kind == "post" %}
                                                    {% bilingual "Post" "帖子" %}
                                                {% elif entry.kind == "comment" %}
                                                    {% bilingual "Comment" "评论" %}
                                                {% elif entry.kind == "like" %}
                                                    {% bilingual "Like" "点赞" %}
                                                {% else %}
                                                    {% bilingual "Activity" "动态" %}
                                                {% endif %}
                                            </span>
                                            <span class="timeline-title">{{ entry.title }}</span>
                                        </div>
                                        {% with body=entry.content %}
                                            {% if not body %}
                                                {% with body=entry.excerpt %}
                                                    {% if body %}
                                                        <p class="timeline-summary">{{ body|truncatechars:220|linebreaksbr }}</p>
                                                    {% endif %}
                                                {% endwith %}
                                            {% else %}
                                                <p class="timeline-summary">{{ body|truncatechars:220|linebreaksbr }}</p>
                                            {% endif %}
                                        {% endwith %}
                                        {% if entry.topic %}
                                        <div class="timeline-tags">
                                            <span class="timeline-tag">#{{ entry.topic }}</span>
                                        </div>
                                        {% endif %}
                                        {% if entry.image %}
                                            <figure class="timeline-media">
                                                <button type="button"
                                                        class="timeline-media-trigger"
                                                        data-role="timeline-media-trigger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#timeline-media-modal"
                                                        data-image="{{ entry.image }}"
                                                        aria-label="{% bilingual 'View image' '查看图片' %}">
                                                    <img src="{{ entry.image }}" alt="{% bilingual 'Timeline media' '动态配图' %}" loading="lazy">
                                                </button>
                                            </figure>
                                            <button type="button"
                                                    class="timeline-media-link"
                                                    data-role="timeline-media-trigger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#timeline-media-modal"
                                                    data-image="{{ entry.image }}">
                                                {% bilingual "View full image" "查看原图" %}
                                            </button>
                                        {% endif %}
                                    </div>
                                    <span class="timeline-time">{{ entry.display_time }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="timeline-empty">
                                <p class="mb-1">{% bilingual "No activity yet" "暂无动态" %}</p>
                                <p class="text-muted mb-0">{% bilingual "Share a post or leave a like in the community to get started." "快去社区发布首条帖子或点赞互动，让这里充实起来。" %}</p>
                            </div>
                        {% endif %}
                    </section>
                </section>

                <section class="account-tab-panel" data-tab-panel="history" id="account-tab-history" role="tabpanel" aria-labelledby="account-tab-btn-history">
                    <section class="account-card account-history">
                        <div class="account-card-head">
                            <h2>{% bilingual "Backtest history" "历史回测记录" %}</h2>
                            <p class="text-muted mb-0">{% bilingual "Click a record to reload its parameters and outputs." "点击任一回测即可重新加载策略参数与结果。" %}</p>
                        </div>
                        <div class="account-history-toolbar">
                            <a class="btn btn-primary btn-sm" href="{% url 'trading:backtest' %}">
                                {% bilingual "Start new backtest" "开启新回测" %}
                            </a>
                            {% if history_runs %}
                                <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:export_report' %}">
                                    {% bilingual "Export latest" "导出最近" %}
                                </a>
                            {% else %}
                                <span class="btn btn-outline-secondary btn-sm disabled" aria-disabled="true">
                                    {% bilingual "Export latest" "导出最近" %}
                                </span>
                            {% endif %}
                        </div>
                        {% include "trading/includes/history_panel.html" with history_runs=history_runs history_message=None history_error=None prefix="account-history-" accordion_id="account-history-accordion" empty_id="account-history-empty" delete_url_template=history_delete_template load_url=history_load_url compare_url=history_compare_url %}
                    </section>
                </section>

                <section class="account-tab-panel" data-tab-panel="settings" id="account-tab-settings" role="tabpanel" aria-labelledby="account-tab-btn-settings">
                    <div class="account-settings-shell">
                        <aside class="account-settings-nav" data-role="settings-nav" data-default-section="profile" role="tablist">
                            <div class="account-settings-nav-head">
                                <span class="nav-kicker">{% bilingual "Settings" "设置" %}</span>
                                <span class="nav-subtext">{% bilingual "Manage profile, security, and integrations" "管理资料、安全与集成" %}</span>
                            </div>
                            <button type="button" class="account-settings-link is-active" id="account-settings-profile" data-settings-target="profile" aria-controls="account-settings-panel-profile" aria-selected="true" role="tab">
                                <span class="settings-icon" aria-hidden="true">P</span>
                                <span class="settings-text">
                                    <span class="settings-title">{% bilingual "Profile" "资料设置" %}</span>
                                    <span class="settings-desc">{% bilingual "Public profile & appearance" "公开形象与资料" %}</span>
                                </span>
                            </button>
                            <button type="button" class="account-settings-link" id="account-settings-security" data-settings-target="security" aria-controls="account-settings-panel-security" aria-selected="false" role="tab">
                                <span class="settings-icon" aria-hidden="true">S</span>
                                <span class="settings-text">
                                    <span class="settings-title">{% bilingual "Security" "安全中心" %}</span>
                                    <span class="settings-desc">{% bilingual "Password & protection" "密码与安全提醒" %}</span>
                                </span>
                            </button>
                            <button type="button" class="account-settings-link" id="account-settings-api" data-settings-target="api" aria-controls="account-settings-panel-api" aria-selected="false" role="tab">
                                <span class="settings-icon" aria-hidden="true">API</span>
                                <span class="settings-text">
                                    <span class="settings-title">{% bilingual "API credentials" "API 凭证" %}</span>
                                    <span class="settings-desc">{% bilingual "Data providers & tokens" "数据供应商与凭证" %}</span>
                                </span>
                            </button>
                            {% if is_superuser %}
                            <button type="button" class="account-settings-link" id="account-settings-admin" data-settings-target="admin" aria-controls="account-settings-panel-admin" aria-selected="false" role="tab">
                                <span class="settings-icon" aria-hidden="true">AD</span>
                                <span class="settings-text">
                                    <span class="settings-title">{% bilingual "Admin tools" "高级工具" %}</span>
                                    <span class="settings-desc">{% bilingual "Observability access" "观测与诊断" %}</span>
                                </span>
                            </button>
                            {% endif %}
                        </aside>
                        <div class="account-settings-body">
                            <section class="account-settings-panel is-active" data-settings-panel="profile" id="account-settings-panel-profile" role="tabpanel" aria-labelledby="account-settings-profile">
                                <section class="account-card profile-summary-card" id="settings-pane" data-role="settings-card" data-settings-open="{% if profile_success or profile_error or profile_form.errors %}1{% else %}0{% endif %}">
                                    <div class="account-card-head compact">
                                        <h2>{% bilingual "Profile summary" "公开形象摘要" %}</h2>
                                    </div>
                                    <div class="profile-summary">
                                        <div class="profile-summary-left">
                                            <div class="profile-summary-identity">
                                                <button type="button"
                                                        class="profile-preview-avatar avatar-modal-trigger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#avatar-upload-modal"
                                                        aria-label="{% bilingual 'Update avatar' '更新头像' %}">
                                                    {% if profile_media.avatar %}
                                                        <img src="{{ profile_media.avatar }}" alt="{{ user_info.display_name|default:user_info.username }}" loading="lazy">
                                                    {% else %}
                                                        <span>{{ user_info.display_name|default:user_info.username|first|upper }}</span>
                                                    {% endif %}
                                                </button>
                                                <div class="profile-preview-meta">
                                                    <p class="preview-name">{{ user_info.display_name|default:user_info.username }}</p>
                                                    <p class="text-muted mb-1">@{{ user_info.username }}</p>
                                                    <p class="preview-bio">
                                                        {% if profile.bio %}
                                                            {{ profile.bio|truncatechars:120 }}
                                                        {% else %}
                                                            {% bilingual "Add a short bio to build trust with collaborators." "添加简介可提升合作伙伴对你的了解。" %}
                                                        {% endif %}
                                                    </p>
                                                    <ul class="preview-highlights">
                                                        <li>{% bilingual "Backtests" "回测次数" %}: {{ history_runs|length }}</li>
                                                        <li>{% bilingual "Joined" "加入时间" %}: {{ user_info.date_joined|date:"Y-m-d" }}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            {% if profile_media.feature %}
                                                <div class="profile-preview-thumb">
                                                    <img src="{{ profile_media.feature }}" alt="{% bilingual 'Featured banner' '展示横幅' %}" loading="lazy">
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="profile-summary-right">
                                            <div class="profile-summary-actions">
                                                <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:profile_public' profile.slug %}">
                                                    {% bilingual "Public view" "公开视图" %}
                                                </a>
                                                <button type="button"
                                                        class="btn btn-primary btn-sm"
                                                        data-role="toggle-settings"
                                                        data-label-open="{% bilingual 'Collapse' '收起' %}"
                                                        data-label-closed="{% bilingual 'Edit profile' '编辑资料' %}">
                                                    {% if profile_success or profile_error or profile_form.errors %}{% bilingual "Collapse" "收起" %}{% else %}{% bilingual "Edit profile" "编辑资料" %}{% endif %}
                                                </button>
                                                {% if profile_media.feature %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#profile-preview-modal">
                                                    {% bilingual "View large preview" "查看大图预览" %}
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% if profile_success %}
                                        <div class="alert alert-success mt-2">{{ profile_success }}</div>
                                    {% endif %}
                                    {% if profile_error %}
                                        <div class="alert alert-danger mt-2">{{ profile_error }}</div>
                                    {% endif %}
                                    <div class="account-settings-form{% if not profile_success and not profile_error and not profile_form.errors %} d-none{% endif %}" data-role="settings-body">
                                        <form method="post" class="account-profile-form" id="account-profile-form" action="{% url 'trading:account_update_profile' %}" novalidate enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="card mb-3">
                                                    <div class="card-header">
                                                        {% bilingual "Basic info" "基础信息" %}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-3">
                                                            <div class="col-12 col-md-6">
                                                                <label class="form-label">{% bilingual "Username" "用户名" %}</label>
                                                                <input type="text" class="form-control" value="{{ user_info.username }}" readonly>
                                                            </div>
                                                            <div class="col-12 col-md-6">
                                                                <label class="form-label">{% bilingual "Email" "邮箱" %}</label>
                                                                <input type="text" class="form-control" value="{{ user_info.email }}" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card">
                                                    <div class="card-header">
                                                        {% bilingual "Public profile" "公开资料" %}
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-3">
                                                            <div class="col-12 col-md-6">
                                                                <label class="form-label" for="{{ profile_form.display_name.id_for_label }}">{% bilingual "Display name" "展示昵称" %}</label>
                                                                {{ profile_form.display_name }}
                                                                {% if profile_form.display_name.help_text %}
                                                                    <div class="form-text">{{ profile_form.display_name.help_text }}</div>
                                                                {% endif %}
                                                                {% if profile_form.display_name.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {% for error in profile_form.display_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-12 col-md-6">
                                                                <label class="form-label" for="{{ profile_form.cover_color.id_for_label }}">{% bilingual "Cover color" "背景主色" %}</label>
                                                                {{ profile_form.cover_color }}
                                                                <div class="form-text">{% bilingual "Pick a primary accent color for your profile header." "选择一个喜欢的主色作为个人页背景。" %}</div>
                                                                {% if profile_form.cover_color.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {% for error in profile_form.cover_color.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-12 col-md-6">
                                                                <label class="form-label" for="{{ profile_form.feature_image.id_for_label }}">{% bilingual "Featured photo" "展示照片" %}</label>
                                                                <div class="feature-upload" data-role="feature-uploader" data-initial-image="{{ profile_media.feature }}">
                                                                    {{ profile_form.feature_image }}
                                                                    {{ profile_form.feature_cropped_data }}
                                                                    <div class="feature-placeholder" data-role="feature-placeholder">
                                                                        <p class="text-muted mb-2 small">{% bilingual "Add a hero image to highlight your public profile. The preview area below is only for editing feedback and stays compact." "为个人主页添加展示照片（下方预览仅用于编辑反馈，体积很小）。" %}</p>
                                                                        <div class="d-flex gap-2 flex-wrap">
                                                                            <button type="button" class="btn btn-outline-secondary btn-sm" data-role="feature-pick">{% bilingual "Choose photo" "选择照片" %}</button>
                                                                            <span class="text-muted small" data-role="feature-status"></span>
                                                                        </div>
                                                                    </div>
                                                                    <div class="feature-preview d-none" data-role="feature-preview">
                                                                        <figure class="feature-preview-frame">
                                                                            <img src="" alt="{% bilingual 'Featured photo preview' '展示照片预览' %}" data-role="feature-preview-image">
                                                                        </figure>
                                                                        <div class="btn-group btn-group-sm mt-2" role="group">
                                                                            <button type="button" class="btn btn-outline-secondary" data-role="feature-replace">{% bilingual "Replace" "更换" %}</button>
                                                                            <button type="button" class="btn btn-outline-danger" data-role="feature-remove">{% bilingual "Remove" "移除" %}</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% if profile_form.feature_image.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {% for error in profile_form.feature_image.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label" for="{{ profile_form.bio.id_for_label }}">{% bilingual "Bio" "个人简介" %}</label>
                                                                {{ profile_form.bio }}
                                                                {% if profile_form.bio.errors %}
                                                                    <div class="invalid-feedback d-block">
                                                                        {% for error in profile_form.bio.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer text-end">
                                                        <button type="submit" class="btn btn-primary">{% bilingual "Save changes" "保存更改" %}</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                </section>
                                {% if profile_media.feature %}
                                <div class="modal fade" id="profile-preview-modal" tabindex="-1" aria-labelledby="profile-preview-modal-label" aria-hidden="true">
                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                        <div class="modal-content profile-preview-modal">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="profile-preview-modal-label">{% bilingual "Public preview" "公开视图预览" %}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% bilingual 'Close' '关闭' %}"></button>
                                            </div>
                                            <div class="modal-body">
                                                <img src="{{ profile_media.feature }}" alt="{% bilingual 'Featured banner' '展示横幅' %}" class="profile-preview-modal-image" loading="lazy">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </section>

                            <section class="account-settings-panel" data-settings-panel="security" id="account-settings-panel-security" role="tabpanel" aria-labelledby="account-settings-security">
                                <section class="account-card account-security">
                                    <div class="account-card-head">
                                        <h2>{% bilingual "Security center" "安全中心" %}</h2>
                                    </div>
                                    {% if password_success %}
                                        <div class="alert alert-success mt-2">{{ password_success }}</div>
                                    {% endif %}
                                    {% if password_error %}
                                        <div class="alert alert-danger mt-2">{{ password_error }}</div>
                                    {% endif %}
                                    <div class="settings-split">
                                        <div class="settings-split-main">
                                            <div class="card">
                                                <div class="card-header">
                                                    {% bilingual "Security tips" "安全建议" %}
                                                </div>
                                                <div class="card-body">
                                                    <ul class="mb-0 ps-3">
                                                        <li>{% bilingual "Update passwords regularly and keep MFA enabled." "定期更新密码，并启用邮箱多重验证。" %}</li>
                                                        <li>{% bilingual "Store exported reports securely to protect strategies." "下载回测报告后，妥善保管敏感策略信息。" %}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="settings-split-side">
                                            <div class="card">
                                                <div class="card-header">
                                                    {% bilingual "Password reset" "重置密码" %}
                                                </div>
                                                <div class="card-body">
                                                    <form method="post" class="account-secure-form" action="{% url 'trading:account_reset_password' %}">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-primary w-100">{% bilingual "Send password reset email" "发送重设密码邮件" %}</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </section>

                            <section class="account-settings-panel" data-settings-panel="api" id="account-settings-panel-api" role="tabpanel" aria-labelledby="account-settings-api">
                                <section class="account-card account-api-credentials">
                                    <div class="account-card-head">
                                        <h2>{% bilingual "API credentials" "API 凭证" %}</h2>
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis">{% bilingual "Private" "仅本人可见" %}</span>
                                    </div>
                                    {% if api_success %}
                                        <div class="alert alert-success mt-2">{{ api_success }}</div>
                                    {% endif %}
                                    {% if api_error %}
                                        <div class="alert alert-danger mt-2">{{ api_error }}</div>
                                    {% endif %}
                                    <div class="settings-split settings-split--form">
                                        <div class="settings-split-main">
                                            <p class="text-muted small mb-3">
                                                {% bilingual "Store API keys here to enable external data providers without shell access." "在此保存外部 API 凭证，便于无终端环境下启用数据服务。" %}
                                            </p>
                                            <div class="account-api-status mb-3">
                                                {% for item in api_credential_status %}
                                                    <div class="d-flex justify-content-between align-items-center py-1">
                                                        <div>
                                                            <div class="fw-semibold">{{ item.label }}</div>
                                                            {% if item.help %}
                                                                <div class="text-muted small">{{ item.help }}</div>
                                                            {% endif %}
                                                        </div>
                                                        {% if item.is_set %}
                                                            <span class="badge bg-success-subtle text-success-emphasis">{{ item.masked }}</span>
                                                        {% else %}
                                                            <span class="badge bg-light text-muted">{% bilingual "Not set" "未设置" %}</span>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="settings-split-side">
                                            <form method="post" class="account-api-form" action="{% url 'trading:account_update_api_credentials' %}" autocomplete="off">
                                                {% csrf_token %}
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_trading_mode.id_for_label }}">
                                                            {% bilingual "Alpaca trading mode" "Alpaca 交易环境" %}
                                                        </label>
                                                        {{ api_form.alpaca_trading_mode }}
                                                        {% if api_form.alpaca_trading_mode.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_trading_mode.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="small text-muted fw-semibold mt-1">{% bilingual "Paper trading keys" "模拟交易凭证" %}</div>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_paper_api_key_id.id_for_label }}">Alpaca Paper API Key ID</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_paper_api_key_id }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_paper_api_key_id.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_paper_api_key_id.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_paper_api_secret_key.id_for_label }}">Alpaca Paper API Secret</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_paper_api_secret_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API secret' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_paper_api_secret_key.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_paper_api_secret_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="small text-muted fw-semibold mt-1">{% bilingual "Live trading keys" "实盘交易凭证" %}</div>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_live_api_key_id.id_for_label }}">Alpaca Live API Key ID</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_live_api_key_id }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_live_api_key_id.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_live_api_key_id.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_live_api_secret_key.id_for_label }}">Alpaca Live API Secret</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_live_api_secret_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API secret' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_live_api_secret_key.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_live_api_secret_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="small text-muted fw-semibold mt-1">{% bilingual "Legacy Alpaca keys" "兼容 Alpaca 凭证" %}</div>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_api_key_id.id_for_label }}">Alpaca API Key ID</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_api_key_id }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_api_key_id.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_api_key_id.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.alpaca_api_secret_key.id_for_label }}">Alpaca API Secret</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.alpaca_api_secret_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API secret' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.alpaca_api_secret_key.help_text %}
                                                            <div class="form-text">{{ api_form.alpaca_api_secret_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.bailian_api_key.id_for_label }}">BaiLian (DashScope) API Key</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.bailian_api_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.bailian_api_key.help_text %}
                                                            <div class="form-text">{{ api_form.bailian_api_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.aliyun_access_key_id.id_for_label }}">Aliyun AccessKey ID</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.aliyun_access_key_id }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show AccessKey' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.aliyun_access_key_id.help_text %}
                                                            <div class="form-text">{{ api_form.aliyun_access_key_id.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.aliyun_access_key_secret.id_for_label }}">Aliyun AccessKey Secret</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.aliyun_access_key_secret }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show AccessKey secret' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.aliyun_access_key_secret.help_text %}
                                                            <div class="form-text">{{ api_form.aliyun_access_key_secret.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.gemini_api_key.id_for_label }}">Gemini API Key</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.gemini_api_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.gemini_api_key.help_text %}
                                                            <div class="form-text">{{ api_form.gemini_api_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.ollama_api_key.id_for_label }}">Ollama API Key</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.ollama_api_key }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show API key' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.ollama_api_key.help_text %}
                                                            <div class="form-text">{{ api_form.ollama_api_key.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label" for="{{ api_form.strategy_update_auth_token.id_for_label }}">Strategy Update Token</label>
                                                        <div class="input-group api-secret-field" data-role="api-secret-field">
                                                            {{ api_form.strategy_update_auth_token }}
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-toggle" aria-label="{% bilingual 'Show token' '显示密钥' %}" aria-pressed="false">
                                                                <span class="api-secret-icon" data-role="api-secret-icon-show" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path>
                                                                        <circle cx="12" cy="12" r="3.2"></circle>
                                                                    </svg>
                                                                </span>
                                                                <span class="api-secret-icon d-none" data-role="api-secret-icon-hide" aria-hidden="true">
                                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M17.94 17.94C16.19 19.27 14.16 20 12 20 6 20 2 12 2 12c1.17-1.83 2.6-3.3 4.2-4.42"></path>
                                                                        <path d="M9.88 9.88a3.5 3.5 0 0 0 4.24 4.24"></path>
                                                                        <path d="M3 3l18 18"></path>
                                                                    </svg>
                                                                </span>
                                                            </button>
                                                            <button class="btn btn-outline-secondary" type="button" data-role="api-secret-copy" data-copy-feedback="{% bilingual 'Copied!' '已复制' %}" aria-live="polite">
                                                                {% bilingual "Copy" "复制" %}
                                                            </button>
                                                        </div>
                                                        {% if api_form.strategy_update_auth_token.help_text %}
                                                            <div class="form-text">{{ api_form.strategy_update_auth_token.help_text }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex flex-column gap-2 mt-3">
                                                    <button type="submit" class="btn btn-primary w-100">{% bilingual "Save credentials" "保存凭证" %}</button>
                                                </div>
                                            </form>
                                            <form method="post" action="{% url 'trading:account_clear_api_credentials' %}" class="mt-2">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
                                                    {% bilingual "Clear saved credentials" "清除已保存凭证" %}
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </section>
                            </section>

                            {% if is_superuser %}
                            <section class="account-settings-panel" data-settings-panel="admin" id="account-settings-panel-admin" role="tabpanel" aria-labelledby="account-settings-admin">
                                <section class="account-card">
                                    <div class="account-card-head">
                                        <h2>{% bilingual "Admin tools" "高级工具" %}</h2>
                                        <span class="badge bg-warning text-dark">{% bilingual "Superuser only" "仅超级用户" %}</span>
                                    </div>
                                    <div class="settings-split">
                                        <div class="settings-split-main">
                                            <p class="text-muted mb-0">{% bilingual "Access internal observability dashboards for telemetry and diagnostics." "进入内部可观测性面板以查看遥测与诊断信息。" %}</p>
                                        </div>
                                        <div class="settings-split-side">
                                            <a class="btn btn-outline-secondary w-100" href="{% url 'trading:observability' %}">{% bilingual "Open observability" "打开可观测性" %}</a>
                                        </div>
                                    </div>
                                </section>
                            </section>
                            {% endif %}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="avatar-upload-modal" tabindex="-1" aria-labelledby="avatar-upload-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content avatar-upload-modal" data-role="avatar-uploader">
            <div class="modal-header">
                <h5 class="modal-title" id="avatar-upload-modal-label">{% bilingual "Update avatar" "更新头像" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% bilingual 'Close' '关闭' %}"></button>
            </div>
            <div class="modal-body">
                <div class="avatar-dropzone p-4 text-center" data-role="avatar-dropzone">
                    <input
                        type="file"
                        name="avatar"
                        id="id_avatar"
                        class="form-control d-none"
                        data-role="avatar-input"
                        accept="image/*"
                        form="account-profile-form">
                    <input
                        type="hidden"
                        name="avatar_cropped_data"
                        data-role="avatar-cropped"
                        form="account-profile-form">
                    <div class="avatar-dropzone-inner">
                        <div class="dropzone-title">{% bilingual "Drag & drop your avatar here" "拖拽头像到这里" %}</div>
                        <div class="dropzone-subtext">
                            {% if profile_form.avatar.help_text %}
                                {{ profile_form.avatar.help_text }}
                            {% else %}
                                {% bilingual "JPG/PNG recommended, 400x400 or larger." "支持 JPG/PNG，建议 400x400 以上。" %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" data-role="avatar-pick">
                            {% bilingual "Choose image" "选择图片" %}
                        </button>
                    </div>
                </div>
                <div class="avatar-cropper d-none" data-role="avatar-cropper">
                    <div class="cropper-stage avatar-cropper-stage" data-role="avatar-crop-stage">
                        <div class="cropper-mask cropper-mask--circle" data-role="avatar-crop-frame">
                            <img src="" alt="{% bilingual 'Avatar crop preview' '头像裁剪预览' %}" data-role="avatar-crop-image">
                        </div>
                    </div>
                    <div class="avatar-cropper-controls mt-3">
                        <span class="cropper-zoom-icon" aria-hidden="true">
                            <svg class="bi bi-dash-lg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8"/>
                            </svg>
                        </span>
                        <label class="form-label visually-hidden" for="avatar-crop-zoom">{% bilingual "Zoom" "缩放" %}</label>
                        <input
                            type="range"
                            min="1"
                            max="3"
                            step="0.01"
                            value="1"
                            id="avatar-crop-zoom"
                            class="form-range"
                            data-role="avatar-crop-zoom">
                        <span class="cropper-zoom-icon" aria-hidden="true">
                            <svg class="bi bi-plus-lg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                            </svg>
                        </span>
                    </div>
                </div>
                <div class="avatar-upload-status text-muted small mt-2" data-role="avatar-status"></div>
                {% if profile_form.avatar.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in profile_form.avatar.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    {% bilingual "Cancel" "取消" %}
                </button>
                <button type="submit" class="btn btn-primary" data-role="avatar-save" form="account-profile-form">
                    {% bilingual "Save avatar" "保存头像" %}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="timeline-media-modal" tabindex="-1" aria-labelledby="timeline-media-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content timeline-media-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="timeline-media-modal-label">{% bilingual "Activity media" "动态附件" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% bilingual 'Close' '关闭' %}"></button>
            </div>
            <div class="modal-body">
                <img src="" alt="{% bilingual 'Activity media' '动态附件' %}" class="timeline-media-modal-image" data-role="timeline-modal-image" loading="lazy">
            </div>
        </div>
    </div>
</div>

<div class="profile-cropper-modal d-none" data-role="feature-cropper" aria-hidden="true">
    <div class="cropper-dialog">
        <div class="cropper-header">
            <h2 class="cropper-title">{% bilingual "Crop featured photo" "裁剪展示照片" %}</h2>
            <button type="button" class="btn-close" data-role="crop-cancel" aria-label="{% bilingual 'Close' '关闭' %}"></button>
        </div>
        <div class="cropper-body">
            <div class="cropper-stage" data-role="crop-stage">
                <div class="cropper-mask cropper-mask--rect" data-role="crop-frame">
                    <img src="" alt="{% bilingual 'Image to crop' '待裁剪图片' %}" data-role="crop-image">
                </div>
            </div>
            <div class="cropper-controls mt-3">
                <span class="cropper-zoom-icon" aria-hidden="true">
                    <svg class="bi bi-dash-lg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8"/>
                    </svg>
                </span>
                <label class="form-label visually-hidden" for="feature-crop-zoom">{% bilingual "Zoom" "缩放" %}</label>
                <input
                    type="range"
                    min="1"
                    max="3"
                    step="0.01"
                    value="1"
                    id="feature-crop-zoom"
                    class="form-range"
                    data-role="crop-zoom">
                <span class="cropper-zoom-icon" aria-hidden="true">
                    <svg class="bi bi-plus-lg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                    </svg>
                </span>
            </div>
        </div>
        <div class="cropper-footer">
            <button type="button" class="btn btn-outline-secondary" data-role="crop-skip">{% bilingual "Use original" "使用原图" %}</button>
            <button type="button" class="btn btn-primary" data-role="crop-confirm">{% bilingual "Crop & apply" "裁剪并使用" %}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'trading/js/account_tabs.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/history_delete.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/history_meta.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/profile_cropper.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/paper_trading.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
<script nonce="{{ csp_nonce }}">
(function () {
    const settingsCard = document.querySelector("[data-role='settings-card']");
    if (!settingsCard) {
        return;
    }
    const toggleButton = settingsCard.querySelector("[data-role='toggle-settings']");
    const body = settingsCard.querySelector("[data-role='settings-body']");
    const openClass = "d-none";

    const isInitiallyOpen = settingsCard.dataset.settingsOpen === "1";
    if (isInitiallyOpen && body) {
        body.classList.remove(openClass);
    }

    if (toggleButton && body) {
        const labelOpen = toggleButton.dataset.labelOpen || "Collapse";
        const labelClosed = toggleButton.dataset.labelClosed || "Edit";
        toggleButton.addEventListener("click", () => {
            const willOpen = body.classList.contains(openClass);
            body.classList.toggle(openClass, !willOpen);
            toggleButton.textContent = willOpen ? labelOpen : labelClosed;
        });
    }
})();
</script>
{% endblock %}
