{% extends "base.html" %}
{% load static %}

{% block title %}
{% with lang_prefix=lang_prefix|default:request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
{% if lang_prefix == 'zh' %}股市信息{% else %}Market Insights{% endif %}
{% endwith %}
{% endblock %}

{% block extra_head %}
{% with lang_prefix=lang_prefix|default:request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
<link rel="stylesheet" href="{% static 'trading/css/market_insights.css' %}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<meta name="market-api" content="{% url 'trading:market_insights_data' %}">
<meta name="market-chart-api" content="{% url 'trading:market_chart_data' %}">
<meta name="market-assets" content="{% url 'trading:market_assets_data' %}">
<meta name="market-lang" content="{{ lang_prefix }}">
<meta name="backtest-base" content="{% url 'trading:backtest' %}">
<meta name="csrf-token" content="{{ csrf_token }}">
{% endwith %}
{% endblock %}

{% block content %}
{% with lang_prefix=lang_prefix|default:request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
<div class="market-page container-xl view-list">
    <header class="market-topbar">
        <div class="market-topbar-left">
            <p class="market-kicker">{% if lang_prefix == 'zh' %}市场情报{% else %}Market Intelligence{% endif %}</p>
            <h1 class="market-title">{% if lang_prefix == 'zh' %}股市信息{% else %}Market Insights{% endif %}</h1>
            <p class="market-subtitle">
                {% if lang_prefix == 'zh' %}
                    快速浏览近 5 日、1 月或 6 月的涨跌趋势，按需搜索关心的股票，辅助你捕捉市场脉动。
                {% else %}
                    Scan 5-day, 1-month, or 6-month moves, search any ticker, and stay on top of momentum shifts.
                {% endif %}
            </p>
        </div>
        <div class="market-topbar-right">
            <div class="market-search-wrap">
                <form id="market-search-form" class="market-search">
                    {% csrf_token %}
                    <input type="text" name="query" id="market-search-input" placeholder="{% if lang_prefix == 'zh' %}搜索股票代码（例如 NVDA）{% else %}Search ticker (e.g. NVDA){% endif %}" autocomplete="off">
                    <button type="submit" class="btn btn-primary">{% if lang_prefix == 'zh' %}查找{% else %}Search{% endif %}</button>
                </form>
                <div class="market-typeahead" data-role="typeahead-panel" aria-expanded="false" hidden>
                    <div class="typeahead-list" data-role="typeahead-list"></div>
                    <div class="typeahead-hint text-muted small" data-role="typeahead-hint">
                        {% if lang_prefix == 'zh' %}
                            选择热门/最近/自选股票快速跳转
                        {% else %}
                            Pick from trending, recent, or watchlist tickers
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="market-topbar-actions">
                <button type="button" id="market-watch-add" class="btn btn-outline-light market-watch-btn">
                    {% if lang_prefix == 'zh' %}加入自选{% else %}Add to watchlist{% endif %}
                </button>
                <a class="btn btn-outline-light tradingview-link" href="https://www.tradingview.com/screener/" target="_blank" rel="noopener">
                    {% if lang_prefix == 'zh' %}打开 TradingView 筛选器{% else %}Open TradingView screener{% endif %}
                </a>
            </div>
        </div>
        <div class="market-timeframe-row">
            <div class="market-timeframes" role="group" aria-label="{% if lang_prefix == 'zh' %}时间范围选择{% else %}Timeframe selector{% endif %}">
                {% for tf in timeframes.values %}
                <button type="button"
                        class="market-timeframe{% if tf.key == default_timeframe.key %} is-active{% endif %}"
                        data-timeframe="{{ tf.key }}">
                    {% if lang_prefix == 'zh' %}{{ tf.label }}{% else %}{{ tf.label_en }}{% endif %}
                </button>
                {% endfor %}
            </div>
        </div>
    </header>

    <section class="market-workspace">
        <div class="market-pane market-pane-left">
            <section class="market-view is-active" data-view="list" id="market-pane-list">
                <section class="market-status" aria-live="polite">
                    <div class="market-status-primary">
                        <div class="market-status-summary">
                            <div class="market-status-title">
                                <span class="market-context" data-role="status-context" data-lang="{{ lang_prefix }}">
                                    {% if lang_prefix == 'zh' %}涨幅榜 · {{ default_timeframe.label }}{% else %}Gainers · {{ default_timeframe.label_en }}{% endif %}
                                </span>
                                <span class="market-sort-summary" data-role="rank-sort-summary">
                                    {% if lang_prefix == 'zh' %}排序：涨跌幅（默认）{% else %}Sorted by: Chg% (default){% endif %}
                                </span>
                            </div>
                            <div class="market-status-state" aria-live="polite">
                                <span class="market-status-pill" data-role="status-state">
                                    {% if lang_prefix == 'zh' %}加载中{% else %}Loading{% endif %}
                                </span>
                                <span class="market-status-text" data-role="status-text" data-lang="{{ lang_prefix }}">
                                    {% if lang_prefix == 'zh' %}
                                        正在加载 {{ default_timeframe.label }} 数据…
                                    {% else %}
                                        Loading {{ default_timeframe.label_en }} data…
                                    {% endif %}
                                </span>
                            </div>
                            <div class="market-status-updated">
                                <span class="market-status-label">{% if lang_prefix == 'zh' %}更新{% else %}Updated{% endif %}</span>
                                <time data-role="status-updated"></time>
                            </div>
                            <div class="market-status-tags" aria-label="{% if lang_prefix == 'zh' %}数据标签{% else %}Data tags{% endif %}">
                                <span class="market-tag"
                                      data-role="price-basis"
                                      title="{% if lang_prefix == 'zh' %}SIP 全量行情 + 拆股复权{% else %}SIP full feed + split-adjusted{% endif %}">
                                    {% if lang_prefix == 'zh' %}数据：SIP/复权{% else %}Data: SIP/Adjusted{% endif %}
                                </span>
                                <span class="market-tag" data-role="source-text">
                                    {% if lang_prefix == 'zh' %}数据来源：—{% else %}Data source: —{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="market-status-controls">
                            <button type="button" class="market-status-refresh" data-role="status-refresh">
                                {% if lang_prefix == 'zh' %}刷新{% else %}Refresh{% endif %}
                            </button>
                            <div class="market-toggle-block" role="group" aria-label="{% if lang_prefix == 'zh' %}自动刷新{% else %}Auto refresh{% endif %}">
                                <span class="market-toggle-label">{% if lang_prefix == 'zh' %}自动{% else %}Auto{% endif %}</span>
                                <div class="market-toggle-group" data-role="auto-refresh-toggle" role="tablist">
                                    <button type="button" class="toggle-btn" data-interval="0" role="tab" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}关闭{% else %}Off{% endif %}
                                    </button>
                                    <button type="button" class="toggle-btn" data-interval="15000" role="tab" aria-pressed="false">15s</button>
                                    <button type="button" class="toggle-btn" data-interval="30000" role="tab" aria-pressed="false">30s</button>
                                    <button type="button" class="toggle-btn" data-interval="60000" role="tab" aria-pressed="false">60s</button>
                                </div>
                                <button type="button" class="market-toggle-link" data-role="auto-refresh-pause">
                                    {% if lang_prefix == 'zh' %}暂停{% else %}Pause{% endif %}
                                </button>
                                <span class="market-countdown" data-role="auto-refresh-countdown">
                                    {% if lang_prefix == 'zh' %}下次刷新：—{% else %}Next refresh: —{% endif %}
                                </span>
                            </div>
                            <div class="market-toggle-block" role="group" aria-label="{% if lang_prefix == 'zh' %}时区{% else %}Time zone{% endif %}">
                                <span class="market-toggle-label">{% if lang_prefix == 'zh' %}时区{% else %}Time{% endif %}</span>
                                <div class="market-toggle-group" data-role="timezone-toggle" role="tablist">
                                    <button type="button" class="toggle-btn is-active" data-tz="utc" role="tab" aria-pressed="true">UTC</button>
                                    <button type="button" class="toggle-btn" data-tz="local" role="tab" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}本地{% else %}Local{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="market-status-expanded" data-role="status-expanded" hidden>
                        <div class="market-status-progress" data-role="snapshot-progress" hidden>
                            <div class="market-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="{% if lang_prefix == 'zh' %}快照进度{% else %}Snapshot progress{% endif %}">
                                <span class="market-progress-fill" data-role="snapshot-progress-fill"></span>
                            </div>
                            <span class="market-snapshot" data-role="snapshot-text">
                                {% if lang_prefix == 'zh' %}快照：—{% else %}Snapshot: —{% endif %}
                            </span>
                        </div>
                        <div class="market-status-warning" data-role="snapshot-warning" hidden>
                            <span class="market-warning-text" data-role="snapshot-warning-text">
                                {% if lang_prefix == 'zh' %}部分数据尚未就绪{% else %}Partial data pending{% endif %}
                            </span>
                            <button type="button" class="market-warning-link" data-role="snapshot-details">
                                {% if lang_prefix == 'zh' %}详情{% else %}Details{% endif %}
                            </button>
                            <button type="button" class="market-warning-btn" data-role="snapshot-retry">
                                {% if lang_prefix == 'zh' %}重试{% else %}Retry{% endif %}
                            </button>
                            <div class="market-warning-details" data-role="snapshot-details-panel" hidden>
                                {% if lang_prefix == 'zh' %}
                                    快照完成后仍在后台补齐/校验部分标的，榜单可能暂时不完整。
                                {% else %}
                                    Snapshot is complete, but some instruments are still being backfilled or validated.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </section>

                <section class="market-rankings" data-role="rankings-section">
                    <header class="market-rankings-head">
                        <div class="market-rank-groups" role="group" aria-label="{% if lang_prefix == 'zh' %}榜单类型{% else %}Ranking modes{% endif %}">
                            <div class="market-rank-group" role="group" aria-labelledby="rank-group-movers-label">
                                <p class="market-rank-group-label" id="rank-group-movers-label">{% if lang_prefix == 'zh' %}动能榜单{% else %}Top movers{% endif %}</p>
                                <div class="market-rank-tabs">
                                    <button type="button" class="market-rank-tab is-active" data-role="rank-tab" data-list="gainers" aria-pressed="true">
                                        {% if lang_prefix == 'zh' %}涨幅榜{% else %}Gainers{% endif %}
                                    </button>
                                    <button type="button" class="market-rank-tab" data-role="rank-tab" data-list="losers" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}跌幅榜{% else %}Losers{% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="market-rank-group" role="group" aria-labelledby="rank-group-liquidity-label">
                                <p class="market-rank-group-label" id="rank-group-liquidity-label">{% if lang_prefix == 'zh' %}流动性{% else %}Liquidity{% endif %}</p>
                                <div class="market-rank-tabs">
                                    <button type="button" class="market-rank-tab" data-role="rank-tab" data-list="most_active" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}活跃榜{% else %}Most Active{% endif %}
                                    </button>
                                    <button type="button" class="market-rank-tab" data-role="rank-tab" data-list="top_turnover" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}成交额{% else %}Top Turnover{% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="market-rank-group" role="group" aria-labelledby="rank-group-universe-label">
                                <p class="market-rank-group-label" id="rank-group-universe-label">{% if lang_prefix == 'zh' %}全市场{% else %}Universe{% endif %}</p>
                                <div class="market-rank-tabs">
                                    <button type="button" class="market-rank-tab" data-role="rank-tab" data-list="all" aria-pressed="false">
                                        {% if lang_prefix == 'zh' %}全部股票{% else %}All Stocks{% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="market-rank-group market-rank-group--muted" role="group" aria-labelledby="rank-group-anomaly-label" aria-disabled="true">
                                <p class="market-rank-group-label" id="rank-group-anomaly-label">{% if lang_prefix == 'zh' %}异常信号{% else %}Anomalies{% endif %}</p>
                                <div class="market-rank-tabs">
                                    <span class="market-rank-tag">{% if lang_prefix == 'zh' %}跳空上涨{% else %}Gap up{% endif %}</span>
                                    <span class="market-rank-tag">{% if lang_prefix == 'zh' %}跳空下跌{% else %}Gap down{% endif %}</span>
                                    <span class="market-rank-tag">{% if lang_prefix == 'zh' %}量能异动{% else %}Volume spike{% endif %}</span>
                                </div>
                                <p class="market-rank-note">{% if lang_prefix == 'zh' %}即将上线{% else %}Coming soon{% endif %}</p>
                            </div>
                        </div>
                        <div class="market-rank-meta">
                            <p class="market-rank-context" data-role="rank-context">
                                {% if lang_prefix == 'zh' %}涨幅榜（{{ default_timeframe.label }}）{% else %}Gainers ({{ default_timeframe.label_en }}){% endif %}
                            </p>
                            <p class="market-rank-sort" data-role="rank-sort-summary">
                                {% if lang_prefix == 'zh' %}排序：涨跌幅（默认）{% else %}Sorted by: Chg% (default){% endif %}
                            </p>
                            <p class="market-rank-desc"
                               data-role="rank-desc"
                               data-desc-gainers="{% if lang_prefix == 'zh' %}按所选时间范围排序，展示表现最佳的股票。{% else %}Best performers within the selected window.{% endif %}"
                               data-desc-losers="{% if lang_prefix == 'zh' %}关注回撤最大的标的，观察潜在反弹机会。{% else %}Track the deepest pullbacks for potential reversals.{% endif %}"
                               data-desc-most-active="{% if lang_prefix == 'zh' %}按成交量筛选市场中交易最活跃的股票。{% else %}Highest volume names across the market.{% endif %}"
                               data-desc-top-turnover="{% if lang_prefix == 'zh' %}按成交额排序，聚焦资金最密集的交易。{% else %}Highest dollar turnover across the market.{% endif %}"
                               data-desc-all="{% if lang_prefix == 'zh' %}按字母表浏览全部可交易股票。{% else %}Browse tradable stocks alphabetically.{% endif %}">
                                {% if lang_prefix == 'zh' %}按所选时间范围排序，展示表现最佳的股票。{% else %}Best performers within the selected window.{% endif %}
                            </p>
                        </div>
                    </header>
                    <div class="market-list">
                        <div class="all-stocks-table-wrap ranking-table-wrap">
                            <table class="all-stocks-table ranking-table" data-role="ranking-table">
                                <thead>
                                    <tr>
                                        <th scope="col">{% if lang_prefix == 'zh' %}代码{% else %}Symbol{% endif %}</th>
                                        <th scope="col">{% if lang_prefix == 'zh' %}名称{% else %}Name{% endif %}</th>
                                        <th scope="col">{% if lang_prefix == 'zh' %}交易所{% else %}Exchange{% endif %}</th>
                                        <th scope="col">{% if lang_prefix == 'zh' %}最新{% else %}Last{% endif %}</th>
                                        <th scope="col" data-role="ranking-change-header">
                                            <button type="button" class="ranking-sort" data-role="ranking-sort">
                                                <span data-role="ranking-change-label">{% if lang_prefix == 'zh' %}涨跌幅{% else %}Chg%{% endif %}</span>
                                                <span class="ranking-sort-icon" data-role="ranking-sort-icon" aria-hidden="true">↕</span>
                                            </button>
                                        </th>
                                        <th scope="col" class="col-watch">
                                            <span class="sr-only">{% if lang_prefix == 'zh' %}自选{% else %}Watchlist{% endif %}</span>
                                            ★
                                        </th>
                                    </tr>
                                </thead>
                                <tbody data-role="ranking-list">
                                    <tr>
                                        <td colspan="6">{% if lang_prefix == 'zh' %}加载中…{% else %}Loading…{% endif %}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="ranking-sentinel" data-role="ranking-sentinel" aria-hidden="true"></div>
                    </div>
                </section>

                <section class="market-all-stocks" data-role="all-stocks" hidden>
                    <header class="all-stocks-head">
                        <details class="all-stocks-filter">
                            <summary class="all-stocks-summary">
                                {% if lang_prefix == 'zh' %}字母筛选{% else %}A–Z Filter{% endif %}
                            </summary>
                            <div class="all-stocks-letters" data-role="all-stocks-letters">
                                <button type="button" class="all-letter is-active" data-letter="all">
                                    {% if lang_prefix == 'zh' %}全部{% else %}All{% endif %}
                                </button>
                                {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ"|make_list %}
                                <button type="button" class="all-letter" data-letter="{{ letter }}">{{ letter }}</button>
                                {% endfor %}
                            </div>
                        </details>
                        <div class="all-stocks-meta">
                            <span data-role="all-stocks-count"></span>
                            <button type="button" class="all-stocks-back" data-role="all-stocks-back">
                                {% if lang_prefix == 'zh' %}返回榜单{% else %}Back to Rankings{% endif %}
                            </button>
                        </div>
                    </header>
                    <div class="all-stocks-table-wrap">
                        <table class="all-stocks-table">
                            <thead>
                                <tr>
                                    <th scope="col">{% if lang_prefix == 'zh' %}代码{% else %}Symbol{% endif %}</th>
                                    <th scope="col">{% if lang_prefix == 'zh' %}名称{% else %}Name{% endif %}</th>
                                    <th scope="col">{% if lang_prefix == 'zh' %}交易所{% else %}Exchange{% endif %}</th>
                                    <th scope="col">{% if lang_prefix == 'zh' %}最新{% else %}Last{% endif %}</th>
                                    <th scope="col">{% if lang_prefix == 'zh' %}涨跌幅{% else %}Chg%{% endif %}</th>
                                </tr>
                            </thead>
                            <tbody data-role="all-stocks-body">
                                <tr>
                                    <td colspan="5">{% if lang_prefix == 'zh' %}加载中…{% else %}Loading…{% endif %}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="all-stocks-pagination" data-role="all-stocks-pagination"></div>
                </section>

                <aside class="market-quick-access">
                    <div class="quick-card" id="market-quick-card">
                        <div class="quick-card-head">
                            <div>
                                <p class="quick-eyebrow">{% if lang_prefix == 'zh' %}快捷入口{% else %}Quick access{% endif %}</p>
                                <h3>{% if lang_prefix == 'zh' %}自选与最近{% else %}Watchlist & Recents{% endif %}</h3>
                            </div>
                        <div class="quick-tabs" role="tablist" aria-label="{% if lang_prefix == 'zh' %}自选与最近{% else %}Watchlist and recent tabs{% endif %}">
                            <button type="button"
                                    class="quick-tab is-active"
                                    data-role="quick-tab"
                                    data-target="watchlist"
                                    id="quick-tab-watchlist"
                                    role="tab"
                                    aria-selected="true"
                                    aria-controls="quick-watchlist">
                                {% if lang_prefix == 'zh' %}自选{% else %}Watchlist{% endif %}
                                <span class="quick-count" data-role="watch-count">0</span>
                            </button>
                                <button type="button"
                                    class="quick-tab"
                                    data-role="quick-tab"
                                    data-target="recent"
                                    id="quick-tab-recent"
                                    role="tab"
                                    aria-selected="false"
                                    aria-controls="quick-recent">
                                {% if lang_prefix == 'zh' %}最近{% else %}Recent{% endif %}
                                <span class="quick-count" data-role="recent-count">0</span>
                            </button>
                        </div>
                    </div>
                        <div class="quick-panel is-active" data-role="quick-panel" data-panel="watchlist" id="quick-watchlist" role="tabpanel" aria-labelledby="quick-tab-watchlist">
                            <div class="quick-chip-flow" data-role="watchlist-chips" data-loading="true">
                                {% for _ in "1234"|make_list %}
                                <span class="skeleton-chip" aria-hidden="true"></span>
                                {% endfor %}
                            </div>
                            <p class="quick-hint">
                                {% if lang_prefix == 'zh' %}
                                    点击表格右侧的星标可快速加入自选。
                                {% else %}
                                    Tap the star on any row to add it to your watchlist.
                                {% endif %}
                            </p>
                        </div>
                        <div class="quick-panel" data-role="quick-panel" data-panel="recent" id="quick-recent" role="tabpanel" aria-labelledby="quick-tab-recent" hidden>
                            <div class="quick-chip-flow" data-role="recent-chips" data-loading="true">
                                {% for _ in "123"|make_list %}
                                <span class="skeleton-chip" aria-hidden="true"></span>
                                {% endfor %}
                            </div>
                            <div class="quick-panel-actions">
                                <button type="button" class="quick-clear" data-role="recent-clear">
                                    {% if lang_prefix == 'zh' %}清空记录{% else %}Clear history{% endif %}
                                </button>
                                <span class="quick-hint">
                                    {% if lang_prefix == 'zh' %}
                                        自动保留最近 6 条检索记录。
                                    {% else %}
                                        Up to six searches are saved.
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </aside>
            </section>
        </div>

        <div class="market-pane market-pane-right">
            <div class="market-pane-tabs" role="tablist" aria-label="{% if lang_prefix == 'zh' %}榜单、概览与图表切换{% else %}Rankings, overview, and chart tabs{% endif %}">
                <button type="button" class="pane-tab" data-role="pane-tab" data-view="list" id="pane-tab-list" role="tab" aria-selected="false" aria-controls="market-pane-list">
                    {% if lang_prefix == 'zh' %}榜单{% else %}Rankings{% endif %}
                </button>
                <button type="button" class="pane-tab is-active" data-role="pane-tab" data-view="detail" id="pane-tab-detail" role="tab" aria-selected="true" aria-controls="market-pane-detail">
                    {% if lang_prefix == 'zh' %}概览{% else %}Overview{% endif %}
                </button>
                <button type="button" class="pane-tab" data-role="pane-tab" data-view="chart" id="pane-tab-chart" role="tab" aria-selected="false" aria-controls="market-pane-chart">
                    {% if lang_prefix == 'zh' %}图表{% else %}Chart{% endif %}
                </button>
            </div>

            <section class="market-view" data-view="detail" id="market-pane-detail" role="tabpanel" aria-labelledby="pane-tab-detail">
                <header class="market-view-head">
                    <button type="button" class="market-view-back" data-view-back="list">
                        {% if lang_prefix == 'zh' %}返回列表{% else %}Back to list{% endif %}
                    </button>
                    <div class="market-view-actions">
                        <button type="button" class="btn btn-primary market-view-chart" data-view-chart>
                            {% if lang_prefix == 'zh' %}查看图表{% else %}View chart{% endif %}
                        </button>
                    </div>
                </header>
                <section class="market-detail-hero">
                    <div class="detail-identity">
                        <p class="detail-symbol" data-role="detail-symbol">—</p>
                        <h2 class="detail-name" data-role="detail-name">—</h2>
                        <div class="detail-price-row">
                            <span class="detail-price" data-role="detail-price">--</span>
                            <span class="detail-change" data-role="detail-change">--</span>
                        </div>
                        <p class="detail-meta" data-role="detail-meta"></p>
                    </div>
                    <div class="detail-trade" data-role="detail-trade">
                        <div class="detail-trade-head">
                            <span class="detail-trade-label">
                                {% if lang_prefix == 'zh' %}快速下单{% else %}Quick order{% endif %}
                            </span>
                            <span class="detail-trade-symbol" data-role="trade-symbol">—</span>
                        </div>
                        <div class="detail-trade-mode" data-role="trade-mode">
                            <span class="detail-trade-mode-label">
                                {% if lang_prefix == 'zh' %}交易模式{% else %}Mode{% endif %}
                            </span>
                            <div class="detail-trade-mode-actions">
                                <button type="button" class="detail-trade-mode-btn" data-role="trade-mode-btn" data-mode="paper">
                                    {% if lang_prefix == 'zh' %}模拟{% else %}Paper{% endif %}
                                </button>
                                <button type="button" class="detail-trade-mode-btn" data-role="trade-mode-btn" data-mode="live">
                                    {% if lang_prefix == 'zh' %}实盘{% else %}Live{% endif %}
                                </button>
                            </div>
                            <span class="detail-trade-mode-status" data-role="trade-mode-status"></span>
                        </div>
                        <div class="detail-trade-row">
                            <label for="detail-trade-qty">
                                {% if lang_prefix == 'zh' %}下单数量 (Shares){% else %}Quantity (Shares){% endif %}
                            </label>
                            <input id="detail-trade-qty" type="number" min="0.0001" step="0.0001" placeholder="1" data-role="trade-qty">
                        </div>
                        <div class="detail-trade-actions">
                            <button type="button" class="detail-trade-btn detail-trade-buy" data-role="trade-buy">
                                {% if lang_prefix == 'zh' %}买入{% else %}Buy{% endif %}
                            </button>
                            <button type="button" class="detail-trade-btn detail-trade-sell" data-role="trade-sell">
                                {% if lang_prefix == 'zh' %}卖出{% else %}Sell{% endif %}
                            </button>
                        </div>
                        <p class="detail-trade-status" data-role="trade-status"></p>
                    </div>
                </section>
                <div class="market-detail-grid">
                    <div class="market-panel-card">
                        <div class="market-panel-head">
                            <h3>{% if lang_prefix == 'zh' %}公司概览{% else %}Company Profile{% endif %}</h3>
                            <span class="market-panel-badge">{% if lang_prefix == 'zh' %}基础面{% else %}Profile{% endif %}</span>
                        </div>
                        <p class="market-panel-text" data-role="profile-summary">
                            {% if lang_prefix == 'zh' %}
                                选择列表中的股票即可查看公司摘要、估值与指标快照。
                            {% else %}
                                Select a symbol to see fundamentals, valuation, and snapshot metrics.
                            {% endif %}
                        </p>
                        <ul class="market-panel-list" data-role="profile-metrics"></ul>
                    </div>
                    <div class="market-panel-card">
                        <div class="market-panel-head">
                            <h3>{% if lang_prefix == 'zh' %}AI 摘要{% else %}AI Summary{% endif %}</h3>
                            <span class="market-panel-badge">AI</span>
                        </div>
                        <p class="market-panel-text" data-role="ai-summary">
                            {% if lang_prefix == 'zh' %}
                                聚合研报与行情信号，生成可执行的摘要观点。
                            {% else %}
                                Condense research notes and signals into an actionable brief.
                            {% endif %}
                        </p>
                    </div>
                    <div class="market-panel-card">
                        <div class="market-panel-head">
                            <h3>{% if lang_prefix == 'zh' %}新闻流{% else %}Newsflow{% endif %}</h3>
                            <span class="market-panel-badge">{% if lang_prefix == 'zh' %}资讯{% else %}News{% endif %}</span>
                        </div>
                        <ul class="market-panel-list market-panel-news" data-role="news-list">
                            <li>{% if lang_prefix == 'zh' %}暂无相关新闻{% else %}No related headlines yet.{% endif %}</li>
                        </ul>
                    </div>
                    <div class="market-panel-card">
                        <div class="market-panel-head">
                            <h3>{% if lang_prefix == 'zh' %}订单簿深度{% else %}Order Book{% endif %}</h3>
                            <span class="market-panel-badge">{% if lang_prefix == 'zh' %}深度{% else %}Depth{% endif %}</span>
                        </div>
                        <p class="market-panel-text">
                            {% if lang_prefix == 'zh' %}
                                未来可在此呈现买卖盘分布与流动性梯度。
                            {% else %}
                                Future slot for depth-of-market and liquidity ladders.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </section>

            <section class="market-view" data-view="chart" id="market-pane-chart" role="tabpanel" aria-labelledby="pane-tab-chart">
                <header class="market-view-head">
                    <button type="button" class="market-view-back" data-view-back="detail">
                        {% if lang_prefix == 'zh' %}返回概览{% else %}Back to overview{% endif %}
                    </button>
                    <div class="market-view-actions">
                        <button type="button" class="btn btn-outline-secondary market-view-back" data-view-back="list">
                            {% if lang_prefix == 'zh' %}返回列表{% else %}Back to list{% endif %}
                        </button>
                    </div>
                </header>
                <section class="market-detail-board" data-role="market-detail">
                    <header class="market-detail-head">
                        <div>
                            <p class="market-detail-kicker">{% if lang_prefix == 'zh' %}行情焦点{% else %}Market Focus{% endif %}</p>
                            <h2 class="market-detail-title" data-role="detail-title">
                                {% if lang_prefix == 'zh' %}请选择标的{% else %}Select a symbol{% endif %}
                            </h2>
                            <p class="market-detail-subtitle" data-role="detail-subtitle">
                                {% if lang_prefix == 'zh' %}点击榜单卡片即可在此展示图表与指标。{% else %}Click a card to render the chart and indicators here.{% endif %}
                            </p>
                        </div>
                        <div class="market-detail-meta">
                            <span class="detail-meta-item" data-role="detail-source"></span>
                            <span class="detail-meta-item" data-role="detail-updated"></span>
                        </div>
                    </header>
                    <div class="market-detail-controls">
                        <div class="market-detail-controls-row">
                            <div class="detail-quick-block">
                                <span class="detail-quick-label">{% if lang_prefix == 'zh' %}快捷周期{% else %}Quick range{% endif %}</span>
                                <div class="detail-quick-buttons">
                                    <button type="button" class="detail-timeframe detail-timeframe--quick is-active" data-range="1d">1D</button>
                                    <button type="button" class="detail-timeframe detail-timeframe--quick" data-range="5d">5D</button>
                                    <button type="button" class="detail-timeframe detail-timeframe--quick" data-range="1mo">1M</button>
                                    <button type="button" class="detail-timeframe detail-timeframe--quick" data-range="6mo">6M</button>
                                </div>
                            </div>
                            <div class="detail-interval-picker" data-role="detail-interval">
                                <span class="detail-interval-label">{% if lang_prefix == 'zh' %}时间粒度{% else %}Interval{% endif %}</span>
                                <button type="button" class="detail-interval-trigger" data-role="detail-interval-trigger" aria-haspopup="listbox" aria-expanded="false">
                                    <span data-role="detail-interval-current">1m</span>
                                    <span class="detail-interval-caret">▾</span>
                                </button>
                                <div class="detail-interval-menu" data-role="detail-interval-menu" hidden>
                                    <div class="detail-interval-top">
                                        <button type="button" class="detail-interval-custom-toggle" data-role="detail-interval-custom-toggle">
                                            {% if lang_prefix == 'zh' %}添加自定义粒度…{% else %}Add custom interval…{% endif %}
                                        </button>
                                        <div class="detail-interval-custom" data-role="detail-interval-custom-panel" hidden>
                                            <input type="number" min="1" max="10000" step="1" inputmode="numeric" data-role="detail-interval-custom-value" placeholder="{% if lang_prefix == 'zh' %}数值{% else %}Value{% endif %}">
                                            <select data-role="detail-interval-custom-unit">
                                                <option value="t">{% if lang_prefix == 'zh' %}逐笔{% else %}Ticks{% endif %}</option>
                                                <option value="s">{% if lang_prefix == 'zh' %}秒{% else %}Seconds{% endif %}</option>
                                                <option value="m" selected>{% if lang_prefix == 'zh' %}分钟{% else %}Minutes{% endif %}</option>
                                                <option value="h">{% if lang_prefix == 'zh' %}小时{% else %}Hours{% endif %}</option>
                                                <option value="d">{% if lang_prefix == 'zh' %}天{% else %}Days{% endif %}</option>
                                            </select>
                                            <button type="button" class="detail-interval-custom-apply" data-role="detail-interval-custom-apply">
                                                {% if lang_prefix == 'zh' %}添加并应用{% else %}Add & apply{% endif %}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="detail-interval-favorites" data-role="detail-interval-favorites" hidden>
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}收藏{% else %}Favorites{% endif %}</p>
                                        <div class="detail-interval-items" data-role="detail-interval-favorites-list"></div>
                                    </div>
                                    <div class="detail-interval-group" data-group="ticks">
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}逐笔{% else %}Ticks{% endif %}</p>
                                        <div class="detail-interval-items">
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1t">{% if lang_prefix == 'zh' %}1笔{% else %}1 tick{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1t" aria-label="favorite 1t">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="10t">{% if lang_prefix == 'zh' %}10笔{% else %}10 ticks{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="10t" aria-label="favorite 10t">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="100t">{% if lang_prefix == 'zh' %}100笔{% else %}100 ticks{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="100t" aria-label="favorite 100t">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1000t">{% if lang_prefix == 'zh' %}1000笔{% else %}1000 ticks{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1000t" aria-label="favorite 1000t">☆</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="detail-interval-group" data-group="seconds">
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}秒{% else %}Seconds{% endif %}</p>
                                        <div class="detail-interval-items">
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1s">{% if lang_prefix == 'zh' %}1秒{% else %}1s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1s" aria-label="favorite 1s">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="5s">{% if lang_prefix == 'zh' %}5秒{% else %}5s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="5s" aria-label="favorite 5s">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="10s">{% if lang_prefix == 'zh' %}10秒{% else %}10s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="10s" aria-label="favorite 10s">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="15s">{% if lang_prefix == 'zh' %}15秒{% else %}15s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="15s" aria-label="favorite 15s">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="30s">{% if lang_prefix == 'zh' %}30秒{% else %}30s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="30s" aria-label="favorite 30s">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="45s">{% if lang_prefix == 'zh' %}45秒{% else %}45s{% endif %}</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="45s" aria-label="favorite 45s">☆</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="detail-interval-group" data-group="minutes">
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}分钟{% else %}Minutes{% endif %}</p>
                                        <div class="detail-interval-items">
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1m">1m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1m" aria-label="favorite 1m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="2m">2m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="2m" aria-label="favorite 2m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="3m">3m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="3m" aria-label="favorite 3m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="5m">5m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="5m" aria-label="favorite 5m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="10m">10m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="10m" aria-label="favorite 10m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="15m">15m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="15m" aria-label="favorite 15m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="30m">30m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="30m" aria-label="favorite 30m">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="45m">45m</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="45m" aria-label="favorite 45m">☆</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="detail-interval-group" data-group="hours">
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}小时{% else %}Hours{% endif %}</p>
                                        <div class="detail-interval-items">
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1h">1h</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1h" aria-label="favorite 1h">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="2h">2h</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="2h" aria-label="favorite 2h">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="4h">4h</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="4h" aria-label="favorite 4h">☆</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="detail-interval-group" data-group="days">
                                        <p class="detail-interval-label">{% if lang_prefix == 'zh' %}天{% else %}Days{% endif %}</p>
                                        <div class="detail-interval-items">
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="1d">1D</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="1d" aria-label="favorite 1d">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="2d">2D</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="2d" aria-label="favorite 2d">☆</button>
                                            </div>
                                            <div class="detail-interval-option">
                                                <button type="button" class="detail-interval-select" data-role="detail-interval-select" data-interval="5d">5D</button>
                                                <button type="button" class="detail-interval-fav" data-role="detail-interval-fav" data-interval="5d" aria-label="favorite 5d">☆</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="market-detail-indicators">
                                <div class="indicator-group">
                                    <label for="detail-overlay-select">{% if lang_prefix == 'zh' %}叠加{% else %}Overlay{% endif %}</label>
                                    <select id="detail-overlay-select">
                                        <option value="none">{% if lang_prefix == 'zh' %}无{% else %}None{% endif %}</option>
                                        <option value="sma">SMA 20</option>
                                        <option value="ema">EMA 20</option>
                                        <option value="bbands">Bollinger 20</option>
                                    </select>
                                </div>
                                <div class="indicator-group">
                                    <label for="detail-indicator-select">{% if lang_prefix == 'zh' %}指标{% else %}Indicator{% endif %}</label>
                                    <select id="detail-indicator-select">
                                        <option value="none">{% if lang_prefix == 'zh' %}无{% else %}None{% endif %}</option>
                                        <option value="rsi">RSI</option>
                                        <option value="macd">MACD</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="detail-advanced-toggle" data-role="detail-advanced-toggle" aria-expanded="false">
                                {% if lang_prefix == 'zh' %}高级工具{% else %}Advanced{% endif %}
                            </button>
                        </div>
                        <div class="market-detail-advanced" data-role="detail-advanced-panel" hidden>
                            <div class="indicator-group indicator-group--draw">
                                <span class="indicator-label">{% if lang_prefix == 'zh' %}绘制{% else %}Draw{% endif %}</span>
                                <div class="draw-actions">
                                    <button type="button" class="draw-btn" data-draw="line">{% if lang_prefix == 'zh' %}直线{% else %}Line{% endif %}</button>
                                    <button type="button" class="draw-btn" data-draw="rect">{% if lang_prefix == 'zh' %}矩形{% else %}Rectangle{% endif %}</button>
                                    <button type="button" class="draw-btn" data-draw="clear">{% if lang_prefix == 'zh' %}清空{% else %}Clear{% endif %}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="market-detail-chart-stack">
                        <div class="market-detail-chart" id="market-detail-chart"></div>
                        <div class="market-detail-indicator" id="market-detail-indicator" hidden></div>
                    </div>
                    <div class="market-detail-status" data-role="detail-status" hidden></div>
                </section>
            </section>
        </div>
    </section>

    <template id="market-card-template">
        <article class="market-card">
            <header class="market-card-head">
                <div class="market-meta">
                    <a class="market-symbol" target="_blank" rel="noopener"></a>
                    <span class="market-price" data-role="price"></span>
                </div>
                <div class="market-change-group">
                    <span class="market-metric">
                        <span class="metric-label" data-role="primary-label">
                            {% if lang_prefix == 'zh' %}{{ default_timeframe.label }}{% else %}{{ default_timeframe.label_en }}{% endif %}
                        </span>
                        <span class="metric-value" data-role="primary-change"></span>
                    </span>
                    <span class="market-metric">
                        <span class="metric-label">{% if lang_prefix == 'zh' %}1日{% else %}1D{% endif %}</span>
                        <span class="metric-value subtle" data-role="day-change"></span>
                    </span>
                </div>
            </header>
            <div class="market-card-chart">
                <canvas width="180" height="48"></canvas>
                <span class="market-chart-window" data-role="window-label">
                    {% if lang_prefix == 'zh' %}{{ default_timeframe.label }}{% else %}{{ default_timeframe.label_en }}{% endif %}
                </span>
            </div>
            <footer class="market-card-foot">
                <span class="market-updated" data-role="updated"></span>
                <a class="market-backtest" data-role="backtest-link" href="#">
                    {% if lang_prefix == 'zh' %}一键回测{% else %}Quick backtest{% endif %}
                </a>
            </footer>
        </article>
    </template>
    <template id="market-card-skeleton">
        <article class="market-card market-card--skeleton" aria-hidden="true">
            <header class="market-card-head">
                <div class="market-meta">
                    <span class="skeleton-line skeleton-line--md"></span>
                </div>
                <div class="market-change-group">
                    <span class="market-metric">
                        <span class="skeleton-line skeleton-line--sm"></span>
                    </span>
                    <span class="market-metric">
                        <span class="skeleton-line skeleton-line--xs"></span>
                    </span>
                </div>
            </header>
            <div class="market-card-chart">
                <div class="skeleton-block"></div>
            </div>
            <footer class="market-card-foot">
                <span class="skeleton-line skeleton-line--xs"></span>
            </footer>
        </article>
    </template>
</div>
{% endwith %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js" nonce="{{ csp_nonce }}" defer></script>
<script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser.es6.js" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/market_insights_state.js' %}" nonce="{{ csp_nonce }}" defer></script>
<script src="{% static 'trading/js/market_insights.js' %}" nonce="{{ csp_nonce }}" defer></script>
{% endblock %}
