{% if posts %}
    {% for post in posts %}
    <article class="community-card community-post" data-post-id="{{ post.post_id }}">
        <header class="community-post-head">
            <div class="community-post-meta">
                <span class="community-post-avatar">
                    {% if post.avatar_url %}
                        <img src="{{ post.avatar_url }}" alt="{{ post.display_name }}" loading="lazy">
                    {% else %}
                        {{ post.display_name|first|upper }}
                    {% endif %}
                </span>
                <div class="community-post-info">
                    <div class="community-post-author">
                        {% if post.profile_slug %}
                            <a href="{% url 'trading:profile_public' post.profile_slug %}" class="community-profile-link">{{ post.display_name }}</a>
                        {% else %}
                            {{ post.display_name }}
                        {% endif %}
                        <a class="community-post-topic" href="?topic={{ post.topic_id }}">#{{ post.topic_name }}</a>
                    </div>
                    <div class="community-post-time text-muted small">
                        {{ post.created_at }}
                    </div>
                </div>
            </div>
        </header>
        <div class="community-post-body">
            {% if post.backtest_summary %}
            <div class="community-share-card is-inline">
                <div class="share-card-header">
                    <span class="badge bg-primary-subtle text-primary-emphasis">{% bilingual "Shared backtest" "回测分享" %}</span>
                    <span class="text-muted small">ID {{ post.backtest_summary.record_id }}</span>
                </div>
                <div class="share-card-body">
                    <div class="share-card-main">
                        <span class="share-card-ticker">{{ post.backtest_summary.ticker|default:"--" }}</span>
                        {% if post.backtest_summary.engine %}
                            <span class="share-card-engine">{{ post.backtest_summary.engine }}</span>
                        {% endif %}
                        <span class="share-card-period">{{ post.backtest_summary.start_date|default:"--" }} → {{ post.backtest_summary.end_date|default:"--" }}</span>
                    </div>
                    <div class="share-card-metrics">
                        <div><span>{% bilingual "Return" "收益" %}</span><strong>{{ post.backtest_summary.total_return }}</strong></div>
                        <div><span>{% bilingual "Sharpe" "夏普" %}</span><strong>{{ post.backtest_summary.sharpe }}</strong></div>
                        <div><span>{% bilingual "Max drawdown" "最大回撤" %}</span><strong>{{ post.backtest_summary.max_drawdown }}</strong></div>
                        <div><span>{% bilingual "Volatility" "波动率" %}</span><strong>{{ post.backtest_summary.volatility }}</strong></div>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="community-post-content">{{ post.content|safe }}</div>
            {% if post.image_url %}
                <figure class="community-post-image">
                    <img src="{{ post.image_url }}" alt="{% bilingual 'Shared image' '分享图片' %}" loading="lazy">
                </figure>
            {% endif %}
        </div>
        <footer class="community-post-footer">
            <div class="community-action-group">
                <button type="button"
                        class="community-action-btn{% if post.liked %} is-active{% endif %}"
                        data-role="like-button"
                        data-liked="{{ post.liked|yesno:'1,0' }}">
                    <span class="action-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12.1 20.4l-1.1-1.0C6 15 3 12.2 3 8.9 3 6.6 4.8 4.8 7.1 4.8c1.4 0 2.8 0.7 3.6 1.9 0.8-1.2 2.2-1.9 3.6-1.9 2.3 0 4.1 1.8 4.1 4.1 0 3.3-3 6.1-8 10.5l-1.1 1.0z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span class="action-label">{% bilingual "Like" "赞" %}</span>
                    <span class="action-count" data-role="like-count">{{ post.like_count }}</span>
                </button>
                <button type="button" class="community-action-btn" data-role="toggle-comments">
                    <span class="action-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M4.5 6.5h15a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H9l-4.5 3v-3H4.5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span class="action-label">{% bilingual "Comment" "评论" %}</span>
                    <span class="action-count" data-role="comment-count">{{ post.comment_count }}</span>
                </button>
            </div>
            {% if post.can_delete %}
                <div class="community-post-actions">
                    <form method="post"
                          action="{% url 'trading:community_delete' %}"
                          class="community-delete-form"
                          data-role="delete-form"
                          data-confirm="{% bilingual 'Are you sure you want to delete this post? This action cannot be undone.' '确定删除该帖子？该操作不可撤销。' %}">
                        {% csrf_token %}
                        <input type="hidden" name="post_id" value="{{ post.post_id }}">
                        <input type="hidden" name="topic" value="{{ post.topic_id }}">
                        <button type="submit"
                                class="btn btn-outline-danger btn-sm rounded-pill community-delete-btn"
                                data-role="delete-button"
                                aria-label="{% bilingual 'Delete this post' '删除这条帖子' %}">
                            <span class="community-delete-icon" aria-hidden="true">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M9 10v7m3-7v7m3-7v7M5 6h14M9.5 4h5l1 2H8.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                            <span class="visually-hidden">{% bilingual "Delete" "删除" %}</span>
                        </button>
                    </form>
                </div>
            {% endif %}
        </footer>
        <section class="community-comments d-none" data-role="comments">
            <div class="community-comment-create">
                <span class="community-post-avatar small">
                    {% if avatar_url %}
                        <img src="{{ avatar_url }}" alt="{{ display_name }}" loading="lazy">
                    {% else %}
                        {{ display_name|first|upper }}
                    {% endif %}
                </span>
                <div class="community-comment-form">
                    <textarea rows="2" class="form-control" placeholder="{% bilingual 'Share your thoughts…' '留下你的看法…' %}" data-role="comment-input"></textarea>
                    <div class="text-end mt-2">
                        <button type="button" class="btn btn-sm btn-primary" data-role="submit-comment">{% bilingual "Post comment" "发布评论" %}</button>
                    </div>
                </div>
            </div>
            <ul class="community-comment-list">
                {% for comment in post.comments %}
                <li class="community-comment-item">
                    <span class="community-post-avatar small">
                        {% if comment.avatar_url %}
                            <img src="{{ comment.avatar_url }}" alt="{{ comment.author }}" loading="lazy">
                        {% else %}
                            {{ comment.author|first|upper }}
                        {% endif %}
                    </span>
                    <div class="community-comment-body">
                        <div class="community-comment-meta">
                            <span class="community-comment-author">{{ comment.author }}</span>
                            <span class="community-comment-time text-muted small">{{ comment.created_at }}</span>
                        </div>
                        <p>{{ comment.content|linebreaksbr }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </section>
    </article>
    {% endfor %}
{% else %}
    {% if show_empty_message %}
        <div class="community-empty">
            {% bilingual "No posts yet—be the first to share!" "还没有动态，率先分享你的第一条吧！" %}
        </div>
    {% endif %}
{% endif %}

{% if is_htmx %}
    <div id="community-post-trigger"
         hx-swap-oob="true"
         class="community-load-trigger invisible{% if not next_page_url %} d-none{% endif %}"
         {% if next_page_url %}
             hx-get="{{ next_page_url }}"
             hx-trigger="revealed"
             hx-target="#community-post-list"
             hx-swap="beforeend"
         {% endif %}
         aria-hidden="true"
         style="height: 1px;"></div>
{% endif %}
