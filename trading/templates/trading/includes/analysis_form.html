{% load django_bootstrap5 i18n i18n_extras %}
<div class="card shadow-sm border-0 mb-4" id="analysis-form-card">
    <div class="card-body">
        {% with lang_prefix=request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
        <div class="backtest-section-head mb-4">
            <h2 class="h4 mb-2">
                {% if lang_prefix == 'zh' %}æ——èˆ°ç­–ç•¥ä¸€é”®å›æµ‹{% else %}Flagship Strategy Â· One-click Backtest{% endif %}
            </h2>
            <p class="text-muted mb-0">
                {% if lang_prefix == 'zh' %}
                    ä»…éœ€è¾“å…¥æ ‡çš„ä¸æ—¶é—´åŒºé—´ï¼Œç³»ç»Ÿå°†ä»¥æ——èˆ°é‡åŒ–é…ç½®ã€AI æ´å¯Ÿä¸é«˜çº§é£é™©æ§åˆ¶è‡ªåŠ¨å®Œæˆå›æµ‹ã€‚
                {% else %}
                    Provide the ticker and horizon; the flagship config, AI insights, and risk stack will run automatically.
                {% endif %}
            </p>
        </div>
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
            </div>
        {% endif %}
        {% if warnings %}
            <div class="alert alert-warning">
                {% for warn in warnings %}<div>{{ warn }}</div>{% endfor %}
            </div>
        {% endif %}
        <form
            method="post"
            novalidate
            id="analysis-form"
            data-task-endpoint="{% url 'trading:api_v1_backtest_tasks' %}"
            data-task-status-template="{% url 'trading:api_v1_task_status' task_id='TASK_ID_PLACEHOLDER' %}"
            data-history-base="{% url 'trading:backtest' %}"
            data-lang="{{ request.LANGUAGE_CODE|default:'zh-hans' }}"
        >
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.ticker.id_for_label }}">
                        {% if lang_prefix == 'zh' %}ä¸»è¦æ ‡çš„ä»£ç {% else %}Primary ticker{% endif %}
                    </label>
                    {{ form.ticker }}
                    <div class="form-text">
                        {% if lang_prefix == 'zh' %}
                            æ”¯æŒ Yahoo Finance ä»£ç ï¼Œä¾‹å¦‚ NVDAã€AAPLã€600519.SSã€‚
                        {% else %}
                            Accepts Yahoo Finance symbols, e.g., NVDA, AAPL, 600519.SS.
                        {% endif %}
                    </div>
                    {% if form.ticker.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.ticker.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.benchmark_ticker.id_for_label }}">
                        {% if lang_prefix == 'zh' %}å¯¹æ¯”åŸºå‡†ï¼ˆå¯é€‰ï¼‰{% else %}Benchmark (optional){% endif %}
                    </label>
                    {{ form.benchmark_ticker }}
                    <div class="form-text">
                        {% if lang_prefix == 'zh' %}
                            é»˜è®¤å¯¹æ¯” SPYï¼Œè‹¥ä¸“æ³¨å•ä¸€èµ„äº§å¯ç•™ç©ºã€‚
                        {% else %}
                            Defaults to SPY. Leave blank for single-asset focus.
                        {% endif %}
                    </div>
                    {% if form.benchmark_ticker.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.benchmark_ticker.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.start_date.id_for_label }}">
                        {% if lang_prefix == 'zh' %}å¼€å§‹æ—¥æœŸ{% else %}Start date{% endif %}
                    </label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.start_date.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.end_date.id_for_label }}">
                        {% if lang_prefix == 'zh' %}ç»“æŸæ—¥æœŸ{% else %}End date{% endif %}
                    </label>
                    {{ form.end_date }}
                    {% if form.end_date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.end_date.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.capital.id_for_label }}">
                        {% if lang_prefix == 'zh' %}æ¨¡æ‹Ÿèµ„é‡‘è§„æ¨¡{% else %}Capital base{% endif %}
                    </label>
                    {{ form.capital }}
                    <div class="form-text">
                        {% if lang_prefix == 'zh' %}
                            ç”¨äºèµ„äº§é…ç½®å»ºæ¨¡ï¼Œé»˜è®¤ 250,000ã€‚
                        {% else %}
                            Used for allocation modeling. Default 250,000.
                        {% endif %}
                    </div>
                    {% if form.capital.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.capital.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" for="{{ form.ml_mode.id_for_label }}">
                        {% if lang_prefix == 'zh' %}æ¨¡å‹ç±»å‹{% else %}Model type{% endif %}
                    </label>
                    {{ form.ml_mode }}
                    <div class="form-text">
                        {% if lang_prefix == 'zh' %}
                            è½»é‡ GBDT å…¼å…·é€Ÿåº¦ä¸ç¨³å®šæ€§ï¼›æ·±åº¦æ¨¡å‹å¯æ•æ‰æ›´å¤šæ—¶åºæ¨¡å¼ï¼›Fusion ä¼šè‡ªåŠ¨èåˆ LSTM ä¸ Transformerã€‚
                        {% else %}
                            Light GBDT balances speed and stability; deep modes capture richer sequences. Fusion mixes LSTM with Transformer automatically.
                        {% endif %}
                    </div>
                    {% if form.ml_mode.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.ml_mode.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary btn-lg px-4">
                    <span class="me-1">ğŸ“Š</span>{% if lang_prefix == 'zh' %}ç”Ÿæˆé‡åŒ–æŠ¥å‘Š{% else %}Generate report{% endif %}
                </button>
            </div>
        </form>
        {% endwith %}
    </div>
</div>
