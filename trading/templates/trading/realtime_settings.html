{% extends "base.html" %}

{% block title %}{% bilingual "Realtime Settings" "实时引擎设置" %}{% endblock %}

{% block content %}
<div class="realtime-settings-page">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
            <p class="text-uppercase text-muted small fw-semibold mb-1">{% bilingual "Realtime Engine" "实时引擎" %}</p>
            <h1 class="h3 mb-2">{% bilingual "Profile Settings" "配置档案" %}</h1>
            <p class="text-muted mb-0">{% bilingual "Create or edit realtime profiles and mark one as active for the engine." "创建或编辑实时引擎配置，并指定激活档案。" %}</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'trading:realtime_monitor' %}">{% bilingual "Open monitor" "打开监控台" %}</a>
            <a class="btn btn-primary btn-sm" href="{% url 'trading:realtime_settings' %}?profile=new">{% bilingual "New profile" "新建档案" %}</a>
        </div>
    </div>

    {% if success_message %}
        <div class="alert alert-success">{{ success_message }}</div>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger">{{ error_message }}</div>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">{% bilingual "Profiles" "现有档案" %}</h2>
                            <p class="text-muted small mb-0">{% bilingual "Pick a profile to edit or activate." "选择档案进行编辑或激活。" %}</p>
                        </div>
                    </div>
                    {% if profiles %}
                        <div class="list-group">
                            {% for profile in profiles %}
                                <div class="list-group-item d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <strong>{{ profile.name }}</strong>
                                            {% if profile.is_active %}
                                                <span class="badge bg-success-subtle text-success-emphasis ms-1">{% bilingual "Active" "已激活" %}</span>
                                            {% endif %}
                                        </div>
                                        <a class="btn btn-link btn-sm p-0" href="{% url 'trading:realtime_settings' %}?profile={{ profile.profile_id }}">{% bilingual "Edit" "编辑" %}</a>
                                    </div>
                                    {% if profile.description %}
                                        <div class="text-muted small">{{ profile.description }}</div>
                                    {% endif %}
                                    <div class="d-flex gap-2">
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="activate">
                                            <input type="hidden" name="profile_id" value="{{ profile.profile_id }}">
                                            <button type="submit" class="btn btn-outline-primary btn-sm">{% bilingual "Activate" "设为激活" %}</button>
                                        </form>
                                        <form method="post" onsubmit="return confirm('{% bilingual "Delete this profile?" "确定删除该档案？" %}');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete">
                                            <input type="hidden" name="profile_id" value="{{ profile.profile_id }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">{% bilingual "Delete" "删除" %}</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">{% bilingual "No profiles yet. Create one to begin." "暂无档案，点击右上角新建一个。" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">
                                {% if selected_profile %}
                                    {% bilingual "Edit profile" "编辑档案" %}: {{ selected_profile.name }}
                                {% else %}
                                    {% bilingual "Create profile" "新建档案" %}
                                {% endif %}
                            </h2>
                            <p class="text-muted small mb-0">{% bilingual "Paste JSON payload for universe/focus/engine/trading config." "粘贴 JSON 以配置 Universe/Focus/Engine/Trading 参数。" %}</p>
                        </div>
                        {% if active_profile %}
                            <span class="badge bg-light text-dark">{% bilingual "Active" "当前激活" %}: {{ active_profile.name }}</span>
                        {% endif %}
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save">
                        <input type="hidden" name="profile_id" value="{{ selected_profile.profile_id }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{% bilingual "Profile name" "档案名称" %}</label>
                                <input type="text" class="form-control" name="name" value="{{ selected_profile.name|default_if_none:'' }}" placeholder="{% bilingual 'e.g. Focus200 default' '例如 Focus200 默认' %}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{% bilingual "Description" "描述" %}</label>
                                <input type="text" class="form-control" name="description" value="{{ selected_profile.description|default_if_none:'' }}" placeholder="{% bilingual 'Optional' '可选' %}">
                            </div>
                            <div class="col-12">
                                <label class="form-label">{% bilingual "Payload (JSON)" "配置 JSON" %}</label>
                                <textarea class="form-control font-monospace" name="payload" rows="16">{{ payload_text }}</textarea>
                            </div>
                            <div class="col-12 d-flex align-items-center gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="profile-active" name="is_active" {% if selected_profile and selected_profile.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="profile-active">{% bilingual "Set active after saving" "保存后设为激活" %}</label>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">{% bilingual "Save profile" "保存档案" %}</button>
                            <a class="btn btn-outline-secondary" href="{% url 'trading:realtime_settings' %}">{% bilingual "Reset" "重置" %}</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
