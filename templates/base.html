{% load static django_bootstrap5 i18n %}
<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE|default:'zh-hans' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{% bilingual "Quant Trading Simulator" "量化交易模拟器" %}{% endblock %}</title>
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link rel="stylesheet" href="{% static 'trading/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'trading/css/global_quick_widget.css' %}?v={{ STATIC_VERSION|default:'20260206-gqw-v2' }}">
    {% block extra_head %}{% endblock %}
    <link rel="stylesheet" href="{% static 'trading/css/clean_theme.css' %}?v={{ STATIC_VERSION|default:'20260211-clean-theme-v7' }}">
    {% block extra_head_after_theme %}{% endblock %}
</head>
<body class="bg-light"
      data-task-status-template="{% url 'trading:api_v1_task_status' task_id='TASK_ID_PLACEHOLDER' %}"
      data-task-history-base="{% url 'trading:backtest' %}"
      data-task-cancel-template="{% url 'trading:api_v1_task_cancel' task_id='TASK_ID_PLACEHOLDER' %}">
    <nav class="navbar navbar-expand-lg navbar-dark om-nav shadow-sm mb-4">
        <div class="container-xl">
            <a class="navbar-brand fw-semibold" href="{% url 'trading:backtest' %}">{% bilingual "Quant Trading Simulator" "量化交易模拟器" %}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切换导航">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'backtest' %} active{% endif %}" href="{% url 'trading:backtest' %}">{% bilingual "Strategy Backtest" "策略回测" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'market_insights' %} active{% endif %}" href="{% url 'trading:market_insights' %}">{% bilingual "Market Insights" "股市信息" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'community' %} active{% endif %}" href="{% url 'trading:community' %}">{% bilingual "Community" "社区广场" %}</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'account' %} active{% endif %}" href="{% url 'trading:account' %}">{% bilingual "Account" "账户中心" %}</a>
                        </li>
                    {% endif %}
                </ul>
                <div class="nav-actions">
                    <form action="{% url 'set_language' %}" method="post" class="nav-lang-switcher">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <div class="nav-lang-pill" role="group" aria-label="{% bilingual 'Language switch' '语言切换' %}">
                            <button type="submit" name="language" value="zh-hans" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'zh-hans' %} is-active{% endif %}">
                                {% bilingual "中文" "中文" %}
                            </button>
                            <button type="submit" name="language" value="en" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'en' %} is-active{% endif %}">
                                {% bilingual "English" "English" %}
                            </button>
                        </div>
                    </form>
                    {% if user.is_authenticated %}
                        <div class="nav-monitor-group" data-role="nav-monitor-group">
                            <div class="nav-api-menu"
                                 data-api-menu
                                 data-url="{% url 'trading:api_v1_api_usage' %}"
                                 data-lang="{{ request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:':2' }}">
                                <button type="button"
                                        class="nav-api-toggle"
                                        data-api-toggle
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        title="{% bilingual 'External market API usage details' '外部行情 API 使用详情' %}">
                                    <span class="nav-api-dot" aria-hidden="true"></span>
                                    <span class="nav-api-title">{% bilingual "API" "API" %}</span>
                                    <span class="nav-api-count" data-role="nav-api-usage-value">--</span>
                                    <span class="nav-api-caret" aria-hidden="true">▾</span>
                                </button>
                                <div class="nav-api-dropdown" data-api-panel hidden>
                                    <div class="nav-api-head">{% bilingual "Last 1 min usage" "最近1分钟使用" %}</div>
                                    <div class="nav-api-row">
                                        <span class="nav-api-key">{% bilingual "Total" "总调用" %}</span>
                                        <span class="nav-api-val" data-role="nav-api-total">--</span>
                                    </div>
                                    <div class="nav-api-row">
                                        <span class="nav-api-key">Massive</span>
                                        <span class="nav-api-val" data-role="nav-api-massive">--</span>
                                    </div>
                                    <div class="nav-api-row">
                                        <span class="nav-api-key">Alpaca</span>
                                        <span class="nav-api-val" data-role="nav-api-alpaca">--</span>
                                    </div>
                                    <div class="nav-api-row">
                                        <span class="nav-api-key">{% bilingual "Status" "状态" %}</span>
                                        <span class="nav-api-val" data-role="nav-api-level">--</span>
                                    </div>
                                    <div class="nav-api-foot" data-role="nav-api-updated">{% bilingual "Updating..." "更新中..." %}</div>
                                </div>
                            </div>
                            <div class="nav-api-menu nav-observer-menu"
                                 data-observer-menu
                                 data-url="{% url 'trading:market_rankings_status' %}"
                                 data-lang="{{ request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:':2' }}">
                                <button type="button"
                                        class="nav-api-toggle"
                                        data-observer-toggle
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        title="{% bilingual 'Leaderboard status observer' '榜单状态观察' %}">
                                    <span class="nav-api-dot" aria-hidden="true"></span>
                                    <span class="nav-api-title">{% bilingual "Observe" "观察" %}</span>
                                    <span class="nav-api-count" data-role="nav-observer-count">--</span>
                                    <span class="nav-api-caret" aria-hidden="true">▾</span>
                                </button>
                                <div class="nav-api-dropdown nav-observer-dropdown" data-observer-panel hidden>
                                    <div class="nav-api-head">{% bilingual "Leaderboard status" "榜单状态" %}</div>
                                    <div class="nav-observer-summary" data-role="nav-observer-summary">
                                        {% bilingual "Loading..." "加载中..." %}
                                    </div>
                                    <div class="nav-observer-list" data-role="nav-observer-list"></div>
                                </div>
                            </div>
                        </div>
                        <a class="nav-icon-button nav-notification"
                           href="{% url 'trading:community_notifications' %}"
                           aria-label="{% bilingual 'Notifications' '通知中心' %}"
                           title="{% bilingual 'Notifications' '通知中心' %}">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2z"/>
                                <path d="M8 1a5 5 0 0 0-5 5v2.086l-.707.707A1 1 0 0 0 3 10h10a1 1 0 0 0 .707-1.707L13 8.086V6a5 5 0 0 0-5-5z"/>
                            </svg>
                            {% if unread_notifications_count > 0 %}
                                <span class="nav-notification-badge">{{ unread_notifications_count }}</span>
                            {% endif %}
                        </a>
                        <span class="nav-greeting">{% bilingual "Welcome," "欢迎，" %}{{ user.username }}</span>
                        <div class="nav-user-menu" data-user-menu>
                            <button type="button" class="nav-user-toggle" data-menu-toggle aria-haspopup="true" aria-expanded="false">
                                <span class="nav-user-avatar">{{ user.username|first|upper }}</span>
                                <span class="nav-user-name">{{ user.username }}</span>
                                <span class="nav-user-caret">▾</span>
                            </button>
                            <div class="nav-user-dropdown" data-menu-panel hidden>
                                <a href="{% url 'trading:account' %}">{% bilingual "Account Center" "账户中心" %}</a>
                                <a class="is-danger" href="{% url 'logout' %}">{% bilingual "Sign out" "退出登录" %}</a>
                            </div>
                        </div>
                    {% else %}
                        <a class="btn btn-sm btn-outline-light" href="{% url 'login' %}">{% bilingual "Sign in" "登录" %}</a>
                        <a class="btn btn-sm btn-light" href="{% url 'trading:signup' %}">{% bilingual "Sign up" "注册" %}</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
{% with lang_prefix=request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
    <script id="command-palette-data" type="application/json">
    [
        {
            "id": "backtest",
            "label": "{% if lang_prefix == 'zh' %}{{ "开始回测"|escapejs }}{% else %}{{ "Start Backtest"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "进入旗舰策略实验室"|escapejs }}{% else %}{{ "Open flagship strategy lab"|escapejs }}{% endif %}",
            "shortcut": "B",
            "type": "route",
            "href": "{% url 'trading:backtest' %}"
        },
        {
            "id": "market",
            "label": "{% if lang_prefix == 'zh' %}{{ "股市信息"|escapejs }}{% else %}{{ "Market Insights"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "快速查看涨跌榜"|escapejs }}{% else %}{{ "Watch gainers/decliners dashboard"|escapejs }}{% endif %}",
            "shortcut": "M",
            "type": "route",
            "href": "{% url 'trading:market_insights' %}"
        },
        {
            "id": "community",
            "label": "{% if lang_prefix == 'zh' %}{{ "社区广场"|escapejs }}{% else %}{{ "Community Hub"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "与社区分享灵感"|escapejs }}{% else %}{{ "Share insights with peers"|escapejs }}{% endif %}",
            "shortcut": "C",
            "type": "route",
            "href": "{% url 'trading:community' %}"
        }{% if user.is_authenticated %},
        {
            "id": "account",
            "label": "{% if lang_prefix == 'zh' %}{{ "账户中心"|escapejs }}{% else %}{{ "Account Center"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "管理资料与历史记录"|escapejs }}{% else %}{{ "Profile, history & exports"|escapejs }}{% endif %}",
            "shortcut": "A",
            "type": "route",
            "href": "{% url 'trading:account' %}"
        }{% endif %}
    ]
    </script>
{% endwith %}
    <div id="command-palette" class="command-palette" aria-hidden="true" hidden>
        <div class="command-palette__backdrop" data-role="palette-dismiss"></div>
        <div class="command-palette__panel" role="dialog" aria-modal="true" aria-labelledby="command-palette-title">
            <header class="command-palette__head">
                <div class="command-palette__title">
                    <span id="command-palette-title">{% bilingual "Command Palette" "命令面板" %}</span>
                </div>
                <div class="command-palette__input-wrap">
                    <input type="text"
                           class="command-palette__input"
                           placeholder="{% bilingual 'Search commands or destinations…' '搜索命令或目标…' %}"
                           autocomplete="off"
                           data-role="palette-input">
                </div>
            </header>
            <div class="command-palette__body">
                <ul class="command-palette__list" data-role="palette-list"></ul>
                <div class="command-palette__empty hidden" data-role="palette-empty">
                    {% bilingual "No matching actions." "没有匹配的操作。" %}
                </div>
            </div>
            <footer class="command-palette__footer">
                <span>{% bilingual "Enter to execute" "回车执行" %}</span>
                <span>{% bilingual "Esc to exit" "Esc 退出" %}</span>
                <span>{% bilingual "↑ ↓ to navigate" "↑ ↓ 选择" %}</span>
            </footer>
        </div>
    </div>
    <button id="task-fab"
            class="task-fab"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#task-center"
            aria-controls="task-center"
            aria-label="{% bilingual 'Backtest tasks' '回测任务' %}"
            hidden>
        <span class="task-fab-icon">TASK</span>
        <span id="task-fab-count" class="task-fab-badge" hidden>0</span>
        <span id="task-fab-spinner" class="task-fab-spinner" hidden></span>
    </button>
    <div class="offcanvas offcanvas-end task-center"
         tabindex="-1"
         id="task-center"
         aria-labelledby="task-center-title">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="task-center-title">{% bilingual "Backtest Tasks" "回测任务" %}</h5>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="task-center-clear">
                    {% bilingual "Clear" "清空" %}
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% bilingual 'Close' '关闭' %}"></button>
            </div>
        </div>
        <div class="offcanvas-body">
            <div id="task-center-body"></div>
        </div>
    </div>
    <div id="task-toast-container"></div>
    <div id="global-quick-widget"
         class="global-quick-widget is-collapsed"
         data-market-url="{% url 'trading:market_insights' %}"
         data-lang="{{ request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:':2' }}"
         aria-live="polite">
        <button type="button"
                class="gqw-launch"
                data-role="gqw-toggle"
                aria-expanded="false"
                aria-controls="gqw-panel">
            <span class="gqw-launch-icon">★</span>
            <span class="gqw-launch-text">{% bilingual "Watch & Recent" "自选与最近" %}</span>
        </button>
        <section id="gqw-panel"
                 class="gqw-panel"
                 role="dialog"
                 aria-label="{% bilingual 'Watchlist quick window' '自选最近悬浮窗' %}"
                 hidden>
            <header class="gqw-header" data-role="gqw-drag-handle">
                <h3>{% bilingual "Watch & Recent" "自选与最近" %}</h3>
                <button type="button"
                        class="gqw-minify"
                        data-role="gqw-toggle"
                        aria-label="{% bilingual 'Minimize window' '缩小窗口' %}">
                    <span aria-hidden="true">⤢</span>
                </button>
            </header>
            <div class="gqw-tabs" role="tablist" aria-label="{% bilingual 'Quick tabs' '快速标签' %}">
                <button type="button"
                        class="gqw-tab is-active"
                        data-role="gqw-tab"
                        data-target="watchlist"
                        role="tab"
                        aria-selected="true">
                    {% bilingual "Watchlist" "自选" %}
                    <span class="gqw-count" data-role="gqw-watch-count">0</span>
                </button>
                <button type="button"
                        class="gqw-tab"
                        data-role="gqw-tab"
                        data-target="recent"
                        role="tab"
                        aria-selected="false">
                    {% bilingual "Recent" "最近" %}
                    <span class="gqw-count" data-role="gqw-recent-count">0</span>
                </button>
            </div>
            <div class="gqw-body">
                <div class="gqw-chip-flow" data-role="gqw-watch-panel"></div>
                <div class="gqw-chip-flow" data-role="gqw-recent-panel" hidden></div>
            </div>
            <form class="gqw-form" data-role="gqw-form">
                <input type="text"
                       class="gqw-input"
                       data-role="gqw-input"
                       placeholder="{% bilingual 'Ticker (e.g. NVDA)' '股票代码（如 NVDA）' %}"
                       autocomplete="off">
                <button type="submit" class="gqw-open-btn">{% bilingual "Open" "打开" %}</button>
            </form>
        </section>
    </div>

    <main class="container-xl pb-5">
        {% block content %}{% endblock %}
    </main>
    <script src="{% static 'trading/js/nav_controls.js' %}?v={{ STATIC_VERSION|default:'20260212-nav-v8' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/command_palette.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/task_dock.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/global_quick_widget.js' %}?v={{ STATIC_VERSION|default:'20260206-gqw-v2' }}" nonce="{{ csp_nonce }}" defer></script>
    {% block extra_scripts %}{% endblock %}
    <footer class="bg-white border-top py-4">
        <div class="container text-center text-muted small">
            {% bilingual "Crafted by Mingyang Dong." "本工具由董铭瑒开发。" %}
        </div>
    </footer>
</body>
</html>
