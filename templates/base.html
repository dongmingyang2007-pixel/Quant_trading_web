{% load static django_bootstrap5 i18n %}
<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE|default:'zh-hans' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{% bilingual "Quant Trading Simulator" "é‡åŒ–äº¤æ˜“æ¨¡æ‹Ÿå™¨" %}{% endblock %}</title>
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link rel="stylesheet" href="{% static 'trading/css/styles.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-light"
      data-task-status-template="{% url 'trading:api_v1_task_status' task_id='TASK_ID_PLACEHOLDER' %}"
      data-task-history-base="{% url 'trading:backtest' %}"
      data-task-cancel-template="{% url 'trading:api_v1_task_cancel' task_id='TASK_ID_PLACEHOLDER' %}">
    <nav class="navbar navbar-expand-lg navbar-dark om-nav shadow-sm mb-4">
        <div class="container-xl">
            <a class="navbar-brand fw-semibold" href="{% url 'trading:backtest' %}">{% bilingual "Quant Trading Simulator" "é‡åŒ–äº¤æ˜“æ¨¡æ‹Ÿå™¨" %}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆª">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'backtest' %} active{% endif %}" href="{% url 'trading:backtest' %}">{% bilingual "Strategy Backtest" "ç­–ç•¥å›æµ‹" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'market_insights' %} active{% endif %}" href="{% url 'trading:market_insights' %}">{% bilingual "Market Insights" "è‚¡å¸‚ä¿¡æ¯" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'screen_analyzer' %} active{% endif %}" href="{% url 'trading:screen_analyzer' %}">{% bilingual "Screen Analyzer" "å±å¹•æ³¢å‹" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'paper_trading' %} active{% endif %}" href="{% url 'trading:paper_trading' %}">{% bilingual "Paper Trading" "æ¨¡æ‹Ÿå®ç›˜" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'learning_center' %} active{% endif %}" href="{% url 'trading:learning_center' %}">{% bilingual "Learning Hub" "å­¦ä¹ ä¸­å¿ƒ" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'community' %} active{% endif %}" href="{% url 'trading:community' %}">{% bilingual "Community" "ç¤¾åŒºå¹¿åœº" %}</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'account' %} active{% endif %}" href="{% url 'trading:account' %}">{% bilingual "Account" "è´¦æˆ·ä¸­å¿ƒ" %}</a>
                        </li>
                    {% endif %}
                </ul>
                <div class="nav-actions">
                    <form action="{% url 'set_language' %}" method="post" class="nav-lang-switcher">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <div class="nav-lang-pill" role="group" aria-label="{% bilingual 'Language switch' 'è¯­è¨€åˆ‡æ¢' %}">
                            <button type="submit" name="language" value="zh-hans" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'zh-hans' %} is-active{% endif %}">
                                {% bilingual "ä¸­æ–‡" "ä¸­æ–‡" %}
                            </button>
                            <button type="submit" name="language" value="en" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'en' %} is-active{% endif %}">
                                {% bilingual "English" "English" %}
                            </button>
                        </div>
                    </form>
                    {% if user.is_authenticated %}
                        <span class="nav-greeting">{% bilingual "Welcome," "æ¬¢è¿ï¼Œ" %}{{ user.username }}</span>
                        <div class="nav-user-menu" data-user-menu>
                            <button type="button" class="nav-user-toggle" data-menu-toggle aria-haspopup="true" aria-expanded="false">
                                <span class="nav-user-avatar">{{ user.username|first|upper }}</span>
                                <span class="nav-user-name">{{ user.username }}</span>
                                <span class="nav-user-caret">â–¾</span>
                            </button>
                            <div class="nav-user-dropdown" data-menu-panel hidden>
                                <a href="{% url 'trading:account' %}">{% bilingual "Account Center" "è´¦æˆ·ä¸­å¿ƒ" %}</a>
                                <a class="is-danger" href="{% url 'logout' %}">{% bilingual "Sign out" "é€€å‡ºç™»å½•" %}</a>
                            </div>
                        </div>
                    {% else %}
                        <a class="btn btn-sm btn-outline-light" href="{% url 'login' %}">{% bilingual "Sign in" "ç™»å½•" %}</a>
                        <a class="btn btn-sm btn-light" href="{% url 'trading:signup' %}">{% bilingual "Sign up" "æ³¨å†Œ" %}</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
{% with lang_prefix=request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
    <script id="command-palette-data" type="application/json">
    [
        {
            "id": "backtest",
            "label": "{% if lang_prefix == 'zh' %}{{ "å¼€å§‹å›æµ‹"|escapejs }}{% else %}{{ "Start Backtest"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "è¿›å…¥æ——èˆ°ç­–ç•¥å®éªŒå®¤"|escapejs }}{% else %}{{ "Open flagship strategy lab"|escapejs }}{% endif %}",
            "shortcut": "B",
            "type": "route",
            "href": "{% url 'trading:backtest' %}"
        },
        {
            "id": "market",
            "label": "{% if lang_prefix == 'zh' %}{{ "è‚¡å¸‚ä¿¡æ¯"|escapejs }}{% else %}{{ "Market Insights"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "å¿«é€ŸæŸ¥çœ‹æ¶¨è·Œæ¦œ"|escapejs }}{% else %}{{ "Watch gainers/decliners dashboard"|escapejs }}{% endif %}",
            "shortcut": "M",
            "type": "route",
            "href": "{% url 'trading:market_insights' %}"
        },
        {
            "id": "screen-analyzer",
            "label": "{% if lang_prefix == 'zh' %}{{ "å±å¹•æ³¢å‹"|escapejs }}{% else %}{{ "Screen Analyzer"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "å±å¹•è§£ææ³¢å‹ä¸æ¦‚ç‡å›¾è°±"|escapejs }}{% else %}{{ "Analyze screen wave patterns"|escapejs }}{% endif %}",
            "shortcut": "S",
            "type": "route",
            "href": "{% url 'trading:screen_analyzer' %}"
        },
        {
            "id": "learning",
            "label": "{% if lang_prefix == 'zh' %}{{ "å­¦ä¹ ä¸­å¿ƒ"|escapejs }}{% else %}{{ "Learning Hub"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "ç»§ç»­å­¦ä¹ è¯¾ç¨‹"|escapejs }}{% else %}{{ "Continue structured lessons"|escapejs }}{% endif %}",
            "shortcut": "L",
            "type": "route",
            "href": "{% url 'trading:learning_center' %}"
        },
        {
            "id": "community",
            "label": "{% if lang_prefix == 'zh' %}{{ "ç¤¾åŒºå¹¿åœº"|escapejs }}{% else %}{{ "Community Hub"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "ä¸ç¤¾åŒºåˆ†äº«çµæ„Ÿ"|escapejs }}{% else %}{{ "Share insights with peers"|escapejs }}{% endif %}",
            "shortcut": "C",
            "type": "route",
            "href": "{% url 'trading:community' %}"
        }{% if user.is_authenticated %},
        {
            "id": "account",
            "label": "{% if lang_prefix == 'zh' %}{{ "è´¦æˆ·ä¸­å¿ƒ"|escapejs }}{% else %}{{ "Account Center"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "ç®¡ç†èµ„æ–™ä¸å†å²è®°å½•"|escapejs }}{% else %}{{ "Profile, history & exports"|escapejs }}{% endif %}",
            "shortcut": "A",
            "type": "route",
            "href": "{% url 'trading:account' %}"
        }{% endif %}
    ]
    </script>
{% endwith %}
    <div id="command-palette" class="command-palette" aria-hidden="true" hidden>
        <div class="command-palette__backdrop" data-role="palette-dismiss"></div>
        <div class="command-palette__panel" role="dialog" aria-modal="true" aria-labelledby="command-palette-title">
            <header class="command-palette__head">
                <div class="command-palette__title">
                    <span id="command-palette-title">{% bilingual "Command Palette" "å‘½ä»¤é¢æ¿" %}</span>
                </div>
                <div class="command-palette__input-wrap">
                    <input type="text"
                           class="command-palette__input"
                           placeholder="{% bilingual 'Search commands or destinationsâ€¦' 'æœç´¢å‘½ä»¤æˆ–ç›®æ ‡â€¦' %}"
                           autocomplete="off"
                           data-role="palette-input">
                </div>
            </header>
            <div class="command-palette__body">
                <ul class="command-palette__list" data-role="palette-list"></ul>
                <div class="command-palette__empty hidden" data-role="palette-empty">
                    {% bilingual "No matching actions." "æ²¡æœ‰åŒ¹é…çš„æ“ä½œã€‚" %}
                </div>
            </div>
            <footer class="command-palette__footer">
                <span>{% bilingual "Enter to execute" "å›è½¦æ‰§è¡Œ" %}</span>
                <span>{% bilingual "Esc to exit" "Esc é€€å‡º" %}</span>
                <span>{% bilingual "â†‘ â†“ to navigate" "â†‘ â†“ é€‰æ‹©" %}</span>
            </footer>
        </div>
    </div>
    <!-- å…¨å±€ä»»åŠ¡æ ï¼ˆå›ºå®šåœ¨å³ä¸‹ï¼Œä¸éšé¡µé¢åˆ‡æ¢æ¶ˆå¤±ï¼‰ -->
    <div id="task-dock" class="task-dock minimized shadow" aria-live="polite" aria-label="{% bilingual "Backtest tasks" "å›æµ‹ä»»åŠ¡" %}">
        <div id="task-dock-header" class="task-dock-header">
            <div class="task-header-left">
                <span class="task-dot"></span>
                <span class="task-title">{% bilingual "Backtest Tasks" "å›æµ‹ä»»åŠ¡" %}</span>
            </div>
            <div class="task-header-right">
                <span id="task-count" class="task-count">0</span>
                <button id="task-clear" class="task-toggle task-toggle-muted" aria-label="{% bilingual "Clear tasks" "æ¸…ç©ºä»»åŠ¡" %}">ğŸ—‘</button>
                <button id="task-toggle" class="task-toggle" aria-label="{% bilingual "Toggle tasks" "å±•å¼€/æŠ˜å ä»»åŠ¡" %}"></button>
            </div>
        </div>
        <div id="task-dock-body" class="task-dock-body" hidden></div>
    </div>

    <main class="container-xl pb-5">
        {% block content %}{% endblock %}
    </main>
    <script src="{% static 'trading/js/nav_controls.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/command_palette.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/task_dock.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    {% block extra_scripts %}{% endblock %}
    <footer class="bg-white border-top py-4">
        <div class="container text-center text-muted small">
            {% bilingual "Crafted by Mingyang Dong." "æœ¬å·¥å…·ç”±è‘£é“­ç‘’å¼€å‘ã€‚" %}
        </div>
    </footer>
</body>
</html>
