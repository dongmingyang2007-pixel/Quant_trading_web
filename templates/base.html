{% load static django_bootstrap5 i18n %}
<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE|default:'zh-hans' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{% bilingual "Quant Trading Simulator" "量化交易模拟器" %}{% endblock %}</title>
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link rel="stylesheet" href="{% static 'trading/css/styles.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-light"
      data-task-status-template="{% url 'trading:api_v1_task_status' task_id='TASK_ID_PLACEHOLDER' %}"
      data-task-history-base="{% url 'trading:backtest' %}"
      data-task-cancel-template="{% url 'trading:api_v1_task_cancel' task_id='TASK_ID_PLACEHOLDER' %}">
    <nav class="navbar navbar-expand-lg navbar-dark om-nav shadow-sm mb-4">
        <div class="container-xl">
            <a class="navbar-brand fw-semibold" href="{% url 'trading:backtest' %}">{% bilingual "Quant Trading Simulator" "量化交易模拟器" %}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切换导航">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'backtest' %} active{% endif %}" href="{% url 'trading:backtest' %}">{% bilingual "Strategy Backtest" "策略回测" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'market_insights' %} active{% endif %}" href="{% url 'trading:market_insights' %}">{% bilingual "Market Insights" "股市信息" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'screen_analyzer' %} active{% endif %}" href="{% url 'trading:screen_analyzer' %}">{% bilingual "Screen Analyzer" "屏幕波型" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'paper_trading' %} active{% endif %}" href="{% url 'trading:paper_trading' %}">{% bilingual "Paper Trading" "模拟实盘" %}</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'realtime_monitor' or request.resolver_match.url_name == 'realtime_settings' %} active{% endif %}" href="{% url 'trading:realtime_monitor' %}">{% bilingual "Realtime" "实时引擎" %}</a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'learning_center' %} active{% endif %}" href="{% url 'trading:learning_center' %}">{% bilingual "Learning Hub" "学习中心" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link{% if request.resolver_match.url_name == 'community' %} active{% endif %}" href="{% url 'trading:community' %}">{% bilingual "Community" "社区广场" %}</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link{% if request.resolver_match.url_name == 'account' %} active{% endif %}" href="{% url 'trading:account' %}">{% bilingual "Account" "账户中心" %}</a>
                        </li>
                    {% endif %}
                </ul>
                <div class="nav-actions">
                    <form action="{% url 'set_language' %}" method="post" class="nav-lang-switcher">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <div class="nav-lang-pill" role="group" aria-label="{% bilingual 'Language switch' '语言切换' %}">
                            <button type="submit" name="language" value="zh-hans" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'zh-hans' %} is-active{% endif %}">
                                {% bilingual "中文" "中文" %}
                            </button>
                            <button type="submit" name="language" value="en" class="lang-pill-btn{% if request.LANGUAGE_CODE == 'en' %} is-active{% endif %}">
                                {% bilingual "English" "English" %}
                            </button>
                        </div>
                    </form>
                    {% if user.is_authenticated %}
                        <span class="nav-greeting">{% bilingual "Welcome," "欢迎，" %}{{ user.username }}</span>
                        <div class="nav-user-menu" data-user-menu>
                            <button type="button" class="nav-user-toggle" data-menu-toggle aria-haspopup="true" aria-expanded="false">
                                <span class="nav-user-avatar">{{ user.username|first|upper }}</span>
                                <span class="nav-user-name">{{ user.username }}</span>
                                <span class="nav-user-caret">▾</span>
                            </button>
                            <div class="nav-user-dropdown" data-menu-panel hidden>
                                <a href="{% url 'trading:account' %}">{% bilingual "Account Center" "账户中心" %}</a>
                                <a class="is-danger" href="{% url 'logout' %}">{% bilingual "Sign out" "退出登录" %}</a>
                            </div>
                        </div>
                    {% else %}
                        <a class="btn btn-sm btn-outline-light" href="{% url 'login' %}">{% bilingual "Sign in" "登录" %}</a>
                        <a class="btn btn-sm btn-light" href="{% url 'trading:signup' %}">{% bilingual "Sign up" "注册" %}</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
{% with lang_prefix=request.LANGUAGE_CODE|default:'zh-hans'|lower|slice:":2" %}
    <script id="command-palette-data" type="application/json">
    [
        {
            "id": "backtest",
            "label": "{% if lang_prefix == 'zh' %}{{ "开始回测"|escapejs }}{% else %}{{ "Start Backtest"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "进入旗舰策略实验室"|escapejs }}{% else %}{{ "Open flagship strategy lab"|escapejs }}{% endif %}",
            "shortcut": "B",
            "type": "route",
            "href": "{% url 'trading:backtest' %}"
        },
        {
            "id": "market",
            "label": "{% if lang_prefix == 'zh' %}{{ "股市信息"|escapejs }}{% else %}{{ "Market Insights"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "快速查看涨跌榜"|escapejs }}{% else %}{{ "Watch gainers/decliners dashboard"|escapejs }}{% endif %}",
            "shortcut": "M",
            "type": "route",
            "href": "{% url 'trading:market_insights' %}"
        },
        {% if user.is_authenticated %}
        {
            "id": "realtime",
            "label": "{% if lang_prefix == 'zh' %}{{ "实时引擎"|escapejs }}{% else %}{{ "Realtime Engine"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "查看实时监控与 Focus 列表"|escapejs }}{% else %}{{ "Open realtime monitor & focus list"|escapejs }}{% endif %}",
            "shortcut": "R",
            "type": "route",
            "href": "{% url 'trading:realtime_monitor' %}"
        },
        {% endif %}
        {
            "id": "screen-analyzer",
            "label": "{% if lang_prefix == 'zh' %}{{ "屏幕波型"|escapejs }}{% else %}{{ "Screen Analyzer"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "屏幕解析波型与概率图谱"|escapejs }}{% else %}{{ "Analyze screen wave patterns"|escapejs }}{% endif %}",
            "shortcut": "S",
            "type": "route",
            "href": "{% url 'trading:screen_analyzer' %}"
        },
        {
            "id": "learning",
            "label": "{% if lang_prefix == 'zh' %}{{ "学习中心"|escapejs }}{% else %}{{ "Learning Hub"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "继续学习课程"|escapejs }}{% else %}{{ "Continue structured lessons"|escapejs }}{% endif %}",
            "shortcut": "L",
            "type": "route",
            "href": "{% url 'trading:learning_center' %}"
        },
        {
            "id": "community",
            "label": "{% if lang_prefix == 'zh' %}{{ "社区广场"|escapejs }}{% else %}{{ "Community Hub"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "与社区分享灵感"|escapejs }}{% else %}{{ "Share insights with peers"|escapejs }}{% endif %}",
            "shortcut": "C",
            "type": "route",
            "href": "{% url 'trading:community' %}"
        }{% if user.is_authenticated %},
        {
            "id": "account",
            "label": "{% if lang_prefix == 'zh' %}{{ "账户中心"|escapejs }}{% else %}{{ "Account Center"|escapejs }}{% endif %}",
            "description": "{% if lang_prefix == 'zh' %}{{ "管理资料与历史记录"|escapejs }}{% else %}{{ "Profile, history & exports"|escapejs }}{% endif %}",
            "shortcut": "A",
            "type": "route",
            "href": "{% url 'trading:account' %}"
        }{% endif %}
    ]
    </script>
{% endwith %}
    <div id="command-palette" class="command-palette" aria-hidden="true" hidden>
        <div class="command-palette__backdrop" data-role="palette-dismiss"></div>
        <div class="command-palette__panel" role="dialog" aria-modal="true" aria-labelledby="command-palette-title">
            <header class="command-palette__head">
                <div class="command-palette__title">
                    <span id="command-palette-title">{% bilingual "Command Palette" "命令面板" %}</span>
                </div>
                <div class="command-palette__input-wrap">
                    <input type="text"
                           class="command-palette__input"
                           placeholder="{% bilingual 'Search commands or destinations…' '搜索命令或目标…' %}"
                           autocomplete="off"
                           data-role="palette-input">
                </div>
            </header>
            <div class="command-palette__body">
                <ul class="command-palette__list" data-role="palette-list"></ul>
                <div class="command-palette__empty hidden" data-role="palette-empty">
                    {% bilingual "No matching actions." "没有匹配的操作。" %}
                </div>
            </div>
            <footer class="command-palette__footer">
                <span>{% bilingual "Enter to execute" "回车执行" %}</span>
                <span>{% bilingual "Esc to exit" "Esc 退出" %}</span>
                <span>{% bilingual "↑ ↓ to navigate" "↑ ↓ 选择" %}</span>
            </footer>
        </div>
    </div>
    <button id="task-fab"
            class="task-fab"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#task-center"
            aria-controls="task-center"
            aria-label="{% bilingual 'Backtest tasks' '回测任务' %}"
            hidden>
        <span class="task-fab-icon">TASK</span>
        <span id="task-fab-count" class="task-fab-badge" hidden>0</span>
        <span id="task-fab-spinner" class="task-fab-spinner" hidden></span>
    </button>
    <div class="offcanvas offcanvas-end task-center"
         tabindex="-1"
         id="task-center"
         aria-labelledby="task-center-title">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="task-center-title">{% bilingual "Backtest Tasks" "回测任务" %}</h5>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="task-center-clear">
                    {% bilingual "Clear" "清空" %}
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% bilingual 'Close' '关闭' %}"></button>
            </div>
        </div>
        <div class="offcanvas-body">
            <div id="task-center-body"></div>
        </div>
    </div>
    <div id="task-toast-container"></div>

    <main class="container-xl pb-5">
        {% block content %}{% endblock %}
    </main>
    <script src="{% static 'trading/js/nav_controls.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/command_palette.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    <script src="{% static 'trading/js/task_dock.js' %}?v={{ STATIC_VERSION|default:'1' }}" nonce="{{ csp_nonce }}" defer></script>
    {% block extra_scripts %}{% endblock %}
    <footer class="bg-white border-top py-4">
        <div class="container text-center text-muted small">
            {% bilingual "Crafted by Mingyang Dong." "本工具由董铭瑒开发。" %}
        </div>
    </footer>
</body>
</html>
